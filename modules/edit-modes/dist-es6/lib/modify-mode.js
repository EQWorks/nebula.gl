"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ModifyMode = void 0;

var _nearestPointOnLine = _interopRequireDefault(require("@turf/nearest-point-on-line"));

var _helpers = require("@turf/helpers");

var _utils = require("../utils.js");

var _geojsonEditMode = require("./geojson-edit-mode.js");

var _immutableFeatureCollection = require("./immutable-feature-collection.js");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

class ModifyMode extends _geojsonEditMode.BaseGeoJsonEditMode {
  getEditHandlesAdapter(picks, mapCoords, props) {
    var _this = this;

    var handles = [];
    var features = props.data.features;
    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = props.selectedIndexes[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var _index = _step.value;

        if (_index < features.length) {
          var _handles;

          var geometry = features[_index].geometry;

          (_handles = handles).push.apply(_handles, _toConsumableArray((0, _geojsonEditMode.getEditHandlesForGeometry)(geometry, _index)));
        } else {
          console.warn("selectedFeatureIndexes out of range ".concat(_index)); // eslint-disable-line no-console,no-undef
        }
      } // intermediate edit handle

    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator.return != null) {
          _iterator.return();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    if (picks && picks.length && mapCoords) {
      var existingEditHandle = (0, _geojsonEditMode.getPickedExistingEditHandle)(picks); // don't show intermediate point when too close to an existing edit handle

      var featureAsPick = !existingEditHandle && picks.find(function (pick) {
        return !pick.isGuide;
      }); // is the feature in the pick selected

      if (featureAsPick && !featureAsPick.object.geometry.type.includes('Point') && props.selectedIndexes.includes(featureAsPick.index)) {
        var intermediatePoint = null;
        var positionIndexPrefix = [];
        var referencePoint = (0, _helpers.point)(mapCoords); // process all lines of the (single) feature

        (0, _utils.recursivelyTraverseNestedArrays)(featureAsPick.object.geometry.coordinates, [], function (lineString, prefix) {
          var lineStringFeature = (0, _helpers.lineString)(lineString);

          var candidateIntermediatePoint = _this.nearestPointOnLine(lineStringFeature, referencePoint, props.modeConfig && props.modeConfig.viewport);

          if (!intermediatePoint || candidateIntermediatePoint.properties.dist < intermediatePoint.properties.dist) {
            intermediatePoint = candidateIntermediatePoint;
            positionIndexPrefix = prefix;
          }
        }); // tack on the lone intermediate point to the set of handles

        if (intermediatePoint) {
          var _intermediatePoint = intermediatePoint,
              position = _intermediatePoint.geometry.coordinates,
              index = _intermediatePoint.properties.index;
          handles = _toConsumableArray(handles).concat([{
            position: position,
            positionIndexes: _toConsumableArray(positionIndexPrefix).concat([index + 1]),
            featureIndex: featureAsPick.index,
            type: 'intermediate'
          }]);
        }
      }
    }

    return handles;
  } // turf.js does not support elevation for nearestPointOnLine


  nearestPointOnLine(line, inPoint, viewport) {
    var coordinates = line.geometry.coordinates;

    if (coordinates.some(function (coord) {
      return coord.length > 2;
    })) {
      if (viewport) {
        // This line has elevation, we need to use alternative algorithm
        return (0, _utils.nearestPointOnProjectedLine)(line, inPoint, viewport);
      } // eslint-disable-next-line no-console,no-undef


      console.log('Editing 3D point but modeConfig.viewport not provided. Falling back to 2D logic.');
    }

    return (0, _nearestPointOnLine.default)(line, inPoint);
  }

  handleClickAdapter(event, props) {
    var editAction = null;
    var pickedExistingHandle = (0, _geojsonEditMode.getPickedExistingEditHandle)(event.picks);
    var pickedIntermediateHandle = (0, _geojsonEditMode.getPickedIntermediateEditHandle)(event.picks);

    if (pickedExistingHandle) {
      var updatedData;

      try {
        updatedData = new _immutableFeatureCollection.ImmutableFeatureCollection(props.data).removePosition(pickedExistingHandle.featureIndex, pickedExistingHandle.positionIndexes).getObject();
      } catch (ignored) {// This happens if user attempts to remove the last point
      }

      if (updatedData) {
        editAction = {
          updatedData: updatedData,
          editType: 'removePosition',
          editContext: {
            featureIndexes: [pickedExistingHandle.featureIndex],
            positionIndexes: pickedExistingHandle.positionIndexes,
            position: pickedExistingHandle.position
          }
        };
      }
    } else if (pickedIntermediateHandle) {
      var _updatedData = new _immutableFeatureCollection.ImmutableFeatureCollection(props.data).addPosition(pickedIntermediateHandle.featureIndex, pickedIntermediateHandle.positionIndexes, pickedIntermediateHandle.position).getObject();

      if (_updatedData) {
        editAction = {
          updatedData: _updatedData,
          editType: 'addPosition',
          editContext: {
            featureIndexes: [pickedIntermediateHandle.featureIndex],
            positionIndexes: pickedIntermediateHandle.positionIndexes,
            position: pickedIntermediateHandle.position
          }
        };
      }
    }

    return editAction;
  }

  handlePointerMove(event, props) {
    var editAction = null;
    var editHandle = (0, _geojsonEditMode.getPickedEditHandle)(event.pointerDownPicks);

    if (event.isDragging && editHandle) {
      var updatedData = new _immutableFeatureCollection.ImmutableFeatureCollection(props.data).replacePosition(editHandle.featureIndex, editHandle.positionIndexes, event.mapCoords).getObject();
      editAction = {
        updatedData: updatedData,
        editType: 'movePosition',
        editContext: {
          featureIndexes: [editHandle.featureIndex],
          positionIndexes: editHandle.positionIndexes,
          position: event.mapCoords
        }
      };
      props.onEdit(editAction);
    }

    var cursor = this.getCursor(event);
    props.onUpdateCursor(cursor); // Cancel map panning if pointer went down on an edit handle

    var cancelMapPan = Boolean(editHandle);

    if (cancelMapPan) {
      event.sourceEvent.stopPropagation();
    }
  }

  handleStartDraggingAdapter(event, props) {
    var editAction = null;
    var selectedFeatureIndexes = props.selectedIndexes;
    var editHandle = (0, _geojsonEditMode.getPickedIntermediateEditHandle)(event.picks);

    if (selectedFeatureIndexes.length && editHandle) {
      var updatedData = new _immutableFeatureCollection.ImmutableFeatureCollection(props.data).addPosition(editHandle.featureIndex, editHandle.positionIndexes, event.mapCoords).getObject();
      editAction = {
        updatedData: updatedData,
        editType: 'addPosition',
        editContext: {
          featureIndexes: [editHandle.featureIndex],
          positionIndexes: editHandle.positionIndexes,
          position: event.mapCoords
        }
      };
    }

    return editAction;
  }

  handleStopDraggingAdapter(event, props) {
    var editAction = null;
    var selectedFeatureIndexes = props.selectedIndexes;
    var editHandle = (0, _geojsonEditMode.getPickedEditHandle)(event.picks);

    if (selectedFeatureIndexes.length && editHandle) {
      var updatedData = new _immutableFeatureCollection.ImmutableFeatureCollection(props.data).replacePosition(editHandle.featureIndex, editHandle.positionIndexes, event.mapCoords).getObject();
      editAction = {
        updatedData: updatedData,
        editType: 'finishMovePosition',
        editContext: {
          featureIndexes: [editHandle.featureIndex],
          positionIndexes: editHandle.positionIndexes,
          position: event.mapCoords
        }
      };
    }

    return editAction;
  }

  getCursor(event) {
    var picks = event && event.picks || [];
    var handlesPicked = (0, _geojsonEditMode.getPickedEditHandles)(picks);

    if (handlesPicked.length) {
      return 'cell';
    }

    return null;
  }

}

exports.ModifyMode = ModifyMode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvbW9kaWZ5LW1vZGUuanMiXSwibmFtZXMiOlsiTW9kaWZ5TW9kZSIsIkJhc2VHZW9Kc29uRWRpdE1vZGUiLCJnZXRFZGl0SGFuZGxlc0FkYXB0ZXIiLCJwaWNrcyIsIm1hcENvb3JkcyIsInByb3BzIiwiaGFuZGxlcyIsImZlYXR1cmVzIiwiZGF0YSIsInNlbGVjdGVkSW5kZXhlcyIsImluZGV4IiwibGVuZ3RoIiwiZ2VvbWV0cnkiLCJwdXNoIiwiY29uc29sZSIsIndhcm4iLCJleGlzdGluZ0VkaXRIYW5kbGUiLCJmZWF0dXJlQXNQaWNrIiwiZmluZCIsInBpY2siLCJpc0d1aWRlIiwib2JqZWN0IiwidHlwZSIsImluY2x1ZGVzIiwiaW50ZXJtZWRpYXRlUG9pbnQiLCJwb3NpdGlvbkluZGV4UHJlZml4IiwicmVmZXJlbmNlUG9pbnQiLCJjb29yZGluYXRlcyIsImxpbmVTdHJpbmciLCJwcmVmaXgiLCJsaW5lU3RyaW5nRmVhdHVyZSIsImNhbmRpZGF0ZUludGVybWVkaWF0ZVBvaW50IiwibmVhcmVzdFBvaW50T25MaW5lIiwibW9kZUNvbmZpZyIsInZpZXdwb3J0IiwicHJvcGVydGllcyIsImRpc3QiLCJwb3NpdGlvbiIsInBvc2l0aW9uSW5kZXhlcyIsImZlYXR1cmVJbmRleCIsImxpbmUiLCJpblBvaW50Iiwic29tZSIsImNvb3JkIiwibG9nIiwiaGFuZGxlQ2xpY2tBZGFwdGVyIiwiZXZlbnQiLCJlZGl0QWN0aW9uIiwicGlja2VkRXhpc3RpbmdIYW5kbGUiLCJwaWNrZWRJbnRlcm1lZGlhdGVIYW5kbGUiLCJ1cGRhdGVkRGF0YSIsIkltbXV0YWJsZUZlYXR1cmVDb2xsZWN0aW9uIiwicmVtb3ZlUG9zaXRpb24iLCJnZXRPYmplY3QiLCJpZ25vcmVkIiwiZWRpdFR5cGUiLCJlZGl0Q29udGV4dCIsImZlYXR1cmVJbmRleGVzIiwiYWRkUG9zaXRpb24iLCJoYW5kbGVQb2ludGVyTW92ZSIsImVkaXRIYW5kbGUiLCJwb2ludGVyRG93blBpY2tzIiwiaXNEcmFnZ2luZyIsInJlcGxhY2VQb3NpdGlvbiIsIm9uRWRpdCIsImN1cnNvciIsImdldEN1cnNvciIsIm9uVXBkYXRlQ3Vyc29yIiwiY2FuY2VsTWFwUGFuIiwiQm9vbGVhbiIsInNvdXJjZUV2ZW50Iiwic3RvcFByb3BhZ2F0aW9uIiwiaGFuZGxlU3RhcnREcmFnZ2luZ0FkYXB0ZXIiLCJzZWxlY3RlZEZlYXR1cmVJbmRleGVzIiwiaGFuZGxlU3RvcERyYWdnaW5nQWRhcHRlciIsImhhbmRsZXNQaWNrZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFvQkE7O0FBVUE7Ozs7Ozs7Ozs7OztBQUVPLE1BQU1BLFVBQU4sU0FBeUJDLG9DQUF6QixDQUE2QztBQUNsREMsRUFBQUEscUJBQXFCLENBQ25CQyxLQURtQixFQUVuQkMsU0FGbUIsRUFHbkJDLEtBSG1CLEVBSUw7QUFBQTs7QUFDZCxRQUFJQyxPQUFPLEdBQUcsRUFBZDtBQURjLFFBRU5DLFFBRk0sR0FFT0YsS0FBSyxDQUFDRyxJQUZiLENBRU5ELFFBRk07QUFBQTtBQUFBO0FBQUE7O0FBQUE7QUFJZCwyQkFBb0JGLEtBQUssQ0FBQ0ksZUFBMUIsOEhBQTJDO0FBQUEsWUFBaENDLE1BQWdDOztBQUN6QyxZQUFJQSxNQUFLLEdBQUdILFFBQVEsQ0FBQ0ksTUFBckIsRUFBNkI7QUFBQTs7QUFBQSxjQUNuQkMsUUFEbUIsR0FDTkwsUUFBUSxDQUFDRyxNQUFELENBREYsQ0FDbkJFLFFBRG1COztBQUUzQixzQkFBQU4sT0FBTyxFQUFDTyxJQUFSLG9DQUFnQixnREFBMEJELFFBQTFCLEVBQW9DRixNQUFwQyxDQUFoQjtBQUNELFNBSEQsTUFHTztBQUNMSSxVQUFBQSxPQUFPLENBQUNDLElBQVIsK0NBQW9ETCxNQUFwRCxHQURLLENBQ3lEO0FBQy9EO0FBQ0YsT0FYYSxDQWFkOztBQWJjO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FB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YUFBTyxNQUFQO0FBQ0Q7O0FBQ0QsV0FBTyxJQUFQO0FBQ0Q7O0FBblBpRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCBuZWFyZXN0UG9pbnRPbkxpbmUgZnJvbSAnQHR1cmYvbmVhcmVzdC1wb2ludC1vbi1saW5lJztcbmltcG9ydCB7IHBvaW50LCBsaW5lU3RyaW5nIGFzIHRvTGluZVN0cmluZyB9IGZyb20gJ0B0dXJmL2hlbHBlcnMnO1xuaW1wb3J0IHtcbiAgcmVjdXJzaXZlbHlUcmF2ZXJzZU5lc3RlZEFycmF5cyxcbiAgbmVhcmVzdFBvaW50T25Qcm9qZWN0ZWRMaW5lLFxuICB0eXBlIE5lYXJlc3RQb2ludFR5cGVcbn0gZnJvbSAnLi4vdXRpbHMuanMnO1xuaW1wb3J0IHR5cGUge1xuICBQb3NpdGlvbixcbiAgTGluZVN0cmluZyxcbiAgUG9pbnQsXG4gIEZlYXR1cmVDb2xsZWN0aW9uLFxuICBGZWF0dXJlT2Zcbn0gZnJvbSAnLi4vZ2VvanNvbi10eXBlcy5qcyc7XG5pbXBvcnQgdHlwZSB7XG4gIE1vZGVQcm9wcyxcbiAgQ2xpY2tFdmVudCxcbiAgUG9pbnRlck1vdmVFdmVudCxcbiAgU3RhcnREcmFnZ2luZ0V2ZW50LFxuICBTdG9wRHJhZ2dpbmdFdmVudCxcbiAgVmlld3BvcnRcbn0gZnJvbSAnLi4vdHlwZXMuanMnO1xuaW1wb3J0IHtcbiAgQmFzZUdlb0pzb25FZGl0TW9kZSxcbiAgZ2V0UGlja2VkRWRpdEhhbmRsZSxcbiAgZ2V0UGlja2VkRWRpdEhhbmRsZXMsXG4gIGdldFBpY2tlZEV4aXN0aW5nRWRpdEhhbmRsZSxcbiAgZ2V0UGlja2VkSW50ZXJtZWRpYXRlRWRpdEhhbmRsZSxcbiAgZ2V0RWRpdEhhbmRsZXNGb3JHZW9tZXRyeSxcbiAgdHlwZSBHZW9Kc29uRWRpdEFjdGlvbixcbiAgdHlwZSBFZGl0SGFuZGxlXG59IGZyb20gJy4vZ2VvanNvbi1lZGl0LW1vZGUuanMnO1xuaW1wb3J0IHsgSW1tdXRhYmxlRmVhdHVyZUNvbGxlY3Rpb24gfSBmcm9tICcuL2ltbXV0YWJsZS1mZWF0dXJlLWNvbGxlY3Rpb24uanMnO1xuXG5leHBvcnQgY2xhc3MgTW9kaWZ5TW9kZSBleHRlbmRzIEJhc2VHZW9Kc29uRWRpdE1vZGUge1xuICBnZXRFZGl0SGFuZGxlc0FkYXB0ZXIoXG4gICAgcGlja3M6ID9BcnJheTxPYmplY3Q+LFxuICAgIG1hcENvb3JkczogP1Bvc2l0aW9uLFxuICAgIHByb3BzOiBNb2RlUHJvcHM8RmVhdHVyZUNvbGxlY3Rpb24+XG4gICk6IEVkaXRIYW5kbGVbXSB7XG4gICAgbGV0IGhhbmRsZXMgPSBbXTtcbiAgICBjb25zdCB7IGZlYXR1cmVzIH0gPSBwcm9wcy5kYXRhO1xuXG4gICAgZm9yIChjb25zdCBpbmRleCBvZiBwcm9wcy5zZWxlY3RlZEluZGV4ZXMpIHtcbiAgICAgIGlmIChpbmRleCA8IGZlYXR1cmVzLmxlbmd0aCkge1xuICAgICAgICBjb25zdCB7IGdlb21ldHJ5IH0gPSBmZWF0dXJlc1tpbmRleF07XG4gICAgICAgIGhhbmRsZXMucHVzaCguLi5nZXRFZGl0SGFuZGxlc0Zvckdlb21ldHJ5KGdlb21ldHJ5LCBpbmRleCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS53YXJuKGBzZWxlY3RlZEZlYXR1cmVJbmRleGVzIG91dCBvZiByYW5nZSAke2luZGV4fWApOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnNvbGUsbm8tdW5kZWZcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBpbnRlcm1lZGlhdGUgZWRpdCBoYW5kbGVcbiAgICBpZiAocGlja3MgJiYgcGlja3MubGVuZ3RoICYmIG1hcENvb3Jkcykge1xuICAgICAgY29uc3QgZXhpc3RpbmdFZGl0SGFuZGxlID0gZ2V0UGlja2VkRXhpc3RpbmdFZGl0SGFuZGxlKHBpY2tzKTtcbiAgICAgIC8vIGRvbid0IHNob3cgaW50ZXJtZWRpYXRlIHBvaW50IHdoZW4gdG9vIGNsb3NlIHRvIGFuIGV4aXN0aW5nIGVkaXQgaGFuZGxlXG4gICAgICBjb25zdCBmZWF0dXJlQXNQaWNrID0gIWV4aXN0aW5nRWRpdEhhbmRsZSAmJiBwaWNrcy5maW5kKHBpY2sgPT4gIXBpY2suaXNHdWlkZSk7XG5cbiAgICAgIC8vIGlzIHRoZSBmZWF0dXJlIGluIHRoZSBwaWNrIHNlbGVjdGVkXG4gICAgICBpZiAoXG4gICAgICAgIGZlYXR1cmVBc1BpY2sgJiZcbiAgICAgICAgIWZlYXR1cmVBc1BpY2sub2JqZWN0Lmdlb21ldHJ5LnR5cGUuaW5jbHVkZXMoJ1BvaW50JykgJiZcbiAgICAgICAgcHJvcHMuc2VsZWN0ZWRJbmRleGVzLmluY2x1ZGVzKGZlYXR1cmVBc1BpY2suaW5kZXgpXG4gICAgICApIHtcbiAgICAgICAgbGV0IGludGVybWVkaWF0ZVBvaW50OiA/TmVhcmVzdFBvaW50VHlwZSA9IG51bGw7XG4gICAgICAgIGxldCBwb3NpdGlvbkluZGV4UHJlZml4ID0gW107XG4gICAgICAgIGNvbnN0IHJlZmVyZW5jZVBvaW50ID0gcG9pbnQobWFwQ29vcmRzKTtcbiAgICAgICAgLy8gcHJvY2VzcyBhbGwgbGluZXMgb2YgdGhlIChzaW5nbGUpIGZlYXR1cmVcbiAgICAgICAgcmVjdXJzaXZlbHlUcmF2ZXJzZU5lc3RlZEFycmF5cyhcbiAgICAgICAgICBmZWF0dXJlQXNQaWNrLm9iamVjdC5nZW9tZXRyeS5jb29yZGluYXRlcyxcbiAgICAgICAgICBbXSxcbiAgICAgICAgICAobGluZVN0cmluZywgcHJlZml4KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBsaW5lU3RyaW5nRmVhdHVyZSA9IHRvTGluZVN0cmluZyhsaW5lU3RyaW5nKTtcbiAgICAgICAgICAgIGNvbnN0IGNhbmRpZGF0ZUludGVybWVkaWF0ZVBvaW50ID0gdGhpcy5uZWFyZXN0UG9pbnRPbkxpbmUoXG4gICAgICAgICAgICAgIGxpbmVTdHJpbmdGZWF0dXJlLFxuICAgICAgICAgICAgICByZWZlcmVuY2VQb2ludCxcbiAgICAgICAgICAgICAgcHJvcHMubW9kZUNvbmZpZyAmJiBwcm9wcy5tb2RlQ29uZmlnLnZpZXdwb3J0XG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAhaW50ZXJtZWRpYXRlUG9pbnQgfHxcbiAgICAgICAgICAgICAgY2FuZGlkYXRlSW50ZXJtZWRpYXRlUG9pbnQucHJvcGVydGllcy5kaXN0IDwgaW50ZXJtZWRpYXRlUG9pbnQucHJvcGVydGllcy5kaXN0XG4gICAgICAgICAgICApIHtcbiAgICAgICAgICAgICAgaW50ZXJtZWRpYXRlUG9pbnQgPSBjYW5kaWRhdGVJbnRlcm1lZGlhdGVQb2ludDtcbiAgICAgICAgICAgICAgcG9zaXRpb25JbmRleFByZWZpeCA9IHByZWZpeDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICAgIC8vIHRhY2sgb24gdGhlIGxvbmUgaW50ZXJtZWRpYXRlIHBvaW50IHRvIHRoZSBzZXQgb2YgaGFuZGxlc1xuICAgICAgICBpZiAoaW50ZXJtZWRpYXRlUG9pbnQpIHtcbiAgICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBnZW9tZXRyeTogeyBjb29yZGluYXRlczogcG9zaXRpb24gfSxcbiAgICAgICAgICAgIHByb3BlcnRpZXM6IHsgaW5kZXggfVxuICAgICAgICAgIH0gPSBpbnRlcm1lZGlhdGVQb2ludDtcbiAgICAgICAgICBoYW5kbGVzID0gW1xuICAgICAgICAgICAgLi4uaGFuZGxlcyxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgcG9zaXRpb24sXG4gICAgICAgICAgICAgIHBvc2l0aW9uSW5kZXhlczogWy4uLnBvc2l0aW9uSW5kZXhQcmVmaXgsIGluZGV4ICsgMV0sXG4gICAgICAgICAgICAgIGZlYXR1cmVJbmRleDogZmVhdHVyZUFzUGljay5pbmRleCxcbiAgICAgICAgICAgICAgdHlwZTogJ2ludGVybWVkaWF0ZSdcbiAgICAgICAgICAgIH1cbiAgICAgICAgICBdO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGhhbmRsZXM7XG4gIH1cblxuICAvLyB0dXJmLmpzIGRvZXMgbm90IHN1cHBvcnQgZWxldmF0aW9uIGZvciBuZWFyZXN0UG9pbnRPbkxpbmVcbiAgbmVhcmVzdFBvaW50T25MaW5lKFxuICAgIGxpbmU6IEZlYXR1cmVPZjxMaW5lU3RyaW5nPixcbiAgICBpblBvaW50OiBGZWF0dXJlT2Y8UG9pbnQ+LFxuICAgIHZpZXdwb3J0OiA/Vmlld3BvcnRcbiAgKTogTmVhcmVzdFBvaW50VHlwZSB7XG4gICAgY29uc3QgeyBjb29yZGluYXRlcyB9ID0gbGluZS5nZW9tZXRyeTtcbiAgICBpZiAoY29vcmRpbmF0ZXMuc29tZShjb29yZCA9PiBjb29yZC5sZW5ndGggPiAyKSkge1xuICAgICAgaWYgKHZpZXdwb3J0KSB7XG4gICAgICAgIC8vIFRoaXMgbGluZSBoYXMgZWxldmF0aW9uLCB3ZSBuZWVkIHRvIHVzZSBhbHRlcm5hdGl2ZSBhbGdvcml0aG1cbiAgICAgICAgcmV0dXJuIG5lYXJlc3RQb2ludE9uUHJvamVjdGVkTGluZShsaW5lLCBpblBvaW50LCB2aWV3cG9ydCk7XG4gICAgICB9XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZSxuby11bmRlZlxuICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICdFZGl0aW5nIDNEIHBvaW50IGJ1dCBtb2RlQ29uZmlnLnZpZXdwb3J0IG5vdCBwcm92aWRlZC4gRmFsbGluZyBiYWNrIHRvIDJEIGxvZ2ljLidcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5lYXJlc3RQb2ludE9uTGluZShsaW5lLCBpblBvaW50KTtcbiAgfVxuXG4gIGhhbmRsZUNsaWNrQWRhcHRlcihldmVudDogQ2xpY2tFdmVudCwgcHJvcHM6IE1vZGVQcm9wczxGZWF0dXJlQ29sbGVjdGlvbj4pOiA/R2VvSnNvbkVkaXRBY3Rpb24ge1xuICAgIGxldCBlZGl0QWN0aW9uOiA/R2VvSnNvbkVkaXRBY3Rpb24gPSBudWxsO1xuXG4gICAgY29uc3QgcGlja2VkRXhpc3RpbmdIYW5kbGUgPSBnZXRQaWNrZWRFeGlzdGluZ0VkaXRIYW5kbGUoZXZlbnQucGlja3MpO1xuICAgIGNvbnN0IHBpY2tlZEludGVybWVkaWF0ZUhhbmRsZSA9IGdldFBpY2tlZEludGVybWVkaWF0ZUVkaXRIYW5kbGUoZXZlbnQucGlja3MpO1xuXG4gICAgaWYgKHBpY2tlZEV4aXN0aW5nSGFuZGxlKSB7XG4gICAgICBsZXQgdXBkYXRlZERhdGE7XG4gICAgICB0cnkge1xuICAgICAgICB1cGRhdGVkRGF0YSA9IG5ldyBJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbihwcm9wcy5kYXRhKVxuICAgICAgICAgIC5yZW1vdmVQb3NpdGlvbihwaWNrZWRFeGlzdGluZ0hhbmRsZS5mZWF0dXJlSW5kZXgsIHBpY2tlZEV4aXN0aW5nSGFuZGxlLnBvc2l0aW9uSW5kZXhlcylcbiAgICAgICAgICAuZ2V0T2JqZWN0KCk7XG4gICAgICB9IGNhdGNoIChpZ25vcmVkKSB7XG4gICAgICAgIC8vIFRoaXMgaGFwcGVucyBpZiB1c2VyIGF0dGVtcHRzIHRvIHJlbW92ZSB0aGUgbGFzdCBwb2ludFxuICAgICAgfVxuXG4gICAgICBpZiAodXBkYXRlZERhdGEpIHtcbiAgICAgICAgZWRpdEFjdGlvbiA9IHtcbiAgICAgICAgICB1cGRhdGVkRGF0YSxcbiAgICAgICAgICBlZGl0VHlwZTogJ3JlbW92ZVBvc2l0aW9uJyxcbiAgICAgICAgICBlZGl0Q29udGV4dDoge1xuICAgICAgICAgICAgZmVhdHVyZUluZGV4ZXM6IFtwaWNrZWRFeGlzdGluZ0hhbmRsZS5mZWF0dXJlSW5kZXhdLFxuICAgICAgICAgICAgcG9zaXRpb25JbmRleGVzOiBwaWNrZWRFeGlzdGluZ0hhbmRsZS5wb3NpdGlvbkluZGV4ZXMsXG4gICAgICAgICAgICBwb3NpdGlvbjogcGlja2VkRXhpc3RpbmdIYW5kbGUucG9zaXRpb25cbiAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChwaWNrZWRJbnRlcm1lZGlhdGVIYW5kbGUpIHtcbiAgICAgIGNvbnN0IHVwZGF0ZWREYXRhID0gbmV3IEltbXV0YWJsZUZlYXR1cmVDb2xsZWN0aW9uKHByb3BzLmRhdGEpXG4gICAgICAgIC5hZGRQb3NpdGlvbihcbiAgICAgICAgICBwaWNrZWRJbnRlcm1lZGlhdGVIYW5kbGUuZmVhdHVyZUluZGV4LFxuICAgICAgICAgIHBpY2tlZEludGVybWVkaWF0ZUhhbmRsZS5wb3NpdGlvbkluZGV4ZXMsXG4gICAgICAgICAgcGlja2VkSW50ZXJtZWRpYXRlSGFuZGxlLnBvc2l0aW9uXG4gICAgICAgIClcbiAgICAgICAgLmdldE9iamVjdCgpO1xuXG4gICAgICBpZiAodXBkYXRlZERhdGEpIHtcbiAgICAgICAgZWRpdEFjdGlvbiA9IHtcbiAgICAgICAgICB1cGRhdGVkRGF0YSxcbiAgICAgICAgICBlZGl0VHlwZTogJ2FkZFBvc2l0aW9uJyxcbiAgICAgICAgICBlZGl0Q29udGV4dDoge1xuICAgICAgICAgICAgZmVhdHVyZUluZGV4ZXM6IFtwaWNrZWRJbnRlcm1lZGlhdGVIYW5kbGUuZmVhdHVyZUluZGV4XSxcbiAgICAgICAgICAgIHBvc2l0aW9uSW5kZXhlczogcGlja2VkSW50ZXJtZWRpYXRlSGFuZGxlLnBvc2l0aW9uSW5kZXhlcyxcbiAgICAgICAgICAgIHBvc2l0aW9uOiBwaWNrZWRJbnRlcm1lZGlhdGVIYW5kbGUucG9zaXRpb25cbiAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBlZGl0QWN0aW9uO1xuICB9XG5cbiAgaGFuZGxlUG9pbnRlck1vdmUoZXZlbnQ6IFBvaW50ZXJNb3ZlRXZlbnQsIHByb3BzOiBNb2RlUHJvcHM8RmVhdHVyZUNvbGxlY3Rpb24+KTogdm9pZCB7XG4gICAgbGV0IGVkaXRBY3Rpb246ID9HZW9Kc29uRWRpdEFjdGlvbiA9IG51bGw7XG5cbiAgICBjb25zdCBlZGl0SGFuZGxlID0gZ2V0UGlja2VkRWRpdEhhbmRsZShldmVudC5wb2ludGVyRG93blBpY2tzKTtcblxuICAgIGlmIChldmVudC5pc0RyYWdnaW5nICYmIGVkaXRIYW5kbGUpIHtcbiAgICAgIGNvbnN0IHVwZGF0ZWREYXRhID0gbmV3IEltbXV0YWJsZUZlYXR1cmVDb2xsZWN0aW9uKHByb3BzLmRhdGEpXG4gICAgICAgIC5yZXBsYWNlUG9zaXRpb24oZWRpdEhhbmRsZS5mZWF0dXJlSW5kZXgsIGVkaXRIYW5kbGUucG9zaXRpb25JbmRleGVzLCBldmVudC5tYXBDb29yZHMpXG4gICAgICAgIC5nZXRPYmplY3QoKTtcblxuICAgICAgZWRpdEFjdGlvbiA9IHtcbiAgICAgICAgdXBkYXRlZERhdGEsXG4gICAgICAgIGVkaXRUeXBlOiAnbW92ZVBvc2l0aW9uJyxcbiAgICAgICAgZWRpdENvbnRleHQ6IHtcbiAgICAgICAgICBmZWF0dXJlSW5kZXhlczogW2VkaXRIYW5kbGUuZmVhdHVyZUluZGV4XSxcbiAgICAgICAgICBwb3NpdGlvbkluZGV4ZXM6IGVkaXRIYW5kbGUucG9zaXRpb25JbmRleGVzLFxuICAgICAgICAgIHBvc2l0aW9uOiBldmVudC5tYXBDb29yZHNcbiAgICAgICAgfVxuICAgICAgfTtcblxuICAgICAgcHJvcHMub25FZGl0KGVkaXRBY3Rpb24pO1xuICAgIH1cblxuICAgIGNvbnN0IGN1cnNvciA9IHRoaXMuZ2V0Q3Vyc29yKGV2ZW50KTtcbiAgICBwcm9wcy5vblVwZGF0ZUN1cnNvcihjdXJzb3IpO1xuXG4gICAgLy8gQ2FuY2VsIG1hcCBwYW5uaW5nIGlmIHBvaW50ZXIgd2VudCBkb3duIG9uIGFuIGVkaXQgaGFuZGxlXG4gICAgY29uc3QgY2FuY2VsTWFwUGFuID0gQm9vbGVhbihlZGl0SGFuZGxlKTtcbiAgICBpZiAoY2FuY2VsTWFwUGFuKSB7XG4gICAgICBldmVudC5zb3VyY2VFdmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB9XG4gIH1cblxuICBoYW5kbGVTdGFydERyYWdnaW5nQWRhcHRlcihcbiAgICBldmVudDogU3RhcnREcmFnZ2luZ0V2ZW50LFxuICAgIHByb3BzOiBNb2RlUHJvcHM8RmVhdHVyZUNvbGxlY3Rpb24+XG4gICk6ID9HZW9Kc29uRWRpdEFjdGlvbiB7XG4gICAgbGV0IGVkaXRBY3Rpb246ID9HZW9Kc29uRWRpdEFjdGlvbiA9IG51bGw7XG5cbiAgICBjb25zdCBzZWxlY3RlZEZlYXR1cmVJbmRleGVzID0gcHJvcHMuc2VsZWN0ZWRJbmRleGVzO1xuXG4gICAgY29uc3QgZWRpdEhhbmRsZSA9IGdldFBpY2tlZEludGVybWVkaWF0ZUVkaXRIYW5kbGUoZXZlbnQucGlja3MpO1xuICAgIGlmIChzZWxlY3RlZEZlYXR1cmVJbmRleGVzLmxlbmd0aCAmJiBlZGl0SGFuZGxlKSB7XG4gICAgICBjb25zdCB1cGRhdGVkRGF0YSA9IG5ldyBJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbihwcm9wcy5kYXRhKVxuICAgICAgICAuYWRkUG9zaXRpb24oZWRpdEhhbmRsZS5mZWF0dXJlSW5kZXgsIGVkaXRIYW5kbGUucG9zaXRpb25JbmRleGVzLCBldmVudC5tYXBDb29yZHMpXG4gICAgICAgIC5nZXRPYmplY3QoKTtcblxuICAgICAgZWRpdEFjdGlvbiA9IHtcbiAgICAgICAgdXBkYXRlZERhdGEsXG4gICAgICAgIGVkaXRUeXBlOiAnYWRkUG9zaXRpb24nLFxuICAgICAgICBlZGl0Q29udGV4dDoge1xuICAgICAgICAgIGZlYXR1cmVJbmRleGVzOiBbZWRpdEhhbmRsZS5mZWF0dXJlSW5kZXhdLFxuICAgICAgICAgIHBvc2l0aW9uSW5kZXhlczogZWRpdEhhbmRsZS5wb3NpdGlvbkluZGV4ZXMsXG4gICAgICAgICAgcG9zaXRpb246IGV2ZW50Lm1hcENvb3Jkc1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiBlZGl0QWN0aW9uO1xuICB9XG5cbiAgaGFuZGxlU3RvcERyYWdnaW5nQWRhcHRlcihcbiAgICBldmVudDogU3RvcERyYWdnaW5nRXZlbnQsXG4gICAgcHJvcHM6IE1vZGVQcm9wczxGZWF0dXJlQ29sbGVjdGlvbj5cbiAgKTogP0dlb0pzb25FZGl0QWN0aW9uIHtcbiAgICBsZXQgZWRpdEFjdGlvbjogP0dlb0pzb25FZGl0QWN0aW9uID0gbnVsbDtcblxuICAgIGNvbnN0IHNlbGVjdGVkRmVhdHVyZUluZGV4ZXMgPSBwcm9wcy5zZWxlY3RlZEluZGV4ZXM7XG4gICAgY29uc3QgZWRpdEhhbmRsZSA9IGdldFBpY2tlZEVkaXRIYW5kbGUoZXZlbnQucGlja3MpO1xuICAgIGlmIChzZWxlY3RlZEZlYXR1cmVJbmRleGVzLmxlbmd0aCAmJiBlZGl0SGFuZGxlKSB7XG4gICAgICBjb25zdCB1cGRhdGVkRGF0YSA9IG5ldyBJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbihwcm9wcy5kYXRhKVxuICAgICAgICAucmVwbGFjZVBvc2l0aW9uKGVkaXRIYW5kbGUuZmVhdHVyZUluZGV4LCBlZGl0SGFuZGxlLnBvc2l0aW9uSW5kZXhlcywgZXZlbnQubWFwQ29vcmRzKVxuICAgICAgICAuZ2V0T2JqZWN0KCk7XG5cbiAgICAgIGVkaXRBY3Rpb24gPSB7XG4gICAgICAgIHVwZGF0ZWREYXRhLFxuICAgICAgICBlZGl0VHlwZTogJ2ZpbmlzaE1vdmVQb3NpdGlvbicsXG4gICAgICAgIGVkaXRDb250ZXh0OiB7XG4gICAgICAgICAgZmVhdHVyZUluZGV4ZXM6IFtlZGl0SGFuZGxlLmZlYXR1cmVJbmRleF0sXG4gICAgICAgICAgcG9zaXRpb25JbmRleGVzOiBlZGl0SGFuZGxlLnBvc2l0aW9uSW5kZXhlcyxcbiAgICAgICAgICBwb3NpdGlvbjogZXZlbnQubWFwQ29vcmRzXG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIGVkaXRBY3Rpb247XG4gIH1cblxuICBnZXRDdXJzb3IoZXZlbnQ6IFBvaW50ZXJNb3ZlRXZlbnQpOiA/c3RyaW5nIHtcbiAgICBjb25zdCBwaWNrcyA9IChldmVudCAmJiBldmVudC5waWNrcykgfHwgW107XG5cbiAgICBjb25zdCBoYW5kbGVzUGlja2VkID0gZ2V0UGlja2VkRWRpdEhhbmRsZXMocGlja3MpO1xuICAgIGlmIChoYW5kbGVzUGlja2VkLmxlbmd0aCkge1xuICAgICAgcmV0dXJuICdjZWxsJztcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cbiJdfQ==