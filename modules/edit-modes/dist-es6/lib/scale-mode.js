"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ScaleMode = void 0;

var _centroid = _interopRequireDefault(require("@turf/centroid"));

var _distance = _interopRequireDefault(require("@turf/distance"));

var _transformScale = _interopRequireDefault(require("@turf/transform-scale"));

var _geojsonEditMode = require("./geojson-edit-mode.js");

var _immutableFeatureCollection = require("./immutable-feature-collection.js");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class ScaleMode extends _geojsonEditMode.BaseGeoJsonEditMode {
  constructor() {
    super(...arguments);

    _defineProperty(this, "_isScalable", void 0);

    _defineProperty(this, "_geometryBeingScaled", void 0);
  }

  handlePointerMoveAdapter(event, props) {
    var editAction = null;
    this._isScalable = Boolean(this._geometryBeingScaled) || this.isSelectionPicked(event.picks, props);

    if (!this._isScalable || !event.pointerDownMapCoords) {
      // Nothing to do
      return {
        editAction: null,
        cancelMapPan: false
      };
    }

    if (event.isDragging && this._geometryBeingScaled) {
      // Scale the geometry
      editAction = this.getScaleAction(event.pointerDownMapCoords, event.mapCoords, 'scaling', props);
    }

    return {
      editAction: editAction,
      cancelMapPan: true
    };
  }

  handleStartDraggingAdapter(event, props) {
    if (!this._isScalable) {
      return null;
    }

    this._geometryBeingScaled = this.getSelectedFeaturesAsFeatureCollection(props);
    return null;
  }

  handleStopDraggingAdapter(event, props) {
    var editAction = null;

    if (this._geometryBeingScaled) {
      // Scale the geometry
      editAction = this.getScaleAction(event.pointerDownMapCoords, event.mapCoords, 'scaled', props);
      this._geometryBeingScaled = null;
    }

    return editAction;
  }

  getCursorAdapter() {
    if (this._isScalable) {
      // TODO: look at doing SVG cursors to get a better "scale" cursor
      return 'move';
    }

    return null;
  }

  getScaleAction(startDragPoint, currentPoint, editType, props) {
    var startPosition = startDragPoint;
    var centroid = (0, _centroid.default)(this._geometryBeingScaled);
    var factor = getScaleFactor(centroid, startPosition, currentPoint);
    var scaledFeatures = (0, _transformScale.default)(this._geometryBeingScaled, factor, {
      origin: centroid
    });
    var updatedData = new _immutableFeatureCollection.ImmutableFeatureCollection(props.data);
    var selectedIndexes = props.selectedIndexes;

    for (var i = 0; i < selectedIndexes.length; i++) {
      var selectedIndex = selectedIndexes[i];
      var movedFeature = scaledFeatures.features[i];
      updatedData = updatedData.replaceGeometry(selectedIndex, movedFeature.geometry);
    }

    return {
      updatedData: updatedData.getObject(),
      editType: editType,
      editContext: {
        featureIndexes: selectedIndexes
      }
    };
  }

}

exports.ScaleMode = ScaleMode;

function getScaleFactor(centroid, startDragPoint, currentPoint) {
  var startDistance = (0, _distance.default)(centroid, startDragPoint);
  var endDistance = (0, _distance.default)(centroid, currentPoint);
  return endDistance / startDistance;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvc2NhbGUtbW9kZS5qcyJdLCJuYW1lcyI6WyJTY2FsZU1vZGUiLCJCYXNlR2VvSnNvbkVkaXRNb2RlIiwiaGFuZGxlUG9pbnRlck1vdmVBZGFwdGVyIiwiZXZlbnQiLCJwcm9wcyIsImVkaXRBY3Rpb24iLCJfaXNTY2FsYWJsZSIsIkJvb2xlYW4iLCJfZ2VvbWV0cnlCZWluZ1NjYWxlZCIsImlzU2VsZWN0aW9uUGlja2VkIiwicGlja3MiLCJwb2ludGVyRG93bk1hcENvb3JkcyIsImNhbmNlbE1hcFBhbiIsImlzRHJhZ2dpbmciLCJnZXRTY2FsZUFjdGlvbiIsIm1hcENvb3JkcyIsImhhbmRsZVN0YXJ0RHJhZ2dpbmdBZGFwdGVyIiwiZ2V0U2VsZWN0ZWRGZWF0dXJlc0FzRmVhdHVyZUNvbGxlY3Rpb24iLCJoYW5kbGVTdG9wRHJhZ2dpbmdBZGFwdGVyIiwiZ2V0Q3Vyc29yQWRhcHRlciIsInN0YXJ0RHJhZ1BvaW50IiwiY3VycmVudFBvaW50IiwiZWRpdFR5cGUiLCJzdGFydFBvc2l0aW9uIiwiY2VudHJvaWQiLCJmYWN0b3IiLCJnZXRTY2FsZUZhY3RvciIsInNjYWxlZEZlYXR1cmVzIiwib3JpZ2luIiwidXBkYXRlZERhdGEiLCJJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbiIsImRhdGEiLCJzZWxlY3RlZEluZGV4ZXMiLCJpIiwibGVuZ3RoIiwic2VsZWN0ZWRJbmRleCIsIm1vdmVkRmVhdHVyZSIsImZlYXR1cmVzIiwicmVwbGFjZUdlb21ldHJ5IiwiZ2VvbWV0cnkiLCJnZXRPYmplY3QiLCJlZGl0Q29udGV4dCIsImZlYXR1cmVJbmRleGVzIiwic3RhcnREaXN0YW5jZSIsImVuZERpc3RhbmNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBUUE7O0FBQ0E7Ozs7OztBQUVPLE1BQU1BLFNBQU4sU0FBd0JDLG9DQUF4QixDQUE0QztBQUFBO0FBQUE7O0FBQUE7O0FBQUE7QUFBQTs7QUFJakRDLEVBQUFBLHdCQUF3QixDQUN0QkMsS0FEc0IsRUFFdEJDLEtBRnNCLEVBR3FDO0FBQzNELFFBQUlDLFVBQThCLEdBQUcsSUFBckM7QUFFQSxTQUFLQyxXQUFMLEdBQ0VDLE9BQU8sQ0FBQyxLQUFLQyxvQkFBTixDQUFQLElBQXNDLEtBQUtDLGlCQUFMLENBQXVCTixLQUFLLENBQUNPLEtBQTdCLEVBQW9DTixLQUFwQyxDQUR4Qzs7QUFHQSxRQUFJLENBQUMsS0FBS0UsV0FBTixJQUFxQixDQUFDSCxLQUFLLENBQUNRLG9CQUFoQyxFQUFzRDtBQUNwRDtBQUNBLGFBQU87QUFBRU4sUUFBQUEsVUFBVSxFQUFFLElBQWQ7QUFBb0JPLFFBQUFBLFlBQVksRUFBRTtBQUFsQyxPQUFQO0FBQ0Q7O0FBRUQsUUFBSVQsS0FBSyxDQUFDVSxVQUFOLElBQW9CLEtBQUtMLG9CQUE3QixFQUFtRDtBQUNqRDtBQUNBSCxNQUFBQSxVQUFVLEdBQUcsS0FBS1MsY0FBTCxDQUNYWCxLQUFLLENBQUNRLG9CQURLLEVBRVhSLEtBQUssQ0FBQ1ksU0FGSyxFQUdYLFNBSFcsRUFJWFgsS0FKVyxDQUFiO0FBTUQ7O0FBRUQsV0FBTztBQUFFQyxNQUFBQSxVQUFVLEVBQVZBLFVBQUY7QUFBY08sTUFBQUEsWUFBWSxFQUFFO0FBQTVCLEtBQVA7QUFDRDs7QUFFREksRUFBQUEsMEJBQTBCLENBQ3hCYixLQUR3QixFQUV4QkMsS0FGd0IsRUFHSjtBQUNwQixRQUFJLENBQUMsS0FBS0UsV0FBVixFQUF1QjtBQUNyQixhQUFPLElBQVA7QUFDRDs7QUFFRCxTQUFLRSxvQkFBTCxHQUE0QixLQUFLUyxzQ0FBTCxDQUE0Q2IsS0FBNUMsQ0FBNUI7QUFDQSxXQUFPLElBQVA7QUFDRDs7QUFFRGMsRUFBQUEseUJBQXlCLENBQ3ZCZixLQUR1QixFQUV2QkMsS0FGdUIsRUFHSDtBQUNwQixRQUFJQyxVQUE4QixHQUFHLElBQXJDOztBQUVBLFFBQUksS0FBS0csb0JBQVQsRUFBK0I7QUFDN0I7QUFDQUgsTUFBQUEsVUFBVSxHQUFHLEtBQUtTLGNBQUwsQ0FDWFgsS0FBSyxDQUFDUSxvQkFESyxFQUVYUixLQUFLLENBQUNZLFNBRkssRUFHWCxRQUhXLEVBSVhYLEtBSlcsQ0FBYjtBQU1BLFdBQUtJLG9CQUFMLEdBQTRCLElBQTVCO0FBQ0Q7O0FBRUQsV0FBT0gsVUFBUDtBQUNEOztBQUVEYyxFQUFBQSxnQkFBZ0IsR0FBWTtBQUMxQixRQUFJLEtBQUtiLFdBQVQsRUFBc0I7QUFDcEI7QUFDQSxhQUFPLE1BQVA7QUFDRDs7QUFDRCxXQUFPLElBQVA7QUFDRDs7QUFFRFEsRUFBQUEsY0FBYyxDQUNaTSxjQURZLEVBRVpDLFlBRlksRUFHWkMsUUFIWSxFQUlabEIsS0FKWSxFQUtPO0FBQ25CLFFBQU1tQixhQUFhLEdBQUdILGNBQXRCO0FBQ0EsUUFBTUksUUFBUSxHQUFHLHVCQUFhLEtBQUtoQixvQkFBbEIsQ0FBakI7QUFDQSxRQUFNaUIsTUFBTSxHQUFHQyxjQUFjLENBQUNGLFFBQUQsRUFBV0QsYUFBWCxFQUEwQkYsWUFBMUIsQ0FBN0I7QUFDQSxRQUFNTSxjQUFjLEdBQUcsNkJBQW1CLEtBQUtuQixvQkFBeEIsRUFBOENpQixNQUE5QyxFQUFzRDtBQUMzRUcsTUFBQUEsTUFBTSxFQUFFSjtBQURtRSxLQUF0RCxDQUF2QjtBQUlBLFFBQUlLLFdBQVcsR0FBRyxJQUFJQyxzREFBSixDQUErQjFCLEtBQUssQ0FBQzJCLElBQXJDLENBQWxCO0FBRUEsUUFBTUMsZUFBZSxHQUFHNUIsS0FBSyxDQUFDNEIsZUFBOUI7O0FBQ0EsU0FBSyxJQUFJQyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHRCxlQUFlLENBQUNFLE1BQXBDLEVBQTRDRCxDQUFDLEVBQTdDLEVBQWlEO0FBQy9DLFVBQU1FLGFBQWEsR0FBR0gsZUFBZSxDQUFDQyxDQUFELENBQXJDO0FBQ0EsVUFBTUcsWUFBWSxHQUFHVCxjQUFjLENBQUNVLFFBQWYsQ0FBd0JKLENBQXhCLENBQXJCO0FBQ0FKLE1BQUFBLFdBQVcsR0FBR0EsV0FBVyxDQUFDUyxlQUFaLENBQTRCSCxhQUE1QixFQUEyQ0MsWUFBWSxDQUFDRyxRQUF4RCxDQUFkO0FBQ0Q7O0FBRUQsV0FBTztBQUNMVixNQUFBQSxXQUFXLEVBQUVBLFdBQVcsQ0FBQ1csU0FBWixFQURSO0FBRUxsQixNQUFBQSxRQUFRLEVBQVJBLFFBRks7QUFHTG1CLE1BQUFBLFdBQVcsRUFBRTtBQUNYQyxRQUFBQSxjQUFjLEVBQUVWO0FBREw7QUFIUixLQUFQO0FBT0Q7O0FBcEdnRDs7OztBQXVHbkQsU0FBU04sY0FBVCxDQUF3QkYsUUFBeEIsRUFBNENKLGNBQTVDLEVBQXNFQyxZQUF0RSxFQUE4RjtBQUM1RixNQUFNc0IsYUFBYSxHQUFHLHVCQUFhbkIsUUFBYixFQUF1QkosY0FBdkIsQ0FBdEI7QUFDQSxNQUFNd0IsV0FBVyxHQUFHLHVCQUFhcEIsUUFBYixFQUF1QkgsWUFBdkIsQ0FBcEI7QUFDQSxTQUFPdUIsV0FBVyxHQUFHRCxhQUFyQjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHR1cmZDZW50cm9pZCBmcm9tICdAdHVyZi9jZW50cm9pZCc7XG5pbXBvcnQgdHVyZkRpc3RhbmNlIGZyb20gJ0B0dXJmL2Rpc3RhbmNlJztcbmltcG9ydCB0dXJmVHJhbnNmb3JtU2NhbGUgZnJvbSAnQHR1cmYvdHJhbnNmb3JtLXNjYWxlJztcbmltcG9ydCB0eXBlIHsgRmVhdHVyZUNvbGxlY3Rpb24sIFBvc2l0aW9uIH0gZnJvbSAnLi4vZ2VvanNvbi10eXBlcy5qcyc7XG5pbXBvcnQgdHlwZSB7XG4gIE1vZGVQcm9wcyxcbiAgUG9pbnRlck1vdmVFdmVudCxcbiAgU3RhcnREcmFnZ2luZ0V2ZW50LFxuICBTdG9wRHJhZ2dpbmdFdmVudFxufSBmcm9tICcuLi90eXBlcy5qcyc7XG5pbXBvcnQgeyBCYXNlR2VvSnNvbkVkaXRNb2RlLCB0eXBlIEdlb0pzb25FZGl0QWN0aW9uIH0gZnJvbSAnLi9nZW9qc29uLWVkaXQtbW9kZS5qcyc7XG5pbXBvcnQgeyBJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbiB9IGZyb20gJy4vaW1tdXRhYmxlLWZlYXR1cmUtY29sbGVjdGlvbi5qcyc7XG5cbmV4cG9ydCBjbGFzcyBTY2FsZU1vZGUgZXh0ZW5kcyBCYXNlR2VvSnNvbkVkaXRNb2RlIHtcbiAgX2lzU2NhbGFibGU6IGJvb2xlYW47XG4gIF9nZW9tZXRyeUJlaW5nU2NhbGVkOiA/RmVhdHVyZUNvbGxlY3Rpb247XG5cbiAgaGFuZGxlUG9pbnRlck1vdmVBZGFwdGVyKFxuICAgIGV2ZW50OiBQb2ludGVyTW92ZUV2ZW50LFxuICAgIHByb3BzOiBNb2RlUHJvcHM8RmVhdHVyZUNvbGxlY3Rpb24+XG4gICk6IHsgZWRpdEFjdGlvbjogP0dlb0pzb25FZGl0QWN0aW9uLCBjYW5jZWxNYXBQYW46IGJvb2xlYW4gfSB7XG4gICAgbGV0IGVkaXRBY3Rpb246ID9HZW9Kc29uRWRpdEFjdGlvbiA9IG51bGw7XG5cbiAgICB0aGlzLl9pc1NjYWxhYmxlID1cbiAgICAgIEJvb2xlYW4odGhpcy5fZ2VvbWV0cnlCZWluZ1NjYWxlZCkgfHwgdGhpcy5pc1NlbGVjdGlvblBpY2tlZChldmVudC5waWNrcywgcHJvcHMpO1xuXG4gICAgaWYgKCF0aGlzLl9pc1NjYWxhYmxlIHx8ICFldmVudC5wb2ludGVyRG93bk1hcENvb3Jkcykge1xuICAgICAgLy8gTm90aGluZyB0byBkb1xuICAgICAgcmV0dXJuIHsgZWRpdEFjdGlvbjogbnVsbCwgY2FuY2VsTWFwUGFuOiBmYWxzZSB9O1xuICAgIH1cblxuICAgIGlmIChldmVudC5pc0RyYWdnaW5nICYmIHRoaXMuX2dlb21ldHJ5QmVpbmdTY2FsZWQpIHtcbiAgICAgIC8vIFNjYWxlIHRoZSBnZW9tZXRyeVxuICAgICAgZWRpdEFjdGlvbiA9IHRoaXMuZ2V0U2NhbGVBY3Rpb24oXG4gICAgICAgIGV2ZW50LnBvaW50ZXJEb3duTWFwQ29vcmRzLFxuICAgICAgICBldmVudC5tYXBDb29yZHMsXG4gICAgICAgICdzY2FsaW5nJyxcbiAgICAgICAgcHJvcHNcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgZWRpdEFjdGlvbiwgY2FuY2VsTWFwUGFuOiB0cnVlIH07XG4gIH1cblxuICBoYW5kbGVTdGFydERyYWdnaW5nQWRhcHRlcihcbiAgICBldmVudDogU3RhcnREcmFnZ2luZ0V2ZW50LFxuICAgIHByb3BzOiBNb2RlUHJvcHM8RmVhdHVyZUNvbGxlY3Rpb24+XG4gICk6ID9HZW9Kc29uRWRpdEFjdGlvbiB7XG4gICAgaWYgKCF0aGlzLl9pc1NjYWxhYmxlKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICB0aGlzLl9nZW9tZXRyeUJlaW5nU2NhbGVkID0gdGhpcy5nZXRTZWxlY3RlZEZlYXR1cmVzQXNGZWF0dXJlQ29sbGVjdGlvbihwcm9wcyk7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBoYW5kbGVTdG9wRHJhZ2dpbmdBZGFwdGVyKFxuICAgIGV2ZW50OiBTdG9wRHJhZ2dpbmdFdmVudCxcbiAgICBwcm9wczogTW9kZVByb3BzPEZlYXR1cmVDb2xsZWN0aW9uPlxuICApOiA/R2VvSnNvbkVkaXRBY3Rpb24ge1xuICAgIGxldCBlZGl0QWN0aW9uOiA/R2VvSnNvbkVkaXRBY3Rpb24gPSBudWxsO1xuXG4gICAgaWYgKHRoaXMuX2dlb21ldHJ5QmVpbmdTY2FsZWQpIHtcbiAgICAgIC8vIFNjYWxlIHRoZSBnZW9tZXRyeVxuICAgICAgZWRpdEFjdGlvbiA9IHRoaXMuZ2V0U2NhbGVBY3Rpb24oXG4gICAgICAgIGV2ZW50LnBvaW50ZXJEb3duTWFwQ29vcmRzLFxuICAgICAgICBldmVudC5tYXBDb29yZHMsXG4gICAgICAgICdzY2FsZWQnLFxuICAgICAgICBwcm9wc1xuICAgICAgKTtcbiAgICAgIHRoaXMuX2dlb21ldHJ5QmVpbmdTY2FsZWQgPSBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiBlZGl0QWN0aW9uO1xuICB9XG5cbiAgZ2V0Q3Vyc29yQWRhcHRlcigpOiA/c3RyaW5nIHtcbiAgICBpZiAodGhpcy5faXNTY2FsYWJsZSkge1xuICAgICAgLy8gVE9ETzogbG9vayBhdCBkb2luZyBTVkcgY3Vyc29ycyB0byBnZXQgYSBiZXR0ZXIgXCJzY2FsZVwiIGN1cnNvclxuICAgICAgcmV0dXJuICdtb3ZlJztcbiAgICB9XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBnZXRTY2FsZUFjdGlvbihcbiAgICBzdGFydERyYWdQb2ludDogUG9zaXRpb24sXG4gICAgY3VycmVudFBvaW50OiBQb3NpdGlvbixcbiAgICBlZGl0VHlwZTogc3RyaW5nLFxuICAgIHByb3BzOiBNb2RlUHJvcHM8RmVhdHVyZUNvbGxlY3Rpb24+XG4gICk6IEdlb0pzb25FZGl0QWN0aW9uIHtcbiAgICBjb25zdCBzdGFydFBvc2l0aW9uID0gc3RhcnREcmFnUG9pbnQ7XG4gICAgY29uc3QgY2VudHJvaWQgPSB0dXJmQ2VudHJvaWQodGhpcy5fZ2VvbWV0cnlCZWluZ1NjYWxlZCk7XG4gICAgY29uc3QgZmFjdG9yID0gZ2V0U2NhbGVGYWN0b3IoY2VudHJvaWQsIHN0YXJ0UG9zaXRpb24sIGN1cnJlbnRQb2ludCk7XG4gICAgY29uc3Qgc2NhbGVkRmVhdHVyZXMgPSB0dXJmVHJhbnNmb3JtU2NhbGUodGhpcy5fZ2VvbWV0cnlCZWluZ1NjYWxlZCwgZmFjdG9yLCB7XG4gICAgICBvcmlnaW46IGNlbnRyb2lkXG4gICAgfSk7XG5cbiAgICBsZXQgdXBkYXRlZERhdGEgPSBuZXcgSW1tdXRhYmxlRmVhdHVyZUNvbGxlY3Rpb24ocHJvcHMuZGF0YSk7XG5cbiAgICBjb25zdCBzZWxlY3RlZEluZGV4ZXMgPSBwcm9wcy5zZWxlY3RlZEluZGV4ZXM7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWxlY3RlZEluZGV4ZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHNlbGVjdGVkSW5kZXggPSBzZWxlY3RlZEluZGV4ZXNbaV07XG4gICAgICBjb25zdCBtb3ZlZEZlYXR1cmUgPSBzY2FsZWRGZWF0dXJlcy5mZWF0dXJlc1tpXTtcbiAgICAgIHVwZGF0ZWREYXRhID0gdXBkYXRlZERhdGEucmVwbGFjZUdlb21ldHJ5KHNlbGVjdGVkSW5kZXgsIG1vdmVkRmVhdHVyZS5nZW9tZXRyeSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHVwZGF0ZWREYXRhOiB1cGRhdGVkRGF0YS5nZXRPYmplY3QoKSxcbiAgICAgIGVkaXRUeXBlLFxuICAgICAgZWRpdENvbnRleHQ6IHtcbiAgICAgICAgZmVhdHVyZUluZGV4ZXM6IHNlbGVjdGVkSW5kZXhlc1xuICAgICAgfVxuICAgIH07XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0U2NhbGVGYWN0b3IoY2VudHJvaWQ6IFBvc2l0aW9uLCBzdGFydERyYWdQb2ludDogUG9zaXRpb24sIGN1cnJlbnRQb2ludDogUG9zaXRpb24pIHtcbiAgY29uc3Qgc3RhcnREaXN0YW5jZSA9IHR1cmZEaXN0YW5jZShjZW50cm9pZCwgc3RhcnREcmFnUG9pbnQpO1xuICBjb25zdCBlbmREaXN0YW5jZSA9IHR1cmZEaXN0YW5jZShjZW50cm9pZCwgY3VycmVudFBvaW50KTtcbiAgcmV0dXJuIGVuZERpc3RhbmNlIC8gc3RhcnREaXN0YW5jZTtcbn1cbiJdfQ==