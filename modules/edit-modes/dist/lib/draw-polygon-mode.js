"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DrawPolygonMode = void 0;

var _geojsonEditMode = require("./geojson-edit-mode.js");

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

class DrawPolygonMode extends _geojsonEditMode.BaseGeoJsonEditMode {
  getEditHandlesAdapter(picks, mapCoords, props) {
    var handles = super.getEditHandlesAdapter(picks, mapCoords, props);
    var tentativeFeature = this.getTentativeFeature();

    if (tentativeFeature) {
      handles = handles.concat((0, _geojsonEditMode.getEditHandlesForGeometry)(tentativeFeature.geometry, -1)); // Slice off the handles that are are next to the pointer

      if (tentativeFeature && tentativeFeature.geometry.type === 'LineString') {
        // Remove the last existing handle
        handles = handles.slice(0, -1);
      } else if (tentativeFeature && tentativeFeature.geometry.type === 'Polygon') {
        // Remove the last existing handle
        handles = handles.slice(0, -1);
      }
    }

    return handles;
  }

  handleClickAdapter(event, props) {
    super.handleClickAdapter(event, props);
    var picks = event.picks;
    var tentativeFeature = this.getTentativeFeature();
    var editAction = null;
    var clickedEditHandle = (0, _geojsonEditMode.getPickedEditHandle)(picks);

    if (clickedEditHandle) {
      // User clicked an edit handle.
      // Remove it from the click sequence, so it isn't added as a new point.
      var clickSequence = this.getClickSequence();
      clickSequence.splice(clickSequence.length - 1, 1);
    }

    if (tentativeFeature && tentativeFeature.geometry.type === 'Polygon') {
      var polygon = tentativeFeature.geometry;

      if (clickedEditHandle && clickedEditHandle.featureIndex === -1 && (clickedEditHandle.positionIndexes[1] === 0 || clickedEditHandle.positionIndexes[1] === polygon.coordinates[0].length - 3)) {
        // They clicked the first or last point (or double-clicked), so complete the polygon
        // Remove the hovered position
        var polygonToAdd = {
          type: 'Polygon',
          coordinates: [_toConsumableArray(polygon.coordinates[0].slice(0, -2)).concat([polygon.coordinates[0][0]])]
        };
        this.resetClickSequence();

        this._setTentativeFeature(null);

        editAction = this.getAddFeatureOrBooleanPolygonAction(polygonToAdd, props);
      }
    } // Trigger pointer move right away in order for it to update edit handles (to support double-click)


    var fakePointerMoveEvent = {
      screenCoords: [-1, -1],
      mapCoords: event.mapCoords,
      picks: [],
      isDragging: false,
      pointerDownPicks: null,
      pointerDownScreenCoords: null,
      pointerDownMapCoords: null,
      sourceEvent: null
    };
    this.handlePointerMoveAdapter(fakePointerMoveEvent, props);
    return editAction;
  }

  handlePointerMoveAdapter(_ref, props) {
    var mapCoords = _ref.mapCoords;
    var clickSequence = this.getClickSequence();
    var result = {
      editAction: null,
      cancelMapPan: false
    };

    if (clickSequence.length === 0) {
      // nothing to do yet
      return result;
    }

    if (clickSequence.length < 3) {
      // Draw a LineString connecting all the clicked points with the hovered point
      this._setTentativeFeature({
        type: 'Feature',
        geometry: {
          type: 'LineString',
          coordinates: _toConsumableArray(clickSequence).concat([mapCoords])
        }
      });
    } else {
      // Draw a Polygon connecting all the clicked points with the hovered point
      this._setTentativeFeature({
        type: 'Feature',
        geometry: {
          type: 'Polygon',
          coordinates: [_toConsumableArray(clickSequence).concat([mapCoords, clickSequence[0]])]
        }
      });
    }

    return result;
  }

  getCursorAdapter() {
    return 'cell';
  }

}

exports.DrawPolygonMode = DrawPolygonMode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvZHJhdy1wb2x5Z29uLW1vZGUuanMiXSwibmFtZXMiOlsiRHJhd1BvbHlnb25Nb2RlIiwiQmFzZUdlb0pzb25FZGl0TW9kZSIsImdldEVkaXRIYW5kbGVzQWRhcHRlciIsInBpY2tzIiwibWFwQ29vcmRzIiwicHJvcHMiLCJoYW5kbGVzIiwidGVudGF0aXZlRmVhdHVyZSIsImdldFRlbnRhdGl2ZUZlYXR1cmUiLCJjb25jYXQiLCJnZW9tZXRyeSIsInR5cGUiLCJzbGljZSIsImhhbmRsZUNsaWNrQWRhcHRlciIsImV2ZW50IiwiZWRpdEFjdGlvbiIsImNsaWNrZWRFZGl0SGFuZGxlIiwiY2xpY2tTZXF1ZW5jZSIsImdldENsaWNrU2VxdWVuY2UiLCJzcGxpY2UiLCJsZW5ndGgiLCJwb2x5Z29uIiwiZmVhdHVyZUluZGV4IiwicG9zaXRpb25JbmRleGVzIiwiY29vcmRpbmF0ZXMiLCJwb2x5Z29uVG9BZGQiLCJyZXNldENsaWNrU2VxdWVuY2UiLCJfc2V0VGVudGF0aXZlRmVhdHVyZSIsImdldEFkZEZlYXR1cmVPckJvb2xlYW5Qb2x5Z29uQWN0aW9uIiwiZmFrZVBvaW50ZXJNb3ZlRXZlbnQiLCJzY3JlZW5Db29yZHMiLCJpc0RyYWdnaW5nIiwicG9pbnRlckRvd25QaWNrcyIsInBvaW50ZXJEb3duU2NyZWVuQ29vcmRzIiwicG9pbnRlckRvd25NYXBDb29yZHMiLCJzb3VyY2VFdmVudCIsImhhbmRsZVBvaW50ZXJNb3ZlQWRhcHRlciIsInJlc3VsdCIsImNhbmNlbE1hcFBhbiIsImdldEN1cnNvckFkYXB0ZXIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFLQTs7Ozs7Ozs7OztBQU1PLE1BQU1BLGVBQU4sU0FBOEJDLG9DQUE5QixDQUFrRDtBQUN2REMsRUFBQUEscUJBQXFCLENBQ25CQyxLQURtQixFQUVuQkMsU0FGbUIsRUFHbkJDLEtBSG1CLEVBSUw7QUFDZCxRQUFJQyxPQUFPLEdBQUcsTUFBTUoscUJBQU4sQ0FBNEJDLEtBQTVC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YUFBYSxDQUFDLENBQUQsQ0FBNUM7QUFGTDtBQUZjLE9BQTFCO0FBT0Q7O0FBRUQsV0FBT29CLE1BQVA7QUFDRDs7QUFFREUsRUFBQUEsZ0JBQWdCLEdBQUc7QUFDakIsV0FBTyxNQUFQO0FBQ0Q7O0FBckhzRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB0eXBlIHsgQ2xpY2tFdmVudCwgUG9pbnRlck1vdmVFdmVudCwgTW9kZVByb3BzIH0gZnJvbSAnLi4vdHlwZXMuanMnO1xuaW1wb3J0IHR5cGUgeyBQb2x5Z29uLCBQb3NpdGlvbiwgRmVhdHVyZUNvbGxlY3Rpb24gfSBmcm9tICcuLi9nZW9qc29uLXR5cGVzLmpzJztcbmltcG9ydCB0eXBlIHsgR2VvSnNvbkVkaXRBY3Rpb24sIEVkaXRIYW5kbGUgfSBmcm9tICcuL2dlb2pzb24tZWRpdC1tb2RlLmpzJztcbmltcG9ydCB7XG4gIEJhc2VHZW9Kc29uRWRpdE1vZGUsXG4gIGdldFBpY2tlZEVkaXRIYW5kbGUsXG4gIGdldEVkaXRIYW5kbGVzRm9yR2VvbWV0cnlcbn0gZnJvbSAnLi9nZW9qc29uLWVkaXQtbW9kZS5qcyc7XG5cbmV4cG9ydCBjbGFzcyBEcmF3UG9seWdvbk1vZGUgZXh0ZW5kcyBCYXNlR2VvSnNvbkVkaXRNb2RlIHtcbiAgZ2V0RWRpdEhhbmRsZXNBZGFwdGVyKFxuICAgIHBpY2tzOiA/QXJyYXk8T2JqZWN0PixcbiAgICBtYXBDb29yZHM6ID9Qb3NpdGlvbixcbiAgICBwcm9wczogTW9kZVByb3BzPEZlYXR1cmVDb2xsZWN0aW9uPlxuICApOiBFZGl0SGFuZGxlW10ge1xuICAgIGxldCBoYW5kbGVzID0gc3VwZXIuZ2V0RWRpdEhhbmRsZXNBZGFwdGVyKHBpY2tzLCBtYXBDb29yZHMsIHByb3BzKTtcblxuICAgIGNvbnN0IHRlbnRhdGl2ZUZlYXR1cmUgPSB0aGlzLmdldFRlbnRhdGl2ZUZlYXR1cmUoKTtcbiAgICBpZiAodGVudGF0aXZlRmVhdHVyZSkge1xuICAgICAgaGFuZGxlcyA9IGhhbmRsZXMuY29uY2F0KGdldEVkaXRIYW5kbGVzRm9yR2VvbWV0cnkodGVudGF0aXZlRmVhdHVyZS5nZW9tZXRyeSwgLTEpKTtcbiAgICAgIC8vIFNsaWNlIG9mZiB0aGUgaGFuZGxlcyB0aGF0IGFyZSBhcmUgbmV4dCB0byB0aGUgcG9pbnRlclxuICAgICAgaWYgKHRlbnRhdGl2ZUZlYXR1cmUgJiYgdGVudGF0aXZlRmVhdHVyZS5nZW9tZXRyeS50eXBlID09PSAnTGluZVN0cmluZycpIHtcbiAgICAgICAgLy8gUmVtb3ZlIHRoZSBsYXN0IGV4aXN0aW5nIGhhbmRsZVxuICAgICAgICBoYW5kbGVzID0gaGFuZGxlcy5zbGljZSgwLCAtMSk7XG4gICAgICB9IGVsc2UgaWYgKHRlbnRhdGl2ZUZlYXR1cmUgJiYgdGVudGF0aXZlRmVhdHVyZS5nZW9tZXRyeS50eXBlID09PSAnUG9seWdvbicpIHtcbiAgICAgICAgLy8gUmVtb3ZlIHRoZSBsYXN0IGV4aXN0aW5nIGhhbmRsZVxuICAgICAgICBoYW5kbGVzID0gaGFuZGxlcy5zbGljZSgwLCAtMSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGhhbmRsZXM7XG4gIH1cblxuICBoYW5kbGVDbGlja0FkYXB0ZXIoZXZlbnQ6IENsaWNrRXZlbnQsIHByb3BzOiBNb2RlUHJvcHM8RmVhdHVyZUNvbGxlY3Rpb24+KTogP0dlb0pzb25FZGl0QWN0aW9uIHtcbiAgICBzdXBlci5oYW5kbGVDbGlja0FkYXB0ZXIoZXZlbnQsIHByb3BzKTtcblxuICAgIGNvbnN0IHsgcGlja3MgfSA9IGV2ZW50O1xuICAgIGNvbnN0IHRlbnRhdGl2ZUZlYXR1cmUgPSB0aGlzLmdldFRlbnRhdGl2ZUZlYXR1cmUoKTtcblxuICAgIGxldCBlZGl0QWN0aW9uOiA/R2VvSnNvbkVkaXRBY3Rpb24gPSBudWxsO1xuICAgIGNvbnN0IGNsaWNrZWRFZGl0SGFuZGxlID0gZ2V0UGlja2VkRWRpdEhhbmRsZShwaWNrcyk7XG5cbiAgICBpZiAoY2xpY2tlZEVkaXRIYW5kbGUpIHtcbiAgICAgIC8vIFVzZXIgY2xpY2tlZCBhbiBlZGl0IGhhbmRsZS5cbiAgICAgIC8vIFJlbW92ZSBpdCBmcm9tIHRoZSBjbGljayBzZXF1ZW5jZSwgc28gaXQgaXNuJ3QgYWRkZWQgYXMgYSBuZXcgcG9pbnQuXG4gICAgICBjb25zdCBjbGlja1NlcXVlbmNlID0gdGhpcy5nZXRDbGlja1NlcXVlbmNlKCk7XG4gICAgICBjbGlja1NlcXVlbmNlLnNwbGljZShjbGlja1NlcXVlbmNlLmxlbmd0aCAtIDEsIDEpO1xuICAgIH1cblxuICAgIGlmICh0ZW50YXRpdmVGZWF0dXJlICYmIHRlbnRhdGl2ZUZlYXR1cmUuZ2VvbWV0cnkudHlwZSA9PT0gJ1BvbHlnb24nKSB7XG4gICAgICBjb25zdCBwb2x5Z29uOiBQb2x5Z29uID0gdGVudGF0aXZlRmVhdHVyZS5nZW9tZXRyeTtcblxuICAgICAgaWYgKFxuICAgICAgICBjbGlja2VkRWRpdEhhbmRsZSAmJlxuICAgICAgICBjbGlja2VkRWRpdEhhbmRsZS5mZWF0dXJlSW5kZXggPT09IC0xICYmXG4gICAgICAgIChjbGlja2VkRWRpdEhhbmRsZS5wb3NpdGlvbkluZGV4ZXNbMV0gPT09IDAgfHxcbiAgICAgICAgICBjbGlja2VkRWRpdEhhbmRsZS5wb3NpdGlvbkluZGV4ZXNbMV0gPT09IHBvbHlnb24uY29vcmRpbmF0ZXNbMF0ubGVuZ3RoIC0gMylcbiAgICAgICkge1xuICAgICAgICAvLyBUaGV5IGNsaWNrZWQgdGhlIGZpcnN0IG9yIGxhc3QgcG9pbnQgKG9yIGRvdWJsZS1jbGlja2VkKSwgc28gY29tcGxldGUgdGhlIHBvbHlnb25cblxuICAgICAgICAvLyBSZW1vdmUgdGhlIGhvdmVyZWQgcG9zaXRpb25cbiAgICAgICAgY29uc3QgcG9seWdvblRvQWRkOiBQb2x5Z29uID0ge1xuICAgICAgICAgIHR5cGU6ICdQb2x5Z29uJyxcbiAgICAgICAgICBjb29yZGluYXRlczogW1suLi5wb2x5Z29uLmNvb3JkaW5hdGVzWzBdLnNsaWNlKDAsIC0yKSwgcG9seWdvbi5jb29yZGluYXRlc1swXVswXV1dXG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5yZXNldENsaWNrU2VxdWVuY2UoKTtcbiAgICAgICAgdGhpcy5fc2V0VGVudGF0aXZlRmVhdHVyZShudWxsKTtcbiAgICAgICAgZWRpdEFjdGlvbiA9IHRoaXMuZ2V0QWRkRmVhdHVyZU9yQm9vbGVhblBvbHlnb25BY3Rpb24ocG9seWdvblRvQWRkLCBwcm9wcyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gVHJpZ2dlciBwb2ludGVyIG1vdmUgcmlnaHQgYXdheSBpbiBvcmRlciBmb3IgaXQgdG8gdXBkYXRlIGVkaXQgaGFuZGxlcyAodG8gc3VwcG9ydCBkb3VibGUtY2xpY2spXG4gICAgY29uc3QgZmFrZVBvaW50ZXJNb3ZlRXZlbnQgPSB7XG4gICAgICBzY3JlZW5Db29yZHM6IFstMSwgLTFdLFxuICAgICAgbWFwQ29vcmRzOiBldmVudC5tYXBDb29yZHMsXG4gICAgICBwaWNrczogW10sXG4gICAgICBpc0RyYWdnaW5nOiBmYWxzZSxcbiAgICAgIHBvaW50ZXJEb3duUGlja3M6IG51bGwsXG4gICAgICBwb2ludGVyRG93blNjcmVlbkNvb3JkczogbnVsbCxcbiAgICAgIHBvaW50ZXJEb3duTWFwQ29vcmRzOiBudWxsLFxuICAgICAgc291cmNlRXZlbnQ6IG51bGxcbiAgICB9O1xuXG4gICAgdGhpcy5oYW5kbGVQb2ludGVyTW92ZUFkYXB0ZXIoZmFrZVBvaW50ZXJNb3ZlRXZlbnQsIHByb3BzKTtcblxuICAgIHJldHVybiBlZGl0QWN0aW9uO1xuICB9XG5cbiAgaGFuZGxlUG9pbnRlck1vdmVBZGFwdGVyKFxuICAgIHsgbWFwQ29vcmRzIH06IFBvaW50ZXJNb3ZlRXZlbnQsXG4gICAgcHJvcHM6IE1vZGVQcm9wczxGZWF0dXJlQ29sbGVjdGlvbj5cbiAgKTogeyBlZGl0QWN0aW9uOiA/R2VvSnNvbkVkaXRBY3Rpb24sIGNhbmNlbE1hcFBhbjogYm9vbGVhbiB9IHtcbiAgICBjb25zdCBjbGlja1NlcXVlbmNlID0gdGhpcy5nZXRDbGlja1NlcXVlbmNlKCk7XG4gICAgY29uc3QgcmVzdWx0ID0geyBlZGl0QWN0aW9uOiBudWxsLCBjYW5jZWxNYXBQYW46IGZhbHNlIH07XG5cbiAgICBpZiAoY2xpY2tTZXF1ZW5jZS5sZW5ndGggPT09IDApIHtcbiAgICAgIC8vIG5vdGhpbmcgdG8gZG8geWV0XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIGlmIChjbGlja1NlcXVlbmNlLmxlbmd0aCA8IDMpIHtcbiAgICAgIC8vIERyYXcgYSBMaW5lU3RyaW5nIGNvbm5lY3RpbmcgYWxsIHRoZSBjbGlja2VkIHBvaW50cyB3aXRoIHRoZSBob3ZlcmVkIHBvaW50XG4gICAgICB0aGlzLl9zZXRUZW50YXRpdmVGZWF0dXJlKHtcbiAgICAgICAgdHlwZTogJ0ZlYXR1cmUnLFxuICAgICAgICBnZW9tZXRyeToge1xuICAgICAgICAgIHR5cGU6ICdMaW5lU3RyaW5nJyxcbiAgICAgICAgICBjb29yZGluYXRlczogWy4uLmNsaWNrU2VxdWVuY2UsIG1hcENvb3Jkc11cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIERyYXcgYSBQb2x5Z29uIGNvbm5lY3RpbmcgYWxsIHRoZSBjbGlja2VkIHBvaW50cyB3aXRoIHRoZSBob3ZlcmVkIHBvaW50XG4gICAgICB0aGlzLl9zZXRUZW50YXRpdmVGZWF0dXJlKHtcbiAgICAgICAgdHlwZTogJ0ZlYXR1cmUnLFxuICAgICAgICBnZW9tZXRyeToge1xuICAgICAgICAgIHR5cGU6ICdQb2x5Z29uJyxcbiAgICAgICAgICBjb29yZGluYXRlczogW1suLi5jbGlja1NlcXVlbmNlLCBtYXBDb29yZHMsIGNsaWNrU2VxdWVuY2VbMF1dXVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgZ2V0Q3Vyc29yQWRhcHRlcigpIHtcbiAgICByZXR1cm4gJ2NlbGwnO1xuICB9XG59XG4iXX0=