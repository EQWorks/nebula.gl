"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ImmutableFeatureCollection = void 0;

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class ImmutableFeatureCollection {
  constructor(featureCollection) {
    _defineProperty(this, "featureCollection", void 0);

    this.featureCollection = featureCollection;
  }

  getObject() {
    return this.featureCollection;
  }
  /**
   * Replaces the position deeply nested withing the given feature's geometry.
   * Works with Point, MultiPoint, LineString, MultiLineString, Polygon, and MultiPolygon.
   *
   * @param featureIndex The index of the feature to update
   * @param positionIndexes An array containing the indexes of the position to replace
   * @param updatedPosition The updated position to place in the result (i.e. [lng, lat])
   *
   * @returns A new `ImmutableFeatureCollection` with the given position replaced. Does not modify this `ImmutableFeatureCollection`.
   */


  replacePosition(featureIndex, positionIndexes, updatedPosition) {
    var geometry = this.featureCollection.features[featureIndex].geometry;
    var isPolygonal = geometry.type === 'Polygon' || geometry.type === 'MultiPolygon';

    var updatedGeometry = _objectSpread({}, geometry, {
      coordinates: immutablyReplacePosition(geometry.coordinates, positionIndexes, updatedPosition, isPolygonal)
    });

    return this.replaceGeometry(featureIndex, updatedGeometry);
  }
  /**
   * Removes a position deeply nested in a GeoJSON geometry coordinates array.
   * Works with MultiPoint, LineString, MultiLineString, Polygon, and MultiPolygon.
   *
   * @param featureIndex The index of the feature to update
   * @param positionIndexes An array containing the indexes of the postion to remove
   *
   * @returns A new `ImmutableFeatureCollection` with the given coordinate removed. Does not modify this `ImmutableFeatureCollection`.
   */


  removePosition(featureIndex, positionIndexes) {
    var geometry = this.featureCollection.features[featureIndex].geometry;

    if (geometry.type === 'Point') {
      throw Error("Can't remove a position from a Point or there'd be nothing left");
    }

    if (geometry.type === 'MultiPoint' && // only 1 point left
    geometry.coordinates.length < 2) {
      throw Error("Can't remove the last point of a MultiPoint or there'd be nothing left");
    }

    if (geometry.type === 'LineString' && // only 2 positions
    geometry.coordinates.length < 3) {
      throw Error("Can't remove position. LineString must have at least two positions");
    }

    if (geometry.type === 'Polygon' && // outer ring is a triangle
    geometry.coordinates[0].length < 5 && // trying to remove from outer ring
    positionIndexes[0] === 0) {
      throw Error("Can't remove position. Polygon's outer ring must have at least four positions");
    }

    if (geometry.type === 'MultiLineString' && // only 1 LineString left
    geometry.coordinates.length === 1 && // only 2 positions
    geometry.coordinates[0].length < 3) {
      throw Error("Can't remove position. MultiLineString must have at least two positions");
    }

    if (geometry.type === 'MultiPolygon' && // only 1 polygon left
    geometry.coordinates.length === 1 && // outer ring is a triangle
    geometry.coordinates[0][0].length < 5 && // trying to remove from first polygon
    positionIndexes[0] === 0 && // trying to remove from outer ring
    positionIndexes[1] === 0) {
      throw Error("Can't remove position. MultiPolygon's outer ring must have at least four positions");
    }

    var isPolygonal = geometry.type === 'Polygon' || geometry.type === 'MultiPolygon';

    var updatedGeometry = _objectSpread({}, geometry, {
      coordinates: immutablyRemovePosition(geometry.coordinates, positionIndexes, isPolygonal)
    }); // Handle cases where incomplete geometries need pruned (e.g. holes that were triangles)


    pruneGeometryIfNecessary(updatedGeometry);
    return this.replaceGeometry(featureIndex, updatedGeometry);
  }
  /**
   * Adds a position deeply nested in a GeoJSON geometry coordinates array.
   * Works with MultiPoint, LineString, MultiLineString, Polygon, and MultiPolygon.
   *
   * @param featureIndex The index of the feature to update
   * @param positionIndexes An array containing the indexes of the position that will proceed the new position
   * @param positionToAdd The new position to place in the result (i.e. [lng, lat])
   *
   * @returns A new `ImmutableFeatureCollection` with the given coordinate removed. Does not modify this `ImmutableFeatureCollection`.
   */


  addPosition(featureIndex, positionIndexes, positionToAdd) {
    var geometry = this.featureCollection.features[featureIndex].geometry;

    if (geometry.type === 'Point') {
      throw new Error('Unable to add a position to a Point feature');
    }

    var isPolygonal = geometry.type === 'Polygon' || geometry.type === 'MultiPolygon';

    var updatedGeometry = _objectSpread({}, geometry, {
      coordinates: immutablyAddPosition(geometry.coordinates, positionIndexes, positionToAdd, isPolygonal)
    });

    return this.replaceGeometry(featureIndex, updatedGeometry);
  }

  replaceGeometry(featureIndex, geometry) {
    var updatedFeature = _objectSpread({}, this.featureCollection.features[featureIndex], {
      geometry: geometry
    });

    var updatedFeatureCollection = _objectSpread({}, this.featureCollection, {
      features: _toConsumableArray(this.featureCollection.features.slice(0, featureIndex)).concat([updatedFeature], _toConsumableArray(this.featureCollection.features.slice(featureIndex + 1)))
    });

    return new ImmutableFeatureCollection(updatedFeatureCollection);
  }

  addFeature(feature) {
    return this.addFeatures([feature]);
  }

  addFeatures(features) {
    var updatedFeatureCollection = _objectSpread({}, this.featureCollection, {
      features: _toConsumableArray(this.featureCollection.features).concat(_toConsumableArray(features))
    });

    return new ImmutableFeatureCollection(updatedFeatureCollection);
  }

  deleteFeature(featureIndex) {
    return this.deleteFeatures([featureIndex]);
  }

  deleteFeatures(featureIndexes) {
    var features = _toConsumableArray(this.featureCollection.features);

    featureIndexes.sort();

    for (var i = featureIndexes.length - 1; i >= 0; i--) {
      var featureIndex = featureIndexes[i];

      if (featureIndex >= 0 && featureIndex < features.length) {
        features.splice(featureIndex, 1);
      }
    }

    var updatedFeatureCollection = _objectSpread({}, this.featureCollection, {
      features: features
    });

    return new ImmutableFeatureCollection(updatedFeatureCollection);
  }

}

exports.ImmutableFeatureCollection = ImmutableFeatureCollection;

function getUpdatedPosition(updatedPosition, previousPosition) {
  // This function checks if the updatedPosition is missing elevation
  // and copies it from previousPosition
  if (updatedPosition.length === 2 && previousPosition.length === 3) {
    var elevation = previousPosition[2];
    return [updatedPosition[0], updatedPosition[1], elevation];
  }

  return updatedPosition;
}

function immutablyReplacePosition(coordinates, positionIndexes, updatedPosition, isPolygonal) {
  if (!positionIndexes) {
    return coordinates;
  }

  if (positionIndexes.length === 0) {
    return getUpdatedPosition(updatedPosition, coordinates);
  }

  if (positionIndexes.length === 1) {
    var updated = _toConsumableArray(coordinates.slice(0, positionIndexes[0])).concat([getUpdatedPosition(updatedPosition, coordinates[positionIndexes[0]])], _toConsumableArray(coordinates.slice(positionIndexes[0] + 1)));

    if (isPolygonal && (positionIndexes[0] === 0 || positionIndexes[0] === coordinates.length - 1)) {
      // for polygons, the first point is repeated at the end of the array
      // so, update it on both ends of the array
      updated[0] = getUpdatedPosition(updatedPosition, coordinates[0]);
      updated[coordinates.length - 1] = getUpdatedPosition(updatedPosition, coordinates[0]);
    }

    return updated;
  } // recursively update inner array


  return _toConsumableArray(coordinates.slice(0, positionIndexes[0])).concat([immutablyReplacePosition(coordinates[positionIndexes[0]], positionIndexes.slice(1, positionIndexes.length), updatedPosition, isPolygonal)], _toConsumableArray(coordinates.slice(positionIndexes[0] + 1)));
}

function immutablyRemovePosition(coordinates, positionIndexes, isPolygonal) {
  if (!positionIndexes) {
    return coordinates;
  }

  if (positionIndexes.length === 0) {
    throw Error('Must specify the index of the position to remove');
  }

  if (positionIndexes.length === 1) {
    var updated = _toConsumableArray(coordinates.slice(0, positionIndexes[0])).concat(_toConsumableArray(coordinates.slice(positionIndexes[0] + 1)));

    if (isPolygonal && (positionIndexes[0] === 0 || positionIndexes[0] === coordinates.length - 1)) {
      // for polygons, the first point is repeated at the end of the array
      // so, if the first/last coordinate is to be removed, coordinates[1] will be the new first/last coordinate
      if (positionIndexes[0] === 0) {
        // change the last to be the same as the first
        updated[updated.length - 1] = updated[0];
      } else if (positionIndexes[0] === coordinates.length - 1) {
        // change the first to be the same as the last
        updated[0] = updated[updated.length - 1];
      }
    }

    return updated;
  } // recursively update inner array


  return _toConsumableArray(coordinates.slice(0, positionIndexes[0])).concat([immutablyRemovePosition(coordinates[positionIndexes[0]], positionIndexes.slice(1, positionIndexes.length), isPolygonal)], _toConsumableArray(coordinates.slice(positionIndexes[0] + 1)));
}

function immutablyAddPosition(coordinates, positionIndexes, positionToAdd, isPolygonal) {
  if (!positionIndexes) {
    return coordinates;
  }

  if (positionIndexes.length === 0) {
    throw Error('Must specify the index of the position to remove');
  }

  if (positionIndexes.length === 1) {
    var updated = _toConsumableArray(coordinates.slice(0, positionIndexes[0])).concat([positionToAdd], _toConsumableArray(coordinates.slice(positionIndexes[0])));

    return updated;
  } // recursively update inner array


  return _toConsumableArray(coordinates.slice(0, positionIndexes[0])).concat([immutablyAddPosition(coordinates[positionIndexes[0]], positionIndexes.slice(1, positionIndexes.length), positionToAdd, isPolygonal)], _toConsumableArray(coordinates.slice(positionIndexes[0] + 1)));
}

function pruneGeometryIfNecessary(geometry) {
  switch (geometry.type) {
    case 'Polygon':
      prunePolygonIfNecessary(geometry);
      break;

    case 'MultiLineString':
      pruneMultiLineStringIfNecessary(geometry);
      break;

    case 'MultiPolygon':
      pruneMultiPolygonIfNecessary(geometry);
      break;

    default:
      // Not downgradable
      break;
  }
}

function prunePolygonIfNecessary(geometry) {
  var polygon = geometry.coordinates; // If any hole is no longer a polygon, remove the hole entirely

  for (var holeIndex = 1; holeIndex < polygon.length; holeIndex++) {
    if (removeHoleIfNecessary(polygon, holeIndex)) {
      // It was removed, so keep the index the same
      holeIndex--;
    }
  }
}

function pruneMultiLineStringIfNecessary(geometry) {
  for (var lineStringIndex = 0; lineStringIndex < geometry.coordinates.length; lineStringIndex++) {
    var lineString = geometry.coordinates[lineStringIndex];

    if (lineString.length === 1) {
      // Only a single position left on this LineString, so remove it (can't have Point in MultiLineString)
      geometry.coordinates.splice(lineStringIndex, 1); // Keep the index the same

      lineStringIndex--;
    }
  }
}

function pruneMultiPolygonIfNecessary(geometry) {
  for (var polygonIndex = 0; polygonIndex < geometry.coordinates.length; polygonIndex++) {
    var polygon = geometry.coordinates[polygonIndex];
    var outerRing = polygon[0]; // If the outer ring is no longer a polygon, remove the whole polygon

    if (outerRing.length <= 3) {
      geometry.coordinates.splice(polygonIndex, 1); // It was removed, so keep the index the same

      polygonIndex--;
    }

    for (var holeIndex = 1; holeIndex < polygon.length; holeIndex++) {
      if (removeHoleIfNecessary(polygon, holeIndex)) {
        // It was removed, so keep the index the same
        holeIndex--;
      }
    }
  }
}

function removeHoleIfNecessary(polygon, holeIndex) {
  var hole = polygon[holeIndex];

  if (hole.length <= 3) {
    polygon.splice(holeIndex, 1);
    return true;
  }

  return false;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvaW1tdXRhYmxlLWZlYXR1cmUtY29sbGVjdGlvbi5qcyJdLCJuYW1lcyI6WyJJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbiIsImNvbnN0cnVjdG9yIiwiZmVhdHVyZUNvbGxlY3Rpb24iLCJnZXRPYmplY3QiLCJyZXBsYWNlUG9zaXRpb24iLCJmZWF0dXJlSW5kZXgiLCJwb3NpdGlvbkluZGV4ZXMiLCJ1cGRhdGVkUG9zaXRpb24iLCJnZW9tZXRyeSIsImZlYXR1cmVzIiwiaXNQb2x5Z29uYWwiLCJ0eXBlIiwidXBkYXRlZEdlb21ldHJ5IiwiY29vcmRpbmF0ZXMiLCJpbW11dGFibHlSZXBsYWNlUG9zaXRpb24iLCJyZXBsYWNlR2VvbWV0cnkiLCJyZW1vdmVQb3NpdGlvbiIsIkVycm9yIiwibGVuZ3RoIiwiaW1tdXRhYmx5UmVtb3ZlUG9zaXRpb24iLCJwcnVuZUdlb21ldHJ5SWZOZWNlc3NhcnkiLCJhZGRQb3NpdGlvbiIsInBvc2l0aW9uVG9BZGQiLCJpbW11dGFibHlBZGRQb3NpdGlvbiIsInVwZGF0ZWRGZWF0dXJlIiwidXBkYXRlZEZlYXR1cmVDb2xsZWN0aW9uIiwic2xpY2UiLCJhZGRGZWF0dXJlIiwiZmVhdHVyZSIsImFkZEZlYXR1cmVzIiwiZGVsZXRlRmVhdHVyZSIsImRlbGV0ZUZlYXR1cmVzIiwiZmVhdHVyZUluZGV4ZXMiLCJzb3J0IiwiaSIsInNwbGljZSIsImdldFVwZGF0ZWRQb3NpdGlvbiIsInByZXZpb3VzUG9zaXRpb24iLCJlbGV2YXRpb24iLCJ1cGRhdGVkIiwicHJ1bmVQb2x5Z29uSWZOZWNlc3NhcnkiLCJwcnVuZU11bHRpTGluZVN0cmluZ0lmTmVjZXNzYXJ5IiwicHJ1bmVNdWx0aVBvbHlnb25JZk5lY2Vzc2FyeSIsInBvbHlnb24iLCJob2xlSW5kZXgiLCJyZW1vdmVIb2xlSWZOZWNlc3NhcnkiLCJsaW5lU3RyaW5nSW5kZXgiLCJsaW5lU3RyaW5nIiwicG9seWdvbkluZGV4Iiwib3V0ZXJSaW5n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QTVELEVBQStFO0FBQzdFLE1BQU1NLElBQUksR0FBR1AsT0FBTyxDQUFDQyxTQUFELENBQXBCOztBQUNBLE1BQUlNLElBQUksQ0FBQ2hDLE1BQUwsSUFBZSxDQUFuQixFQUFzQjtBQUNwQnlCLElBQUFBLE9BQU8sQ0FBQ1IsTUFBUixDQUFlUyxTQUFmLEVBQTBCLENBQTFCO0FBQ0EsV0FBTyxJQUFQO0FBQ0Q7O0FBQ0QsU0FBTyxLQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgdHlwZSB7XG4gIEZlYXR1cmUsXG4gIEZlYXR1cmVDb2xsZWN0aW9uLFxuICBHZW9tZXRyeSxcbiAgUG9seWdvbixcbiAgTXVsdGlMaW5lU3RyaW5nLFxuICBNdWx0aVBvbHlnb24sXG4gIFBvc2l0aW9uLFxuICBQb2x5Z29uQ29vcmRpbmF0ZXNcbn0gZnJvbSAnLi4vZ2VvanNvbi10eXBlcy5qcyc7XG5cbmV4cG9ydCBjbGFzcyBJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbiB7XG4gIGZlYXR1cmVDb2xsZWN0aW9uOiBGZWF0dXJlQ29sbGVjdGlvbjtcblxuICBjb25zdHJ1Y3RvcihmZWF0dXJlQ29sbGVjdGlvbjogRmVhdHVyZUNvbGxlY3Rpb24pIHtcbiAgICB0aGlzLmZlYXR1cmVDb2xsZWN0aW9uID0gZmVhdHVyZUNvbGxlY3Rpb247XG4gIH1cblxuICBnZXRPYmplY3QoKSB7XG4gICAgcmV0dXJuIHRoaXMuZmVhdHVyZUNvbGxlY3Rpb247XG4gIH1cblxuICAvKipcbiAgICogUmVwbGFjZXMgdGhlIHBvc2l0aW9uIGRlZXBseSBuZXN0ZWQgd2l0aGluZyB0aGUgZ2l2ZW4gZmVhdHVyZSdzIGdlb21ldHJ5LlxuICAgKiBXb3JrcyB3aXRoIFBvaW50LCBNdWx0aVBvaW50LCBMaW5lU3RyaW5nLCBNdWx0aUxpbmVTdHJpbmcsIFBvbHlnb24sIGFuZCBNdWx0aVBvbHlnb24uXG4gICAqXG4gICAqIEBwYXJhbSBmZWF0dXJlSW5kZXggVGhlIGluZGV4IG9mIHRoZSBmZWF0dXJlIHRvIHVwZGF0ZVxuICAgKiBAcGFyYW0gcG9zaXRpb25JbmRleGVzIEFuIGFycmF5IGNvbnRhaW5pbmcgdGhlIGluZGV4ZXMgb2YgdGhlIHBvc2l0aW9uIHRvIHJlcGxhY2VcbiAgICogQHBhcmFtIHVwZGF0ZWRQb3NpdGlvbiBUaGUgdXBkYXRlZCBwb3NpdGlvbiB0byBwbGFjZSBpbiB0aGUgcmVzdWx0IChpLmUuIFtsbmcsIGxhdF0pXG4gICAqXG4gICAqIEByZXR1cm5zIEEgbmV3IGBJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbmAgd2l0aCB0aGUgZ2l2ZW4gcG9zaXRpb24gcmVwbGFjZWQuIERvZXMgbm90IG1vZGlmeSB0aGlzIGBJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbmAuXG4gICAqL1xuICByZXBsYWNlUG9zaXRpb24oXG4gICAgZmVhdHVyZUluZGV4OiBudW1iZXIsXG4gICAgcG9zaXRpb25JbmRleGVzOiBudW1iZXJbXSxcbiAgICB1cGRhdGVkUG9zaXRpb246IFBvc2l0aW9uXG4gICk6IEltbXV0YWJsZUZlYXR1cmVDb2xsZWN0aW9uIHtcbiAgICBjb25zdCBnZW9tZXRyeSA9IHRoaXMuZmVhdHVyZUNvbGxlY3Rpb24uZmVhdHVyZXNbZmVhdHVyZUluZGV4XS5nZW9tZXRyeTtcblxuICAgIGNvbnN0IGlzUG9seWdvbmFsID0gZ2VvbWV0cnkudHlwZSA9PT0gJ1BvbHlnb24nIHx8IGdlb21ldHJ5LnR5cGUgPT09ICdNdWx0aVBvbHlnb24nO1xuICAgIGNvbnN0IHVwZGF0ZWRHZW9tZXRyeTogYW55ID0ge1xuICAgICAgLi4uZ2VvbWV0cnksXG4gICAgICBjb29yZGluYXRlczogaW1tdXRhYmx5UmVwbGFjZVBvc2l0aW9uKFxuICAgICAgICBnZW9tZXRyeS5jb29yZGluYXRlcyxcbiAgICAgICAgcG9zaXRpb25JbmRleGVzLFxuICAgICAgICB1cGRhdGVkUG9zaXRpb24sXG4gICAgICAgIGlzUG9seWdvbmFsXG4gICAgICApXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLnJlcGxhY2VHZW9tZXRyeShmZWF0dXJlSW5kZXgsIHVwZGF0ZWRHZW9tZXRyeSk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBhIHBvc2l0aW9uIGRlZXBseSBuZXN0ZWQgaW4gYSBHZW9KU09OIGdlb21ldHJ5IGNvb3JkaW5hdGVzIGFycmF5LlxuICAgKiBXb3JrcyB3aXRoIE11bHRpUG9pbnQsIExpbmVTdHJpbmcsIE11bHRpTGluZVN0cmluZywgUG9seWdvbiwgYW5kIE11bHRpUG9seWdvbi5cbiAgICpcbiAgICogQHBhcmFtIGZlYXR1cmVJbmRleCBUaGUgaW5kZXggb2YgdGhlIGZlYXR1cmUgdG8gdXBkYXRlXG4gICAqIEBwYXJhbSBwb3NpdGlvbkluZGV4ZXMgQW4gYXJyYXkgY29udGFpbmluZyB0aGUgaW5kZXhlcyBvZiB0aGUgcG9zdGlvbiB0byByZW1vdmVcbiAgICpcbiAgICogQHJldHVybnMgQSBuZXcgYEltbXV0YWJsZUZlYXR1cmVDb2xsZWN0aW9uYCB3aXRoIHRoZSBnaXZlbiBjb29yZGluYXRlIHJlbW92ZWQuIERvZXMgbm90IG1vZGlmeSB0aGlzIGBJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbmAuXG4gICAqL1xuICByZW1vdmVQb3NpdGlvbihmZWF0dXJlSW5kZXg6IG51bWJlciwgcG9zaXRpb25JbmRleGVzOiBudW1iZXJbXSk6IEltbXV0YWJsZUZlYXR1cmVDb2xsZWN0aW9uIHtcbiAgICBjb25zdCBnZW9tZXRyeSA9IHRoaXMuZmVhdHVyZUNvbGxlY3Rpb24uZmVhdHVyZXNbZmVhdHVyZUluZGV4XS5nZW9tZXRyeTtcblxuICAgIGlmIChnZW9tZXRyeS50eXBlID09PSAnUG9pbnQnKSB7XG4gICAgICB0aHJvdyBFcnJvcihgQ2FuJ3QgcmVtb3ZlIGEgcG9zaXRpb24gZnJvbSBhIFBvaW50IG9yIHRoZXJlJ2QgYmUgbm90aGluZyBsZWZ0YCk7XG4gICAgfVxuICAgIGlmIChcbiAgICAgIGdlb21ldHJ5LnR5cGUgPT09ICdNdWx0aVBvaW50JyAmJlxuICAgICAgLy8gb25seSAxIHBvaW50IGxlZnRcbiAgICAgIGdlb21ldHJ5LmNvb3JkaW5hdGVzLmxlbmd0aCA8IDJcbiAgICApIHtcbiAgICAgIHRocm93IEVycm9yKGBDYW4ndCByZW1vdmUgdGhlIGxhc3QgcG9pbnQgb2YgYSBNdWx0aVBvaW50IG9yIHRoZXJlJ2QgYmUgbm90aGluZyBsZWZ0YCk7XG4gICAgfVxuICAgIGlmIChcbiAgICAgIGdlb21ldHJ5LnR5cGUgPT09ICdMaW5lU3RyaW5nJyAmJlxuICAgICAgLy8gb25seSAyIHBvc2l0aW9uc1xuICAgICAgZ2VvbWV0cnkuY29vcmRpbmF0ZXMubGVuZ3RoIDwgM1xuICAgICkge1xuICAgICAgdGhyb3cgRXJyb3IoYENhbid0IHJlbW92ZSBwb3NpdGlvbi4gTGluZVN0cmluZyBtdXN0IGhhdmUgYXQgbGVhc3QgdHdvIHBvc2l0aW9uc2ApO1xuICAgIH1cbiAgICBpZiAoXG4gICAgICBnZW9tZXRyeS50eXBlID09PSAnUG9seWdvbicgJiZcbiAgICAgIC8vIG91dGVyIHJpbmcgaXMgYSB0cmlhbmdsZVxuICAgICAgZ2VvbWV0cnkuY29vcmRpbmF0ZXNbMF0ubGVuZ3RoIDwgNSAmJlxuICAgICAgLy8gdHJ5aW5nIHRvIHJlbW92ZSBmcm9tIG91dGVyIHJpbmdcbiAgICAgIHBvc2l0aW9uSW5kZXhlc1swXSA9PT0gMFxuICAgICkge1xuICAgICAgdGhyb3cgRXJyb3IoYENhbid0IHJlbW92ZSBwb3NpdGlvbi4gUG9seWdvbidzIG91dGVyIHJpbmcgbXVzdCBoYXZlIGF0IGxlYXN0IGZvdXIgcG9zaXRpb25zYCk7XG4gICAgfVxuICAgIGlmIChcbiAgICAgIGdlb21ldHJ5LnR5cGUgPT09ICdNdWx0aUxpbmVTdHJpbmcnICYmXG4gICAgICAvLyBvbmx5IDEgTGluZVN0cmluZyBsZWZ0XG4gICAgICBnZW9tZXRyeS5jb29yZGluYXRlcy5sZW5ndGggPT09IDEgJiZcbiAgICAgIC8vIG9ubHkgMiBwb3NpdGlvbnNcbiAgICAgIGdlb21ldHJ5LmNvb3JkaW5hdGVzWzBdLmxlbmd0aCA8IDNcbiAgICApIHtcbiAgICAgIHRocm93IEVycm9yKGBDYW4ndCByZW1vdmUgcG9zaXRpb24uIE11bHRpTGluZVN0cmluZyBtdXN0IGhhdmUgYXQgbGVhc3QgdHdvIHBvc2l0aW9uc2ApO1xuICAgIH1cbiAgICBpZiAoXG4gICAgICBnZW9tZXRyeS50eXBlID09PSAnTXVsdGlQb2x5Z29uJyAmJlxuICAgICAgLy8gb25seSAxIHBvbHlnb24gbGVmdFxuICAgICAgZ2VvbWV0cnkuY29vcmRpbmF0ZXMubGVuZ3RoID09PSAxICYmXG4gICAgICAvLyBvdXRlciByaW5nIGlzIGEgdHJpYW5nbGVcbiAgICAgIGdlb21ldHJ5LmNvb3JkaW5hdGVzWzBdWzBdLmxlbmd0aCA8IDUgJiZcbiAgICAgIC8vIHRyeWluZyB0byByZW1vdmUgZnJvbSBmaXJzdCBwb2x5Z29uXG4gICAgICBwb3NpdGlvbkluZGV4ZXNbMF0gPT09IDAgJiZcbiAgICAgIC8vIHRyeWluZyB0byByZW1vdmUgZnJvbSBvdXRlciByaW5nXG4gICAgICBwb3NpdGlvbkluZGV4ZXNbMV0gPT09IDBcbiAgICApIHtcbiAgICAgIHRocm93IEVycm9yKFxuICAgICAgICBgQ2FuJ3QgcmVtb3ZlIHBvc2l0aW9uLiBNdWx0aVBvbHlnb24ncyBvdXRlciByaW5nIG11c3QgaGF2ZSBhdCBsZWFzdCBmb3VyIHBvc2l0aW9uc2BcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgaXNQb2x5Z29uYWwgPSBnZW9tZXRyeS50eXBlID09PSAnUG9seWdvbicgfHwgZ2VvbWV0cnkudHlwZSA9PT0gJ011bHRpUG9seWdvbic7XG4gICAgY29uc3QgdXBkYXRlZEdlb21ldHJ5OiBhbnkgPSB7XG4gICAgICAuLi5nZW9tZXRyeSxcbiAgICAgIGNvb3JkaW5hdGVzOiBpbW11dGFibHlSZW1vdmVQb3NpdGlvbihnZW9tZXRyeS5jb29yZGluYXRlcywgcG9zaXRpb25JbmRleGVzLCBpc1BvbHlnb25hbClcbiAgICB9O1xuXG4gICAgLy8gSGFuZGxlIGNhc2VzIHdoZXJlIGluY29tcGxldGUgZ2VvbWV0cmllcyBuZWVkIHBydW5lZCAoZS5nLiBob2xlcyB0aGF0IHdlcmUgdHJpYW5nbGVzKVxuICAgIHBydW5lR2VvbWV0cnlJZk5lY2Vzc2FyeSh1cGRhdGVkR2VvbWV0cnkpO1xuXG4gICAgcmV0dXJuIHRoaXMucmVwbGFjZUdlb21ldHJ5KGZlYXR1cmVJbmRleCwgdXBkYXRlZEdlb21ldHJ5KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGEgcG9zaXRpb24gZGVlcGx5IG5lc3RlZCBpbiBhIEdlb0pTT04gZ2VvbWV0cnkgY29vcmRpbmF0ZXMgYXJyYXkuXG4gICAqIFdvcmtzIHdpdGggTXVsdGlQb2ludCwgTGluZVN0cmluZywgTXVsdGlMaW5lU3RyaW5nLCBQb2x5Z29uLCBhbmQgTXVsdGlQb2x5Z29uLlxuICAgKlxuICAgKiBAcGFyYW0gZmVhdHVyZUluZGV4IFRoZSBpbmRleCBvZiB0aGUgZmVhdHVyZSB0byB1cGRhdGVcbiAgICogQHBhcmFtIHBvc2l0aW9uSW5kZXhlcyBBbiBhcnJheSBjb250YWluaW5nIHRoZSBpbmRleGVzIG9mIHRoZSBwb3NpdGlvbiB0aGF0IHdpbGwgcHJvY2VlZCB0aGUgbmV3IHBvc2l0aW9uXG4gICAqIEBwYXJhbSBwb3NpdGlvblRvQWRkIFRoZSBuZXcgcG9zaXRpb24gdG8gcGxhY2UgaW4gdGhlIHJlc3VsdCAoaS5lLiBbbG5nLCBsYXRdKVxuICAgKlxuICAgKiBAcmV0dXJucyBBIG5ldyBgSW1tdXRhYmxlRmVhdHVyZUNvbGxlY3Rpb25gIHdpdGggdGhlIGdpdmVuIGNvb3JkaW5hdGUgcmVtb3ZlZC4gRG9lcyBub3QgbW9kaWZ5IHRoaXMgYEltbXV0YWJsZUZlYXR1cmVDb2xsZWN0aW9uYC5cbiAgICovXG4gIGFkZFBvc2l0aW9uKFxuICAgIGZlYXR1cmVJbmRleDogbnVtYmVyLFxuICAgIHBvc2l0aW9uSW5kZXhlczogbnVtYmVyW10sXG4gICAgcG9zaXRpb25Ub0FkZDogUG9zaXRpb25cbiAgKTogSW1tdXRhYmxlRmVhdHVyZUNvbGxlY3Rpb24ge1xuICAgIGNvbnN0IGdlb21ldHJ5ID0gdGhpcy5mZWF0dXJlQ29sbGVjdGlvbi5mZWF0dXJlc1tmZWF0dXJlSW5kZXhdLmdlb21ldHJ5O1xuXG4gICAgaWYgKGdlb21ldHJ5LnR5cGUgPT09ICdQb2ludCcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVW5hYmxlIHRvIGFkZCBhIHBvc2l0aW9uIHRvIGEgUG9pbnQgZmVhdHVyZScpO1xuICAgIH1cblxuICAgIGNvbnN0IGlzUG9seWdvbmFsID0gZ2VvbWV0cnkudHlwZSA9PT0gJ1BvbHlnb24nIHx8IGdlb21ldHJ5LnR5cGUgPT09ICdNdWx0aVBvbHlnb24nO1xuICAgIGNvbnN0IHVwZGF0ZWRHZW9tZXRyeTogYW55ID0ge1xuICAgICAgLi4uZ2VvbWV0cnksXG4gICAgICBjb29yZGluYXRlczogaW1tdXRhYmx5QWRkUG9zaXRpb24oXG4gICAgICAgIGdlb21ldHJ5LmNvb3JkaW5hdGVzLFxuICAgICAgICBwb3NpdGlvbkluZGV4ZXMsXG4gICAgICAgIHBvc2l0aW9uVG9BZGQsXG4gICAgICAgIGlzUG9seWdvbmFsXG4gICAgICApXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLnJlcGxhY2VHZW9tZXRyeShmZWF0dXJlSW5kZXgsIHVwZGF0ZWRHZW9tZXRyeSk7XG4gIH1cblxuICByZXBsYWNlR2VvbWV0cnkoZmVhdHVyZUluZGV4OiBudW1iZXIsIGdlb21ldHJ5OiBHZW9tZXRyeSk6IEltbXV0YWJsZUZlYXR1cmVDb2xsZWN0aW9uIHtcbiAgICBjb25zdCB1cGRhdGVkRmVhdHVyZTogYW55ID0ge1xuICAgICAgLi4udGhpcy5mZWF0dXJlQ29sbGVjdGlvbi5mZWF0dXJlc1tmZWF0dXJlSW5kZXhdLFxuICAgICAgZ2VvbWV0cnlcbiAgICB9O1xuXG4gICAgY29uc3QgdXBkYXRlZEZlYXR1cmVDb2xsZWN0aW9uID0ge1xuICAgICAgLi4udGhpcy5mZWF0dXJlQ29sbGVjdGlvbixcbiAgICAgIGZlYXR1cmVzOiBbXG4gICAgICAgIC4uLnRoaXMuZmVhdHVyZUNvbGxlY3Rpb24uZmVhdHVyZXMuc2xpY2UoMCwgZmVhdHVyZUluZGV4KSxcbiAgICAgICAgdXBkYXRlZEZlYXR1cmUsXG4gICAgICAgIC4uLnRoaXMuZmVhdHVyZUNvbGxlY3Rpb24uZmVhdHVyZXMuc2xpY2UoZmVhdHVyZUluZGV4ICsgMSlcbiAgICAgIF1cbiAgICB9O1xuXG4gICAgcmV0dXJuIG5ldyBJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbih1cGRhdGVkRmVhdHVyZUNvbGxlY3Rpb24pO1xuICB9XG5cbiAgYWRkRmVhdHVyZShmZWF0dXJlOiBGZWF0dXJlKTogSW1tdXRhYmxlRmVhdHVyZUNvbGxlY3Rpb24ge1xuICAgIHJldHVybiB0aGlzLmFkZEZlYXR1cmVzKFtmZWF0dXJlXSk7XG4gIH1cblxuICBhZGRGZWF0dXJlcyhmZWF0dXJlczogRmVhdHVyZVtdKTogSW1tdXRhYmxlRmVhdHVyZUNvbGxlY3Rpb24ge1xuICAgIGNvbnN0IHVwZGF0ZWRGZWF0dXJlQ29sbGVjdGlvbiA9IHtcbiAgICAgIC4uLnRoaXMuZmVhdHVyZUNvbGxlY3Rpb24sXG4gICAgICBmZWF0dXJlczogWy4uLnRoaXMuZmVhdHVyZUNvbGxlY3Rpb24uZmVhdHVyZXMsIC4uLmZlYXR1cmVzXVxuICAgIH07XG5cbiAgICByZXR1cm4gbmV3IEltbXV0YWJsZUZlYXR1cmVDb2xsZWN0aW9uKHVwZGF0ZWRGZWF0dXJlQ29sbGVjdGlvbik7XG4gIH1cblxuICBkZWxldGVGZWF0dXJlKGZlYXR1cmVJbmRleDogbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMuZGVsZXRlRmVhdHVyZXMoW2ZlYXR1cmVJbmRleF0pO1xuICB9XG5cbiAgZGVsZXRlRmVhdHVyZXMoZmVhdHVyZUluZGV4ZXM6IG51bWJlcltdKSB7XG4gICAgY29uc3QgZmVhdHVyZXMgPSBbLi4udGhpcy5mZWF0dXJlQ29sbGVjdGlvbi5mZWF0dXJlc107XG4gICAgZmVhdHVyZUluZGV4ZXMuc29ydCgpO1xuICAgIGZvciAobGV0IGkgPSBmZWF0dXJlSW5kZXhlcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgY29uc3QgZmVhdHVyZUluZGV4ID0gZmVhdHVyZUluZGV4ZXNbaV07XG4gICAgICBpZiAoZmVhdHVyZUluZGV4ID49IDAgJiYgZmVhdHVyZUluZGV4IDwgZmVhdHVyZXMubGVuZ3RoKSB7XG4gICAgICAgIGZlYXR1cmVzLnNwbGljZShmZWF0dXJlSW5kZXgsIDEpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHVwZGF0ZWRGZWF0dXJlQ29sbGVjdGlvbiA9IHtcbiAgICAgIC4uLnRoaXMuZmVhdHVyZUNvbGxlY3Rpb24sXG4gICAgICBmZWF0dXJlc1xuICAgIH07XG5cbiAgICByZXR1cm4gbmV3IEltbXV0YWJsZUZlYXR1cmVDb2xsZWN0aW9uKHVwZGF0ZWRGZWF0dXJlQ29sbGVjdGlvbik7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0VXBkYXRlZFBvc2l0aW9uKHVwZGF0ZWRQb3NpdGlvbjogUG9zaXRpb24sIHByZXZpb3VzUG9zaXRpb246IFBvc2l0aW9uKTogUG9zaXRpb24ge1xuICAvLyBUaGlzIGZ1bmN0aW9uIGNoZWNrcyBpZiB0aGUgdXBkYXRlZFBvc2l0aW9uIGlzIG1pc3NpbmcgZWxldmF0aW9uXG4gIC8vIGFuZCBjb3BpZXMgaXQgZnJvbSBwcmV2aW91c1Bvc2l0aW9uXG4gIGlmICh1cGRhdGVkUG9zaXRpb24ubGVuZ3RoID09PSAyICYmIHByZXZpb3VzUG9zaXRpb24ubGVuZ3RoID09PSAzKSB7XG4gICAgY29uc3QgZWxldmF0aW9uID0gKHByZXZpb3VzUG9zaXRpb246IGFueSlbMl07XG4gICAgcmV0dXJuIFt1cGRhdGVkUG9zaXRpb25bMF0sIHVwZGF0ZWRQb3NpdGlvblsxXSwgZWxldmF0aW9uXTtcbiAgfVxuXG4gIHJldHVybiB1cGRhdGVkUG9zaXRpb247XG59XG5cbmZ1bmN0aW9uIGltbXV0YWJseVJlcGxhY2VQb3NpdGlvbihcbiAgY29vcmRpbmF0ZXM6IGFueSxcbiAgcG9zaXRpb25JbmRleGVzOiBudW1iZXJbXSxcbiAgdXBkYXRlZFBvc2l0aW9uOiBQb3NpdGlvbixcbiAgaXNQb2x5Z29uYWw6IGJvb2xlYW5cbik6IGFueSB7XG4gIGlmICghcG9zaXRpb25JbmRleGVzKSB7XG4gICAgcmV0dXJuIGNvb3JkaW5hdGVzO1xuICB9XG4gIGlmIChwb3NpdGlvbkluZGV4ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIGdldFVwZGF0ZWRQb3NpdGlvbih1cGRhdGVkUG9zaXRpb24sIGNvb3JkaW5hdGVzKTtcbiAgfVxuICBpZiAocG9zaXRpb25JbmRleGVzLmxlbmd0aCA9PT0gMSkge1xuICAgIGNvbnN0IHVwZGF0ZWQgPSBbXG4gICAgICAuLi5jb29yZGluYXRlcy5zbGljZSgwLCBwb3NpdGlvbkluZGV4ZXNbMF0pLFxuICAgICAgZ2V0VXBkYXRlZFBvc2l0aW9uKHVwZGF0ZWRQb3NpdGlvbiwgY29vcmRpbmF0ZXNbcG9zaXRpb25JbmRleGVzWzBdXSksXG4gICAgICAuLi5jb29yZGluYXRlcy5zbGljZShwb3NpdGlvbkluZGV4ZXNbMF0gKyAxKVxuICAgIF07XG5cbiAgICBpZiAoXG4gICAgICBpc1BvbHlnb25hbCAmJlxuICAgICAgKHBvc2l0aW9uSW5kZXhlc1swXSA9PT0gMCB8fCBwb3NpdGlvbkluZGV4ZXNbMF0gPT09IGNvb3JkaW5hdGVzLmxlbmd0aCAtIDEpXG4gICAgKSB7XG4gICAgICAvLyBmb3IgcG9seWdvbnMsIHRoZSBmaXJzdCBwb2ludCBpcyByZXBlYXRlZCBhdCB0aGUgZW5kIG9mIHRoZSBhcnJheVxuICAgICAgLy8gc28sIHVwZGF0ZSBpdCBvbiBib3RoIGVuZHMgb2YgdGhlIGFycmF5XG4gICAgICB1cGRhdGVkWzBdID0gZ2V0VXBkYXRlZFBvc2l0aW9uKHVwZGF0ZWRQb3NpdGlvbiwgY29vcmRpbmF0ZXNbMF0pO1xuICAgICAgdXBkYXRlZFtjb29yZGluYXRlcy5sZW5ndGggLSAxXSA9IGdldFVwZGF0ZWRQb3NpdGlvbih1cGRhdGVkUG9zaXRpb24sIGNvb3JkaW5hdGVzWzBdKTtcbiAgICB9XG4gICAgcmV0dXJuIHVwZGF0ZWQ7XG4gIH1cblxuICAvLyByZWN1cnNpdmVseSB1cGRhdGUgaW5uZXIgYXJyYXlcbiAgcmV0dXJuIFtcbiAgICAuLi5jb29yZGluYXRlcy5zbGljZSgwLCBwb3NpdGlvbkluZGV4ZXNbMF0pLFxuICAgIGltbXV0YWJseVJlcGxhY2VQb3NpdGlvbihcbiAgICAgIGNvb3JkaW5hdGVzW3Bvc2l0aW9uSW5kZXhlc1swXV0sXG4gICAgICBwb3NpdGlvbkluZGV4ZXMuc2xpY2UoMSwgcG9zaXRpb25JbmRleGVzLmxlbmd0aCksXG4gICAgICB1cGRhdGVkUG9zaXRpb24sXG4gICAgICBpc1BvbHlnb25hbFxuICAgICksXG4gICAgLi4uY29vcmRpbmF0ZXMuc2xpY2UocG9zaXRpb25JbmRleGVzWzBdICsgMSlcbiAgXTtcbn1cblxuZnVuY3Rpb24gaW1tdXRhYmx5UmVtb3ZlUG9zaXRpb24oXG4gIGNvb3JkaW5hdGVzOiBhbnksXG4gIHBvc2l0aW9uSW5kZXhlczogbnVtYmVyW10sXG4gIGlzUG9seWdvbmFsOiBib29sZWFuXG4pOiBhbnkge1xuICBpZiAoIXBvc2l0aW9uSW5kZXhlcykge1xuICAgIHJldHVybiBjb29yZGluYXRlcztcbiAgfVxuICBpZiAocG9zaXRpb25JbmRleGVzLmxlbmd0aCA9PT0gMCkge1xuICAgIHRocm93IEVycm9yKCdNdXN0IHNwZWNpZnkgdGhlIGluZGV4IG9mIHRoZSBwb3NpdGlvbiB0byByZW1vdmUnKTtcbiAgfVxuICBpZiAocG9zaXRpb25JbmRleGVzLmxlbmd0aCA9PT0gMSkge1xuICAgIGNvbnN0IHVwZGF0ZWQgPSBbXG4gICAgICAuLi5jb29yZGluYXRlcy5zbGljZSgwLCBwb3NpdGlvbkluZGV4ZXNbMF0pLFxuICAgICAgLi4uY29vcmRpbmF0ZXMuc2xpY2UocG9zaXRpb25JbmRleGVzWzBdICsgMSlcbiAgICBdO1xuXG4gICAgaWYgKFxuICAgICAgaXNQb2x5Z29uYWwgJiZcbiAgICAgIChwb3NpdGlvbkluZGV4ZXNbMF0gPT09IDAgfHwgcG9zaXRpb25JbmRleGVzWzBdID09PSBjb29yZGluYXRlcy5sZW5ndGggLSAxKVxuICAgICkge1xuICAgICAgLy8gZm9yIHBvbHlnb25zLCB0aGUgZmlyc3QgcG9pbnQgaXMgcmVwZWF0ZWQgYXQgdGhlIGVuZCBvZiB0aGUgYXJyYXlcbiAgICAgIC8vIHNvLCBpZiB0aGUgZmlyc3QvbGFzdCBjb29yZGluYXRlIGlzIHRvIGJlIHJlbW92ZWQsIGNvb3JkaW5hdGVzWzFdIHdpbGwgYmUgdGhlIG5ldyBmaXJzdC9sYXN0IGNvb3JkaW5hdGVcbiAgICAgIGlmIChwb3NpdGlvbkluZGV4ZXNbMF0gPT09IDApIHtcbiAgICAgICAgLy8gY2hhbmdlIHRoZSBsYXN0IHRvIGJlIHRoZSBzYW1lIGFzIHRoZSBmaXJzdFxuICAgICAgICB1cGRhdGVkW3VwZGF0ZWQubGVuZ3RoIC0gMV0gPSB1cGRhdGVkWzBdO1xuICAgICAgfSBlbHNlIGlmIChwb3NpdGlvbkluZGV4ZXNbMF0gPT09IGNvb3JkaW5hdGVzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgLy8gY2hhbmdlIHRoZSBmaXJzdCB0byBiZSB0aGUgc2FtZSBhcyB0aGUgbGFzdFxuICAgICAgICB1cGRhdGVkWzBdID0gdXBkYXRlZFt1cGRhdGVkLmxlbmd0aCAtIDFdO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdXBkYXRlZDtcbiAgfVxuXG4gIC8vIHJlY3Vyc2l2ZWx5IHVwZGF0ZSBpbm5lciBhcnJheVxuICByZXR1cm4gW1xuICAgIC4uLmNvb3JkaW5hdGVzLnNsaWNlKDAsIHBvc2l0aW9uSW5kZXhlc1swXSksXG4gICAgaW1tdXRhYmx5UmVtb3ZlUG9zaXRpb24oXG4gICAgICBjb29yZGluYXRlc1twb3NpdGlvbkluZGV4ZXNbMF1dLFxuICAgICAgcG9zaXRpb25JbmRleGVzLnNsaWNlKDEsIHBvc2l0aW9uSW5kZXhlcy5sZW5ndGgpLFxuICAgICAgaXNQb2x5Z29uYWxcbiAgICApLFxuICAgIC4uLmNvb3JkaW5hdGVzLnNsaWNlKHBvc2l0aW9uSW5kZXhlc1swXSArIDEpXG4gIF07XG59XG5cbmZ1bmN0aW9uIGltbXV0YWJseUFkZFBvc2l0aW9uKFxuICBjb29yZGluYXRlczogYW55LFxuICBwb3NpdGlvbkluZGV4ZXM6IG51bWJlcltdLFxuICBwb3NpdGlvblRvQWRkOiBQb3NpdGlvbixcbiAgaXNQb2x5Z29uYWw6IGJvb2xlYW5cbik6IGFueSB7XG4gIGlmICghcG9zaXRpb25JbmRleGVzKSB7XG4gICAgcmV0dXJuIGNvb3JkaW5hdGVzO1xuICB9XG4gIGlmIChwb3NpdGlvbkluZGV4ZXMubGVuZ3RoID09PSAwKSB7XG4gICAgdGhyb3cgRXJyb3IoJ011c3Qgc3BlY2lmeSB0aGUgaW5kZXggb2YgdGhlIHBvc2l0aW9uIHRvIHJlbW92ZScpO1xuICB9XG4gIGlmIChwb3NpdGlvbkluZGV4ZXMubGVuZ3RoID09PSAxKSB7XG4gICAgY29uc3QgdXBkYXRlZCA9IFtcbiAgICAgIC4uLmNvb3JkaW5hdGVzLnNsaWNlKDAsIHBvc2l0aW9uSW5kZXhlc1swXSksXG4gICAgICBwb3NpdGlvblRvQWRkLFxuICAgICAgLi4uY29vcmRpbmF0ZXMuc2xpY2UocG9zaXRpb25JbmRleGVzWzBdKVxuICAgIF07XG4gICAgcmV0dXJuIHVwZGF0ZWQ7XG4gIH1cblxuICAvLyByZWN1cnNpdmVseSB1cGRhdGUgaW5uZXIgYXJyYXlcbiAgcmV0dXJuIFtcbiAgICAuLi5jb29yZGluYXRlcy5zbGljZSgwLCBwb3NpdGlvbkluZGV4ZXNbMF0pLFxuICAgIGltbXV0YWJseUFkZFBvc2l0aW9uKFxuICAgICAgY29vcmRpbmF0ZXNbcG9zaXRpb25JbmRleGVzWzBdXSxcbiAgICAgIHBvc2l0aW9uSW5kZXhlcy5zbGljZSgxLCBwb3NpdGlvbkluZGV4ZXMubGVuZ3RoKSxcbiAgICAgIHBvc2l0aW9uVG9BZGQsXG4gICAgICBpc1BvbHlnb25hbFxuICAgICksXG4gICAgLi4uY29vcmRpbmF0ZXMuc2xpY2UocG9zaXRpb25JbmRleGVzWzBdICsgMSlcbiAgXTtcbn1cblxuZnVuY3Rpb24gcHJ1bmVHZW9tZXRyeUlmTmVjZXNzYXJ5KGdlb21ldHJ5OiBHZW9tZXRyeSkge1xuICBzd2l0Y2ggKGdlb21ldHJ5LnR5cGUpIHtcbiAgICBjYXNlICdQb2x5Z29uJzpcbiAgICAgIHBydW5lUG9seWdvbklmTmVjZXNzYXJ5KGdlb21ldHJ5KTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ011bHRpTGluZVN0cmluZyc6XG4gICAgICBwcnVuZU11bHRpTGluZVN0cmluZ0lmTmVjZXNzYXJ5KGdlb21ldHJ5KTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgJ011bHRpUG9seWdvbic6XG4gICAgICBwcnVuZU11bHRpUG9seWdvbklmTmVjZXNzYXJ5KGdlb21ldHJ5KTtcbiAgICAgIGJyZWFrO1xuICAgIGRlZmF1bHQ6XG4gICAgICAvLyBOb3QgZG93bmdyYWRhYmxlXG4gICAgICBicmVhaztcbiAgfVxufVxuXG5mdW5jdGlvbiBwcnVuZVBvbHlnb25JZk5lY2Vzc2FyeShnZW9tZXRyeTogUG9seWdvbikge1xuICBjb25zdCBwb2x5Z29uID0gZ2VvbWV0cnkuY29vcmRpbmF0ZXM7XG5cbiAgLy8gSWYgYW55IGhvbGUgaXMgbm8gbG9uZ2VyIGEgcG9seWdvbiwgcmVtb3ZlIHRoZSBob2xlIGVudGlyZWx5XG4gIGZvciAobGV0IGhvbGVJbmRleCA9IDE7IGhvbGVJbmRleCA8IHBvbHlnb24ubGVuZ3RoOyBob2xlSW5kZXgrKykge1xuICAgIGlmIChyZW1vdmVIb2xlSWZOZWNlc3NhcnkocG9seWdvbiwgaG9sZUluZGV4KSkge1xuICAgICAgLy8gSXQgd2FzIHJlbW92ZWQsIHNvIGtlZXAgdGhlIGluZGV4IHRoZSBzYW1lXG4gICAgICBob2xlSW5kZXgtLTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcHJ1bmVNdWx0aUxpbmVTdHJpbmdJZk5lY2Vzc2FyeShnZW9tZXRyeTogTXVsdGlMaW5lU3RyaW5nKSB7XG4gIGZvciAobGV0IGxpbmVTdHJpbmdJbmRleCA9IDA7IGxpbmVTdHJpbmdJbmRleCA8IGdlb21ldHJ5LmNvb3JkaW5hdGVzLmxlbmd0aDsgbGluZVN0cmluZ0luZGV4KyspIHtcbiAgICBjb25zdCBsaW5lU3RyaW5nID0gZ2VvbWV0cnkuY29vcmRpbmF0ZXNbbGluZVN0cmluZ0luZGV4XTtcbiAgICBpZiAobGluZVN0cmluZy5sZW5ndGggPT09IDEpIHtcbiAgICAgIC8vIE9ubHkgYSBzaW5nbGUgcG9zaXRpb24gbGVmdCBvbiB0aGlzIExpbmVTdHJpbmcsIHNvIHJlbW92ZSBpdCAoY2FuJ3QgaGF2ZSBQb2ludCBpbiBNdWx0aUxpbmVTdHJpbmcpXG4gICAgICBnZW9tZXRyeS5jb29yZGluYXRlcy5zcGxpY2UobGluZVN0cmluZ0luZGV4LCAxKTtcbiAgICAgIC8vIEtlZXAgdGhlIGluZGV4IHRoZSBzYW1lXG4gICAgICBsaW5lU3RyaW5nSW5kZXgtLTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcHJ1bmVNdWx0aVBvbHlnb25JZk5lY2Vzc2FyeShnZW9tZXRyeTogTXVsdGlQb2x5Z29uKSB7XG4gIGZvciAobGV0IHBvbHlnb25JbmRleCA9IDA7IHBvbHlnb25JbmRleCA8IGdlb21ldHJ5LmNvb3JkaW5hdGVzLmxlbmd0aDsgcG9seWdvbkluZGV4KyspIHtcbiAgICBjb25zdCBwb2x5Z29uID0gZ2VvbWV0cnkuY29vcmRpbmF0ZXNbcG9seWdvbkluZGV4XTtcbiAgICBjb25zdCBvdXRlclJpbmcgPSBwb2x5Z29uWzBdO1xuXG4gICAgLy8gSWYgdGhlIG91dGVyIHJpbmcgaXMgbm8gbG9uZ2VyIGEgcG9seWdvbiwgcmVtb3ZlIHRoZSB3aG9sZSBwb2x5Z29uXG4gICAgaWYgKG91dGVyUmluZy5sZW5ndGggPD0gMykge1xuICAgICAgZ2VvbWV0cnkuY29vcmRpbmF0ZXMuc3BsaWNlKHBvbHlnb25JbmRleCwgMSk7XG4gICAgICAvLyBJdCB3YXMgcmVtb3ZlZCwgc28ga2VlcCB0aGUgaW5kZXggdGhlIHNhbWVcbiAgICAgIHBvbHlnb25JbmRleC0tO1xuICAgIH1cblxuICAgIGZvciAobGV0IGhvbGVJbmRleCA9IDE7IGhvbGVJbmRleCA8IHBvbHlnb24ubGVuZ3RoOyBob2xlSW5kZXgrKykge1xuICAgICAgaWYgKHJlbW92ZUhvbGVJZk5lY2Vzc2FyeShwb2x5Z29uLCBob2xlSW5kZXgpKSB7XG4gICAgICAgIC8vIEl0IHdhcyByZW1vdmVkLCBzbyBrZWVwIHRoZSBpbmRleCB0aGUgc2FtZVxuICAgICAgICBob2xlSW5kZXgtLTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gcmVtb3ZlSG9sZUlmTmVjZXNzYXJ5KHBvbHlnb246IFBvbHlnb25Db29yZGluYXRlcywgaG9sZUluZGV4OiBudW1iZXIpIHtcbiAgY29uc3QgaG9sZSA9IHBvbHlnb25baG9sZUluZGV4XTtcbiAgaWYgKGhvbGUubGVuZ3RoIDw9IDMpIHtcbiAgICBwb2x5Z29uLnNwbGljZShob2xlSW5kZXgsIDEpO1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn1cbiJdfQ==