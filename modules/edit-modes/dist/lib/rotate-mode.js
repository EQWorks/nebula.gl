"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.RotateMode = void 0;

var _centroid = _interopRequireDefault(require("@turf/centroid"));

var _bearing = _interopRequireDefault(require("@turf/bearing"));

var _transformRotate = _interopRequireDefault(require("@turf/transform-rotate"));

var _geojsonEditMode = require("./geojson-edit-mode.js");

var _immutableFeatureCollection = require("./immutable-feature-collection.js");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class RotateMode extends _geojsonEditMode.BaseGeoJsonEditMode {
  constructor() {
    super(...arguments);

    _defineProperty(this, "_isRotatable", void 0);

    _defineProperty(this, "_geometryBeingRotated", void 0);
  }

  handlePointerMoveAdapter(event, props) {
    var editAction = null;
    this._isRotatable = Boolean(this._geometryBeingRotated) || this.isSelectionPicked(event.picks, props);

    if (!this._isRotatable || !event.pointerDownMapCoords) {
      // Nothing to do
      return {
        editAction: null,
        cancelMapPan: false
      };
    }

    if (event.isDragging && this._geometryBeingRotated) {
      // Rotate the geometry
      editAction = this.getRotateAction(event.pointerDownMapCoords, event.mapCoords, 'rotating', props);
    }

    return {
      editAction: editAction,
      cancelMapPan: true
    };
  }

  handleStartDraggingAdapter(event, props) {
    if (!this._isRotatable) {
      return null;
    }

    this._geometryBeingRotated = this.getSelectedFeaturesAsFeatureCollection(props);
    return null;
  }

  handleStopDraggingAdapter(event, props) {
    var editAction = null;

    if (this._geometryBeingRotated) {
      // Rotate the geometry
      editAction = this.getRotateAction(event.pointerDownMapCoords, event.mapCoords, 'rotated', props);
      this._geometryBeingRotated = null;
    }

    return editAction;
  }

  getCursorAdapter() {
    if (this._isRotatable) {
      // TODO: look at doing SVG cursors to get a better "rotate" cursor
      return 'move';
    }

    return null;
  }

  getRotateAction(startDragPoint, currentPoint, editType, props) {
    var startPosition = startDragPoint;
    var centroid = (0, _centroid.default)(this._geometryBeingRotated);
    var angle = getRotationAngle(centroid, startPosition, currentPoint);
    var rotatedFeatures = (0, _transformRotate.default)(this._geometryBeingRotated, angle);
    var updatedData = new _immutableFeatureCollection.ImmutableFeatureCollection(props.data);
    var selectedIndexes = props.selectedIndexes;

    for (var i = 0; i < selectedIndexes.length; i++) {
      var selectedIndex = selectedIndexes[i];
      var movedFeature = rotatedFeatures.features[i];
      updatedData = updatedData.replaceGeometry(selectedIndex, movedFeature.geometry);
    }

    return {
      updatedData: updatedData.getObject(),
      editType: editType,
      editContext: {
        featureIndexes: selectedIndexes
      }
    };
  }

}

exports.RotateMode = RotateMode;

function getRotationAngle(centroid, startDragPoint, currentPoint) {
  var bearing1 = (0, _bearing.default)(centroid, startDragPoint);
  var bearing2 = (0, _bearing.default)(centroid, currentPoint);
  return bearing2 - bearing1;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvcm90YXRlLW1vZGUuanMiXSwibmFtZXMiOlsiUm90YXRlTW9kZSIsIkJhc2VHZW9Kc29uRWRpdE1vZGUiLCJoYW5kbGVQb2ludGVyTW92ZUFkYXB0ZXIiLCJldmVudCIsInByb3BzIiwiZWRpdEFjdGlvbiIsIl9pc1JvdGF0YWJsZSIsIkJvb2xlYW4iLCJfZ2VvbWV0cnlCZWluZ1JvdGF0ZWQiLCJpc1NlbGVjdGlvblBpY2tlZCIsInBpY2tzIiwicG9pbnRlckRvd25NYXBDb29yZHMiLCJjYW5jZWxNYXBQYW4iLCJpc0RyYWdnaW5nIiwiZ2V0Um90YXRlQWN0aW9uIiwibWFwQ29vcmRzIiwiaGFuZGxlU3RhcnREcmFnZ2luZ0FkYXB0ZXIiLCJnZXRTZWxlY3RlZEZlYXR1cmVzQXNGZWF0dXJlQ29sbGVjdGlvbiIsImhhbmRsZVN0b3BEcmFnZ2luZ0FkYXB0ZXIiLCJnZXRDdXJzb3JBZGFwdGVyIiwic3RhcnREcmFnUG9pbnQiLCJjdXJyZW50UG9pbnQiLCJlZGl0VHlwZSIsInN0YXJ0UG9zaXRpb24iLCJjZW50cm9pZCIsImFuZ2xlIiwiZ2V0Um90YXRpb25BbmdsZSIsInJvdGF0ZWRGZWF0dXJlcyIsInVwZGF0ZWREYXRhIiwiSW1tdXRhYmxlRmVhdHVyZUNvbGxlY3Rpb24iLCJkYXRhIiwic2VsZWN0ZWRJbmRleGVzIiwiaSIsImxlbmd0aCIsInNlbGVjdGVkSW5kZXgiLCJtb3ZlZEZlYXR1cmUiLCJmZWF0dXJlcyIsInJlcGxhY2VHZW9tZXRyeSIsImdlb21ldHJ5IiwiZ2V0T2JqZWN0IiwiZWRpdENvbnRleHQiLCJmZWF0dXJlSW5kZXhlcyIsImJlYXJpbmcxIiwiYmVhcmluZzIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFRQTs7QUFDQTs7Ozs7O0FBRU8sTUFBTUEsVUFBTixTQUF5QkMsb0NBQXpCLENBQTZDO0FBQUE7QUFBQTs7QUFBQTs7QUFBQTtBQUFBOztBQUlsREMsRUFBQUEsd0JBQXdC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QUFBLFdBQVcsRUFBRUEsV0FBVyxDQUFDVyxTQUFaLEVBRFI7QUFFTGpCLE1BQUFBLFFBQVEsRUFBUkEsUUFGSztBQUdMa0IsTUFBQUEsV0FBVyxFQUFFO0FBQ1hDLFFBQUFBLGNBQWMsRUFBRVY7QUFETDtBQUhSLEtBQVA7QUFPRDs7QUFuR2lEOzs7O0FBc0dwRCxTQUFTTCxnQkFBVCxDQUEwQkYsUUFBMUIsRUFBOENKLGNBQTlDLEVBQXdFQyxZQUF4RSxFQUFnRztBQUM5RixNQUFNcUIsUUFBUSxHQUFHLHNCQUFZbEIsUUFBWixFQUFzQkosY0FBdEIsQ0FBakI7QUFDQSxNQUFNdUIsUUFBUSxHQUFHLHNCQUFZbkIsUUFBWixFQUFzQkgsWUFBdEIsQ0FBakI7QUFDQSxTQUFPc0IsUUFBUSxHQUFHRCxRQUFsQjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IHR1cmZDZW50cm9pZCBmcm9tICdAdHVyZi9jZW50cm9pZCc7XG5pbXBvcnQgdHVyZkJlYXJpbmcgZnJvbSAnQHR1cmYvYmVhcmluZyc7XG5pbXBvcnQgdHVyZlRyYW5zZm9ybVJvdGF0ZSBmcm9tICdAdHVyZi90cmFuc2Zvcm0tcm90YXRlJztcbmltcG9ydCB0eXBlIHtcbiAgUG9pbnRlck1vdmVFdmVudCxcbiAgU3RhcnREcmFnZ2luZ0V2ZW50LFxuICBTdG9wRHJhZ2dpbmdFdmVudCxcbiAgTW9kZVByb3BzXG59IGZyb20gJy4uL3R5cGVzLmpzJztcbmltcG9ydCB0eXBlIHsgRmVhdHVyZUNvbGxlY3Rpb24sIFBvc2l0aW9uIH0gZnJvbSAnLi4vZ2VvanNvbi10eXBlcy5qcyc7XG5pbXBvcnQgeyBCYXNlR2VvSnNvbkVkaXRNb2RlLCB0eXBlIEdlb0pzb25FZGl0QWN0aW9uIH0gZnJvbSAnLi9nZW9qc29uLWVkaXQtbW9kZS5qcyc7XG5pbXBvcnQgeyBJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbiB9IGZyb20gJy4vaW1tdXRhYmxlLWZlYXR1cmUtY29sbGVjdGlvbi5qcyc7XG5cbmV4cG9ydCBjbGFzcyBSb3RhdGVNb2RlIGV4dGVuZHMgQmFzZUdlb0pzb25FZGl0TW9kZSB7XG4gIF9pc1JvdGF0YWJsZTogYm9vbGVhbjtcbiAgX2dlb21ldHJ5QmVpbmdSb3RhdGVkOiA/RmVhdHVyZUNvbGxlY3Rpb247XG5cbiAgaGFuZGxlUG9pbnRlck1vdmVBZGFwdGVyKFxuICAgIGV2ZW50OiBQb2ludGVyTW92ZUV2ZW50LFxuICAgIHByb3BzOiBNb2RlUHJvcHM8RmVhdHVyZUNvbGxlY3Rpb24+XG4gICk6IHsgZWRpdEFjdGlvbjogP0dlb0pzb25FZGl0QWN0aW9uLCBjYW5jZWxNYXBQYW46IGJvb2xlYW4gfSB7XG4gICAgbGV0IGVkaXRBY3Rpb246ID9HZW9Kc29uRWRpdEFjdGlvbiA9IG51bGw7XG5cbiAgICB0aGlzLl9pc1JvdGF0YWJsZSA9XG4gICAgICBCb29sZWFuKHRoaXMuX2dlb21ldHJ5QmVpbmdSb3RhdGVkKSB8fCB0aGlzLmlzU2VsZWN0aW9uUGlja2VkKGV2ZW50LnBpY2tzLCBwcm9wcyk7XG5cbiAgICBpZiAoIXRoaXMuX2lzUm90YXRhYmxlIHx8ICFldmVudC5wb2ludGVyRG93bk1hcENvb3Jkcykge1xuICAgICAgLy8gTm90aGluZyB0byBkb1xuICAgICAgcmV0dXJuIHsgZWRpdEFjdGlvbjogbnVsbCwgY2FuY2VsTWFwUGFuOiBmYWxzZSB9O1xuICAgIH1cblxuICAgIGlmIChldmVudC5pc0RyYWdnaW5nICYmIHRoaXMuX2dlb21ldHJ5QmVpbmdSb3RhdGVkKSB7XG4gICAgICAvLyBSb3RhdGUgdGhlIGdlb21ldHJ5XG4gICAgICBlZGl0QWN0aW9uID0gdGhpcy5nZXRSb3RhdGVBY3Rpb24oXG4gICAgICAgIGV2ZW50LnBvaW50ZXJEb3duTWFwQ29vcmRzLFxuICAgICAgICBldmVudC5tYXBDb29yZHMsXG4gICAgICAgICdyb3RhdGluZycsXG4gICAgICAgIHByb3BzXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB7IGVkaXRBY3Rpb24sIGNhbmNlbE1hcFBhbjogdHJ1ZSB9O1xuICB9XG5cbiAgaGFuZGxlU3RhcnREcmFnZ2luZ0FkYXB0ZXIoXG4gICAgZXZlbnQ6IFN0YXJ0RHJhZ2dpbmdFdmVudCxcbiAgICBwcm9wczogTW9kZVByb3BzPEZlYXR1cmVDb2xsZWN0aW9uPlxuICApOiA/R2VvSnNvbkVkaXRBY3Rpb24ge1xuICAgIGlmICghdGhpcy5faXNSb3RhdGFibGUpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHRoaXMuX2dlb21ldHJ5QmVpbmdSb3RhdGVkID0gdGhpcy5nZXRTZWxlY3RlZEZlYXR1cmVzQXNGZWF0dXJlQ29sbGVjdGlvbihwcm9wcyk7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBoYW5kbGVTdG9wRHJhZ2dpbmdBZGFwdGVyKFxuICAgIGV2ZW50OiBTdG9wRHJhZ2dpbmdFdmVudCxcbiAgICBwcm9wczogTW9kZVByb3BzPEZlYXR1cmVDb2xsZWN0aW9uPlxuICApOiA/R2VvSnNvbkVkaXRBY3Rpb24ge1xuICAgIGxldCBlZGl0QWN0aW9uOiA/R2VvSnNvbkVkaXRBY3Rpb24gPSBudWxsO1xuXG4gICAgaWYgKHRoaXMuX2dlb21ldHJ5QmVpbmdSb3RhdGVkKSB7XG4gICAgICAvLyBSb3RhdGUgdGhlIGdlb21ldHJ5XG4gICAgICBlZGl0QWN0aW9uID0gdGhpcy5nZXRSb3RhdGVBY3Rpb24oXG4gICAgICAgIGV2ZW50LnBvaW50ZXJEb3duTWFwQ29vcmRzLFxuICAgICAgICBldmVudC5tYXBDb29yZHMsXG4gICAgICAgICdyb3RhdGVkJyxcbiAgICAgICAgcHJvcHNcbiAgICAgICk7XG4gICAgICB0aGlzLl9nZW9tZXRyeUJlaW5nUm90YXRlZCA9IG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIGVkaXRBY3Rpb247XG4gIH1cblxuICBnZXRDdXJzb3JBZGFwdGVyKCk6ID9zdHJpbmcge1xuICAgIGlmICh0aGlzLl9pc1JvdGF0YWJsZSkge1xuICAgICAgLy8gVE9ETzogbG9vayBhdCBkb2luZyBTVkcgY3Vyc29ycyB0byBnZXQgYSBiZXR0ZXIgXCJyb3RhdGVcIiBjdXJzb3JcbiAgICAgIHJldHVybiAnbW92ZSc7XG4gICAgfVxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgZ2V0Um90YXRlQWN0aW9uKFxuICAgIHN0YXJ0RHJhZ1BvaW50OiBQb3NpdGlvbixcbiAgICBjdXJyZW50UG9pbnQ6IFBvc2l0aW9uLFxuICAgIGVkaXRUeXBlOiBzdHJpbmcsXG4gICAgcHJvcHM6IE1vZGVQcm9wczxGZWF0dXJlQ29sbGVjdGlvbj5cbiAgKTogR2VvSnNvbkVkaXRBY3Rpb24ge1xuICAgIGNvbnN0IHN0YXJ0UG9zaXRpb24gPSBzdGFydERyYWdQb2ludDtcbiAgICBjb25zdCBjZW50cm9pZCA9IHR1cmZDZW50cm9pZCh0aGlzLl9nZW9tZXRyeUJlaW5nUm90YXRlZCk7XG4gICAgY29uc3QgYW5nbGUgPSBnZXRSb3RhdGlvbkFuZ2xlKGNlbnRyb2lkLCBzdGFydFBvc2l0aW9uLCBjdXJyZW50UG9pbnQpO1xuXG4gICAgY29uc3Qgcm90YXRlZEZlYXR1cmVzID0gdHVyZlRyYW5zZm9ybVJvdGF0ZSh0aGlzLl9nZW9tZXRyeUJlaW5nUm90YXRlZCwgYW5nbGUpO1xuXG4gICAgbGV0IHVwZGF0ZWREYXRhID0gbmV3IEltbXV0YWJsZUZlYXR1cmVDb2xsZWN0aW9uKHByb3BzLmRhdGEpO1xuXG4gICAgY29uc3Qgc2VsZWN0ZWRJbmRleGVzID0gcHJvcHMuc2VsZWN0ZWRJbmRleGVzO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2VsZWN0ZWRJbmRleGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCBzZWxlY3RlZEluZGV4ID0gc2VsZWN0ZWRJbmRleGVzW2ldO1xuICAgICAgY29uc3QgbW92ZWRGZWF0dXJlID0gcm90YXRlZEZlYXR1cmVzLmZlYXR1cmVzW2ldO1xuICAgICAgdXBkYXRlZERhdGEgPSB1cGRhdGVkRGF0YS5yZXBsYWNlR2VvbWV0cnkoc2VsZWN0ZWRJbmRleCwgbW92ZWRGZWF0dXJlLmdlb21ldHJ5KTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgdXBkYXRlZERhdGE6IHVwZGF0ZWREYXRhLmdldE9iamVjdCgpLFxuICAgICAgZWRpdFR5cGUsXG4gICAgICBlZGl0Q29udGV4dDoge1xuICAgICAgICBmZWF0dXJlSW5kZXhlczogc2VsZWN0ZWRJbmRleGVzXG4gICAgICB9XG4gICAgfTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRSb3RhdGlvbkFuZ2xlKGNlbnRyb2lkOiBQb3NpdGlvbiwgc3RhcnREcmFnUG9pbnQ6IFBvc2l0aW9uLCBjdXJyZW50UG9pbnQ6IFBvc2l0aW9uKSB7XG4gIGNvbnN0IGJlYXJpbmcxID0gdHVyZkJlYXJpbmcoY2VudHJvaWQsIHN0YXJ0RHJhZ1BvaW50KTtcbiAgY29uc3QgYmVhcmluZzIgPSB0dXJmQmVhcmluZyhjZW50cm9pZCwgY3VycmVudFBvaW50KTtcbiAgcmV0dXJuIGJlYXJpbmcyIC0gYmVhcmluZzE7XG59XG4iXX0=