"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.RotateHandler = void 0;

var _centroid = _interopRequireDefault(require("@turf/centroid"));

var _bearing = _interopRequireDefault(require("@turf/bearing"));

var _transformRotate = _interopRequireDefault(require("@turf/transform-rotate"));

var _modeHandler = require("./mode-handler.js");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

// TODO edit-modes: delete handlers once EditMode fully implemented
class RotateHandler extends _modeHandler.ModeHandler {
  constructor() {
    super(...arguments);

    _defineProperty(this, "_isRotatable", void 0);

    _defineProperty(this, "_geometryBeingRotated", void 0);
  }

  handlePointerMove(event) {
    var editAction = null;
    this._isRotatable = Boolean(this._geometryBeingRotated) || this.isSelectionPicked(event.picks);

    if (!this._isRotatable || !event.pointerDownGroundCoords) {
      // Nothing to do
      return {
        editAction: null,
        cancelMapPan: false
      };
    }

    if (event.isDragging && this._geometryBeingRotated) {
      // Rotate the geometry
      editAction = this.getRotateAction(event.pointerDownGroundCoords, event.groundCoords, 'rotating');
    }

    return {
      editAction: editAction,
      cancelMapPan: true
    };
  }

  handleStartDragging(event) {
    if (!this._isRotatable) {
      return null;
    }

    this._geometryBeingRotated = this.getSelectedFeaturesAsFeatureCollection();
    return null;
  }

  handleStopDragging(event) {
    var editAction = null;

    if (this._geometryBeingRotated) {
      // Rotate the geometry
      editAction = this.getRotateAction(event.pointerDownGroundCoords, event.groundCoords, 'rotated');
      this._geometryBeingRotated = null;
    }

    return editAction;
  }

  getCursor(_ref) {
    var isDragging = _ref.isDragging;

    if (this._isRotatable) {
      // TODO: look at doing SVG cursors to get a better "rotate" cursor
      return 'move';
    }

    return isDragging ? 'grabbing' : 'grab';
  }

  getRotateAction(startDragPoint, currentPoint, editType) {
    var startPosition = startDragPoint;
    var centroid = (0, _centroid.default)(this._geometryBeingRotated);
    var angle = getRotationAngle(centroid, startPosition, currentPoint);
    var rotatedFeatures = (0, _transformRotate.default)(this._geometryBeingRotated, angle);
    var updatedData = this.getImmutableFeatureCollection();
    var selectedIndexes = this.getSelectedFeatureIndexes();

    for (var i = 0; i < selectedIndexes.length; i++) {
      var selectedIndex = selectedIndexes[i];
      var movedFeature = rotatedFeatures.features[i];
      updatedData = updatedData.replaceGeometry(selectedIndex, movedFeature.geometry);
    }

    return {
      updatedData: updatedData.getObject(),
      editType: editType,
      featureIndexes: selectedIndexes,
      editContext: null
    };
  }

}

exports.RotateHandler = RotateHandler;

function getRotationAngle(centroid, startDragPoint, currentPoint) {
  var bearing1 = (0, _bearing.default)(centroid, startDragPoint);
  var bearing2 = (0, _bearing.default)(centroid, currentPoint);
  return bearing2 - bearing1;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tb2RlLWhhbmRsZXJzL3JvdGF0ZS1oYW5kbGVyLmpzIl0sIm5hbWVzIjpbIlJvdGF0ZUhhbmRsZXIiLCJNb2RlSGFuZGxlciIsImhhbmRsZVBvaW50ZXJNb3ZlIiwiZXZlbnQiLCJlZGl0QWN0aW9uIiwiX2lzUm90YXRhYmxlIiwiQm9vbGVhbiIsIl9nZW9tZXRyeUJlaW5nUm90YXRlZCIsImlzU2VsZWN0aW9uUGlja2VkIiwicGlja3MiLCJwb2ludGVyRG93bkdyb3VuZENvb3JkcyIsImNhbmNlbE1hcFBhbiIsImlzRHJhZ2dpbmciLCJnZXRSb3RhdGVBY3Rpb24iLCJncm91bmRDb29yZHMiLCJoYW5kbGVTdGFydERyYWdnaW5nIiwiZ2V0U2VsZWN0ZWRGZWF0dXJlc0FzRmVhdHVyZUNvbGxlY3Rpb24iLCJoYW5kbGVTdG9wRHJhZ2dpbmciLCJnZXRDdXJzb3IiLCJzdGFydERyYWdQb2ludCIsImN1cnJlbnRQb2ludCIsImVkaXRUeXBlIiwic3RhcnRQb3NpdGlvbiIsImNlbnRyb2lkIiwiYW5nbGUiLCJnZXRSb3RhdGlvbkFuZ2xlIiwicm90YXRlZEZlYXR1cmVzIiwidXBkYXRlZERhdGEiLCJnZXRJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbiIsInNlbGVjdGVkSW5kZXhlcyIsImdldFNlbGVjdGVkRmVhdHVyZUluZGV4ZXMiLCJpIiwibGVuZ3RoIiwic2VsZWN0ZWRJbmRleCIsIm1vdmVkRmVhdHVyZSIsImZlYXR1cmVzIiwicmVwbGFjZUdlb21ldHJ5IiwiZ2VvbWV0cnkiLCJnZXRPYmplY3QiLCJmZWF0dXJlSW5kZXhlcyIsImVkaXRDb250ZXh0IiwiYmVhcmluZzEiLCJiZWFyaW5nMiJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUlBOzs7Ozs7QUFFQTtBQUNPLE1BQU1BLGFBQU4sU0FBNEJDLHdCQUE1QixDQUF3QztBQUFBO0FBQUE7O0FBQUE7O0FBQUE7QUFBQTs7QUFJN0NDLEVBQUFBLGlCQUFp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LE1BQUFBLGNBQWMsRUFBRVYsZUFIWDtBQUlMVyxNQUFBQSxXQUFXLEVBQUU7QUFKUixLQUFQO0FBTUQ7O0FBakY0Qzs7OztBQW9GL0MsU0FBU2YsZ0JBQVQsQ0FBMEJGLFFBQTFCLEVBQThDSixjQUE5QyxFQUF3RUMsWUFBeEUsRUFBZ0c7QUFDOUYsTUFBTXFCLFFBQVEsR0FBRyxzQkFBWWxCLFFBQVosRUFBc0JKLGNBQXRCLENBQWpCO0FBQ0EsTUFBTXVCLFFBQVEsR0FBRyxzQkFBWW5CLFFBQVosRUFBc0JILFlBQXRCLENBQWpCO0FBQ0EsU0FBT3NCLFFBQVEsR0FBR0QsUUFBbEI7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG5cbmltcG9ydCB0dXJmQ2VudHJvaWQgZnJvbSAnQHR1cmYvY2VudHJvaWQnO1xuaW1wb3J0IHR1cmZCZWFyaW5nIGZyb20gJ0B0dXJmL2JlYXJpbmcnO1xuaW1wb3J0IHR1cmZUcmFuc2Zvcm1Sb3RhdGUgZnJvbSAnQHR1cmYvdHJhbnNmb3JtLXJvdGF0ZSc7XG5pbXBvcnQgdHlwZSB7IEZlYXR1cmVDb2xsZWN0aW9uLCBQb3NpdGlvbiB9IGZyb20gJ2tlcGxlci1vdXRkYXRlZC1uZWJ1bGEuZ2wtZWRpdC1tb2Rlcyc7XG5pbXBvcnQgdHlwZSB7IFBvaW50ZXJNb3ZlRXZlbnQsIFN0YXJ0RHJhZ2dpbmdFdmVudCwgU3RvcERyYWdnaW5nRXZlbnQgfSBmcm9tICcuLi9ldmVudC10eXBlcy5qcyc7XG5pbXBvcnQgdHlwZSB7IEVkaXRBY3Rpb24gfSBmcm9tICcuL21vZGUtaGFuZGxlci5qcyc7XG5pbXBvcnQgeyBNb2RlSGFuZGxlciB9IGZyb20gJy4vbW9kZS1oYW5kbGVyLmpzJztcblxuLy8gVE9ETyBlZGl0LW1vZGVzOiBkZWxldGUgaGFuZGxlcnMgb25jZSBFZGl0TW9kZSBmdWxseSBpbXBsZW1lbnRlZFxuZXhwb3J0IGNsYXNzIFJvdGF0ZUhhbmRsZXIgZXh0ZW5kcyBNb2RlSGFuZGxlciB7XG4gIF9pc1JvdGF0YWJsZTogYm9vbGVhbjtcbiAgX2dlb21ldHJ5QmVpbmdSb3RhdGVkOiA/RmVhdHVyZUNvbGxlY3Rpb247XG5cbiAgaGFuZGxlUG9pbnRlck1vdmUoZXZlbnQ6IFBvaW50ZXJNb3ZlRXZlbnQpOiB7IGVkaXRBY3Rpb246ID9FZGl0QWN0aW9uLCBjYW5jZWxNYXBQYW46IGJvb2xlYW4gfSB7XG4gICAgbGV0IGVkaXRBY3Rpb246ID9FZGl0QWN0aW9uID0gbnVsbDtcblxuICAgIHRoaXMuX2lzUm90YXRhYmxlID0gQm9vbGVhbih0aGlzLl9nZW9tZXRyeUJlaW5nUm90YXRlZCkgfHwgdGhpcy5pc1NlbGVjdGlvblBpY2tlZChldmVudC5waWNrcyk7XG5cbiAgICBpZiAoIXRoaXMuX2lzUm90YXRhYmxlIHx8ICFldmVudC5wb2ludGVyRG93bkdyb3VuZENvb3Jkcykge1xuICAgICAgLy8gTm90aGluZyB0byBkb1xuICAgICAgcmV0dXJuIHsgZWRpdEFjdGlvbjogbnVsbCwgY2FuY2VsTWFwUGFuOiBmYWxzZSB9O1xuICAgIH1cblxuICAgIGlmIChldmVudC5pc0RyYWdnaW5nICYmIHRoaXMuX2dlb21ldHJ5QmVpbmdSb3RhdGVkKSB7XG4gICAgICAvLyBSb3RhdGUgdGhlIGdlb21ldHJ5XG4gICAgICBlZGl0QWN0aW9uID0gdGhpcy5nZXRSb3RhdGVBY3Rpb24oXG4gICAgICAgIGV2ZW50LnBvaW50ZXJEb3duR3JvdW5kQ29vcmRzLFxuICAgICAgICBldmVudC5ncm91bmRDb29yZHMsXG4gICAgICAgICdyb3RhdGluZydcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgZWRpdEFjdGlvbiwgY2FuY2VsTWFwUGFuOiB0cnVlIH07XG4gIH1cblxuICBoYW5kbGVTdGFydERyYWdnaW5nKGV2ZW50OiBTdGFydERyYWdnaW5nRXZlbnQpOiA/RWRpdEFjdGlvbiB7XG4gICAgaWYgKCF0aGlzLl9pc1JvdGF0YWJsZSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgdGhpcy5fZ2VvbWV0cnlCZWluZ1JvdGF0ZWQgPSB0aGlzLmdldFNlbGVjdGVkRmVhdHVyZXNBc0ZlYXR1cmVDb2xsZWN0aW9uKCk7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBoYW5kbGVTdG9wRHJhZ2dpbmcoZXZlbnQ6IFN0b3BEcmFnZ2luZ0V2ZW50KTogP0VkaXRBY3Rpb24ge1xuICAgIGxldCBlZGl0QWN0aW9uOiA/RWRpdEFjdGlvbiA9IG51bGw7XG5cbiAgICBpZiAodGhpcy5fZ2VvbWV0cnlCZWluZ1JvdGF0ZWQpIHtcbiAgICAgIC8vIFJvdGF0ZSB0aGUgZ2VvbWV0cnlcbiAgICAgIGVkaXRBY3Rpb24gPSB0aGlzLmdldFJvdGF0ZUFjdGlvbihcbiAgICAgICAgZXZlbnQucG9pbnRlckRvd25Hcm91bmRDb29yZHMsXG4gICAgICAgIGV2ZW50Lmdyb3VuZENvb3JkcyxcbiAgICAgICAgJ3JvdGF0ZWQnXG4gICAgICApO1xuICAgICAgdGhpcy5fZ2VvbWV0cnlCZWluZ1JvdGF0ZWQgPSBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiBlZGl0QWN0aW9uO1xuICB9XG5cbiAgZ2V0Q3Vyc29yKHsgaXNEcmFnZ2luZyB9OiB7IGlzRHJhZ2dpbmc6IGJvb2xlYW4gfSk6IHN0cmluZyB7XG4gICAgaWYgKHRoaXMuX2lzUm90YXRhYmxlKSB7XG4gICAgICAvLyBUT0RPOiBsb29rIGF0IGRvaW5nIFNWRyBjdXJzb3JzIHRvIGdldCBhIGJldHRlciBcInJvdGF0ZVwiIGN1cnNvclxuICAgICAgcmV0dXJuICdtb3ZlJztcbiAgICB9XG4gICAgcmV0dXJuIGlzRHJhZ2dpbmcgPyAnZ3JhYmJpbmcnIDogJ2dyYWInO1xuICB9XG5cbiAgZ2V0Um90YXRlQWN0aW9uKHN0YXJ0RHJhZ1BvaW50OiBQb3NpdGlvbiwgY3VycmVudFBvaW50OiBQb3NpdGlvbiwgZWRpdFR5cGU6IHN0cmluZyk6IEVkaXRBY3Rpb24ge1xuICAgIGNvbnN0IHN0YXJ0UG9zaXRpb24gPSBzdGFydERyYWdQb2ludDtcbiAgICBjb25zdCBjZW50cm9pZCA9IHR1cmZDZW50cm9pZCh0aGlzLl9nZW9tZXRyeUJlaW5nUm90YXRlZCk7XG4gICAgY29uc3QgYW5nbGUgPSBnZXRSb3RhdGlvbkFuZ2xlKGNlbnRyb2lkLCBzdGFydFBvc2l0aW9uLCBjdXJyZW50UG9pbnQpO1xuXG4gICAgY29uc3Qgcm90YXRlZEZlYXR1cmVzID0gdHVyZlRyYW5zZm9ybVJvdGF0ZSh0aGlzLl9nZW9tZXRyeUJlaW5nUm90YXRlZCwgYW5nbGUpO1xuXG4gICAgbGV0IHVwZGF0ZWREYXRhID0gdGhpcy5nZXRJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbigpO1xuXG4gICAgY29uc3Qgc2VsZWN0ZWRJbmRleGVzID0gdGhpcy5nZXRTZWxlY3RlZEZlYXR1cmVJbmRleGVzKCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWxlY3RlZEluZGV4ZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHNlbGVjdGVkSW5kZXggPSBzZWxlY3RlZEluZGV4ZXNbaV07XG4gICAgICBjb25zdCBtb3ZlZEZlYXR1cmUgPSByb3RhdGVkRmVhdHVyZXMuZmVhdHVyZXNbaV07XG4gICAgICB1cGRhdGVkRGF0YSA9IHVwZGF0ZWREYXRhLnJlcGxhY2VHZW9tZXRyeShzZWxlY3RlZEluZGV4LCBtb3ZlZEZlYXR1cmUuZ2VvbWV0cnkpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICB1cGRhdGVkRGF0YTogdXBkYXRlZERhdGEuZ2V0T2JqZWN0KCksXG4gICAgICBlZGl0VHlwZSxcbiAgICAgIGZlYXR1cmVJbmRleGVzOiBzZWxlY3RlZEluZGV4ZXMsXG4gICAgICBlZGl0Q29udGV4dDogbnVsbFxuICAgIH07XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0Um90YXRpb25BbmdsZShjZW50cm9pZDogUG9zaXRpb24sIHN0YXJ0RHJhZ1BvaW50OiBQb3NpdGlvbiwgY3VycmVudFBvaW50OiBQb3NpdGlvbikge1xuICBjb25zdCBiZWFyaW5nMSA9IHR1cmZCZWFyaW5nKGNlbnRyb2lkLCBzdGFydERyYWdQb2ludCk7XG4gIGNvbnN0IGJlYXJpbmcyID0gdHVyZkJlYXJpbmcoY2VudHJvaWQsIGN1cnJlbnRQb2ludCk7XG4gIHJldHVybiBiZWFyaW5nMiAtIGJlYXJpbmcxO1xufVxuIl19