"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _keplerOutdatedDeck = require("kepler-outdated-deck.gl-layers");

var _keplerOutdatedLuma = _interopRequireDefault(require("kepler-outdated-luma.gl-constants"));

var _keplerOutdatedLuma2 = require("kepler-outdated-luma.gl-core");

var _outline = _interopRequireDefault(require("../../shaderlib/outline/outline"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// TODO - this should be built into assembleShaders
function injectShaderCode(_ref) {
  var source = _ref.source,
      _ref$code = _ref.code,
      code = _ref$code === void 0 ? '' : _ref$code;
  var INJECT_CODE = /}[^{}]*$/;
  return source.replace(INJECT_CODE, code.concat('\n}\n'));
}

var VS_CODE = "  outline_setUV(gl_Position);\n  outline_setZLevel(instanceZLevel);\n";
var FS_CODE = "  gl_FragColor = outline_filterColor(gl_FragColor);\n";
var defaultProps = {
  getZLevel: {
    type: 'accessor',
    value: 0
  }
};

class PathOutlineLayer extends _keplerOutdatedDeck.PathLayer {
  // Override getShaders to inject the outline module
  getShaders() {
    var shaders = super.getShaders();
    return Object.assign({}, shaders, {
      modules: shaders.modules.concat([_outline.default]),
      vs: injectShaderCode({
        source: shaders.vs,
        code: VS_CODE
      }),
      fs: injectShaderCode({
        source: shaders.fs,
        code: FS_CODE
      })
    });
  }

  initializeState(context) {
    super.initializeState(context); // Create an outline "shadow" map
    // TODO - we should create a single outlineMap for all layers

    this.setState({
      outlineFramebuffer: new _keplerOutdatedLuma2.Framebuffer(context.gl),
      dummyTexture: new _keplerOutdatedLuma2.Texture2D(context.gl)
    }); // Create an attribute manager

    this.state.attributeManager.addInstanced({
      instanceZLevel: {
        size: 1,
        type: _keplerOutdatedLuma.default.UNSIGNED_BYTE,
        update: this.calculateZLevels,
        accessor: 'getZLevel'
      }
    });
  } // Override draw to add render module


  draw(_ref2) {
    var _ref2$moduleParameter = _ref2.moduleParameters,
        moduleParameters = _ref2$moduleParameter === void 0 ? {} : _ref2$moduleParameter,
        parameters = _ref2.parameters,
        uniforms = _ref2.uniforms,
        context = _ref2.context;
    // Need to calculate same uniforms as base layer
    var _this$props = this.props,
        rounded = _this$props.rounded,
        miterLimit = _this$props.miterLimit,
        widthScale = _this$props.widthScale,
        widthMinPixels = _this$props.widthMinPixels,
        widthMaxPixels = _this$props.widthMaxPixels,
        dashJustified = _this$props.dashJustified;
    uniforms = Object.assign({}, uniforms, {
      jointType: Number(rounded),
      alignMode: Number(dashJustified),
      widthScale: widthScale,
      miterLimit: miterLimit,
      widthMinPixels: widthMinPixels,
      widthMaxPixels: widthMaxPixels
    }); // Render the outline shadowmap (based on segment z orders)

    var _this$state = this.state,
        outlineFramebuffer = _this$state.outlineFramebuffer,
        dummyTexture = _this$state.dummyTexture;
    outlineFramebuffer.resize();
    outlineFramebuffer.clear({
      color: true,
      depth: true
    });
    this.state.model.updateModuleSettings({
      outlineEnabled: true,
      outlineRenderShadowmap: true,
      outlineShadowmap: dummyTexture
    });
    this.state.model.draw({
      uniforms: Object.assign({}, uniforms, {
        jointType: 0,
        widthScale: this.props.widthScale * 1.3
      }),
      parameters: {
        depthTest: false,
        // Biggest value needs to go into buffer
        blendEquation: _keplerOutdatedLuma.default.MAX
      },
      framebuffer: outlineFramebuffer
    }); // Now use the outline shadowmap to render the lines (with outlines)

    this.state.model.updateModuleSettings({
      outlineEnabled: true,
      outlineRenderShadowmap: false,
      outlineShadowmap: outlineFramebuffer
    });
    this.state.model.draw({
      uniforms: Object.assign({}, uniforms, {
        jointType: Number(rounded),
        widthScale: this.props.widthScale
      }),
      parameters: {
        depthTest: false
      }
    });
  }

  calculateZLevels(attribute) {
    var getZLevel = this.props.getZLevel;
    var pathTesselator = this.state.pathTesselator;
    attribute.value = pathTesselator._updateAttribute({
      target: attribute.value,
      size: 1,
      getValue: function getValue(object, index) {
        return [getZLevel(object, index) || 0];
      }
    });
  }

}

exports.default = PathOutlineLayer;
PathOutlineLayer.layerName = 'PathOutlineLayer';
PathOutlineLayer.defaultProps = defaultProps;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9sYXllcnMvcGF0aC1vdXRsaW5lLWxheWVyL3BhdGgtb3V0bGluZS1sYXllci5qcyJdLCJuYW1lcyI6WyJpbmplY3RTaGFkZXJDb2RlIiwic291cmNlIiwiY29kZSIsIklOSkVDVF9DT0RFIiwicmVwbGFjZSIsImNvbmNhdCIsIlZTX0NPREUiLCJGU19DT0RFIiwiZGVmYXVsdFByb3BzIiwiZ2V0WkxldmVsIiwidHlwZSIsInZhbHVlIiwiUGF0aE91dGxpbmVMYXllciIsIlBhdGhMYXllciIsImdldFNoYWRlcnMiLCJzaGFkZXJzIiwiT2JqZWN0IiwiYXNzaWduIiwibW9kdWxlcyIsIm91dGxpbmUiLCJ2cyIsImZzIiwiaW5pdGlhbGl6ZVN0YXRlIiwiY29udGV4dCIsInNldFN0YXRlIiwib3V0bGluZUZyYW1lYnVmZmVyIiwiRnJhbWVidWZmZXIiLCJnbCIsImR1bW15VGV4dHVyZSIsIlRleHR1cmUyRCIsInN0YXRlIiwiYXR0cmlidXRlTWFuYWdlciIsImFkZEluc3RhbmNlZCIsImluc3RhbmNlWkxldmVsIiwic2l6ZSIsIkdMIiwiVU5TSUdORURfQllURSIsInVwZGF0ZSIsImNhbGN1bGF0ZVpMZXZlbHMiLCJhY2Nlc3NvciIsImRyYXciLCJtb2R1bGVQYXJhbWV0ZXJzIiwicGFyYW1ldGVycyIsInVuaWZvcm1zIiwicHJvcHMiLCJyb3VuZGVkIiwibWl0ZXJMaW1pdCIsIndpZHRoU2NhbGUiLCJ3aWR0aE1pblBpeGVscyIsIndpZHRoTWF4UGl4ZWxzIiwiZGFzaEp1c3RpZmllZCIsImpvaW50VHlwZSIsIk51bWJlciIsImFsaWduTW9kZSIsInJlc2l6ZSIsImNsZWFyIiwiY29sb3IiLCJkZXB0aCIsIm1vZGVsIiwidXBkYXRlTW9kdWxlU2V0dGluZ3MiLCJvdXRsaW5lRW5hYmxlZCIsIm91dGxpbmVSZW5kZXJTaGFkb3dtYXAiLCJvdXRsaW5lU2hhZG93bWFwIiwiZGVwdGhUZXN0IiwiYmxlbmRFcXVhdGlvbiIsIk1BWCIsImZyYW1lYnVmZmVyIiwiYXR0cmlidXRlIiwicGF0aFRlc3NlbGF0b3IiLCJfdXBkYXRlQXR0cmlidXRlIiwidGFyZ2V0IiwiZ2V0VmFsdWUiLCJvYmplY3QiLCJpbmRleCIsImxheWVyTmFtZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBRUE7QUFDQSxTQUFTQSxnQkFBVCxPQUFpRDtBQUFBLE1BQXJCQyxNQUFxQixRQUFyQkEsTUFBcUI7QUFBQSx1QkFBYkMsSUFBYTtBQUFBLE1BQWJBLElBQWEsMEJBQU4sRUFBTTtBQUMvQyxNQUFNQyxXQUFXLEdBQUcsVUFBcEI7QUFDQSxTQUFPRixNQUFNLENBQUNHLE9BQVAsQ0FBZUQsV0FBZixFQUE0QkQsSUFBSSxDQUFDRyxNQUFMLENBQVksT0FBWixDQUE1QixDQUFQO0FBQ0Q7O0FBRUQsSUFBTUMsT0FBTywwRUFBYjtBQUtBLElBQU1DLE9BQU8sMERBQWI7QUFJQSxJQUFNQyxZQUFZLEdBQUc7QUFDbkJDLEVBQUFBLFNBQVMsRUFBRTtBQUFFQyxJQUFBQSxJQUFJLEVBQUUsVUFBUjtBQUFvQkMsSUFBQUEsS0FBSyxFQUFFO0FBQTNCO0FBRFEsQ0FBckI7O0FBSWUsTUFBTUMsZ0JBQU4sU0FBK0JDLDZCQUEvQixDQUF5QztBQUN0RDtBQUNBQyxFQUFBQSxVQUFVLEdBQUc7QUFDWCxRQUFNQyxPQUFPLEdBQUcsTUFBTUQsVUFBTixFQUFoQjtBQUNBLFdBQU9FLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0JGLE9BQWxCLEVBQTJCO0FBQ2hDRyxNQUFBQSxPQUFPLEVBQUVILE9BQU8sQ0FBQ0csT0FBUixDQUFnQmIsTUFBaEIsQ0FBdUIsQ0FBQ2MsZ0JBQUQsQ0FBdkIsQ0FEdUI7QUFFaENDLE1BQUFBLEVBQUUsRUFBRXBCLGdCQUFnQixDQUFDO0FBQUVDLFFBQUFBLE1BQU0sRUFBRWMsT0FBTyxDQUFDSyxFQUFsQjtBQUFzQmxCLFFBQUFBLElBQUksRUFBRUk7QUFBNUIsT0FBRCxDQUZZO0FBR2hDZSxNQUFB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Q3hELEtBRDhCO0FBRWhEdUIsTUFBQUEsSUFBSSxFQUFFLENBRjBDO0FBR2hEcUMsTUFBQUEsUUFBUSxFQUFFLGtCQUFDQyxNQUFELEVBQVNDLEtBQVQ7QUFBQSxlQUFtQixDQUFDaEUsU0FBUyxDQUFDK0QsTUFBRCxFQUFTQyxLQUFULENBQVQsSUFBNEIsQ0FBN0IsQ0FBbkI7QUFBQTtBQUhzQyxLQUFoQyxDQUFsQjtBQUtEOztBQXZHcUQ7OztBQTBHeEQ3RCxnQkFBZ0IsQ0FBQzhELFNBQWpCLEdBQTZCLGtCQUE3QjtBQUNBOUQsZ0JBQWdCLENBQUNKLFlBQWpCLEdBQWdDQSxZQUFoQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBhdGhMYXllciB9IGZyb20gJ2tlcGxlci1vdXRkYXRlZC1kZWNrLmdsLWxheWVycyc7XG5pbXBvcnQgR0wgZnJvbSAna2VwbGVyLW91dGRhdGVkLWx1bWEuZ2wtY29uc3RhbnRzJztcbmltcG9ydCB7IEZyYW1lYnVmZmVyLCBUZXh0dXJlMkQgfSBmcm9tICdrZXBsZXItb3V0ZGF0ZWQtbHVtYS5nbC1jb3JlJztcbmltcG9ydCBvdXRsaW5lIGZyb20gJy4uLy4uL3NoYWRlcmxpYi9vdXRsaW5lL291dGxpbmUnO1xuXG4vLyBUT0RPIC0gdGhpcyBzaG91bGQgYmUgYnVpbHQgaW50byBhc3NlbWJsZVNoYWRlcnNcbmZ1bmN0aW9uIGluamVjdFNoYWRlckNvZGUoeyBzb3VyY2UsIGNvZGUgPSAnJyB9KSB7XG4gIGNvbnN0IElOSkVDVF9DT0RFID0gL31bXnt9XSokLztcbiAgcmV0dXJuIHNvdXJjZS5yZXBsYWNlKElOSkVDVF9DT0RFLCBjb2RlLmNvbmNhdCgnXFxufVxcbicpKTtcbn1cblxuY29uc3QgVlNfQ09ERSA9IGBcXFxuICBvdXRsaW5lX3NldFVWKGdsX1Bvc2l0aW9uKTtcbiAgb3V0bGluZV9zZXRaTGV2ZWwoaW5zdGFuY2VaTGV2ZWwpO1xuYDtcblxuY29uc3QgRlNfQ09ERSA9IGBcXFxuICBnbF9GcmFnQ29sb3IgPSBvdXRsaW5lX2ZpbHRlckNvbG9yKGdsX0ZyYWdDb2xvcik7XG5gO1xuXG5jb25zdCBkZWZhdWx0UHJvcHMgPSB7XG4gIGdldFpMZXZlbDogeyB0eXBlOiAnYWNjZXNzb3InLCB2YWx1ZTogMCB9XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBQYXRoT3V0bGluZUxheWVyIGV4dGVuZHMgUGF0aExheWVyIHtcbiAgLy8gT3ZlcnJpZGUgZ2V0U2hhZGVycyB0byBpbmplY3QgdGhlIG91dGxpbmUgbW9kdWxlXG4gIGdldFNoYWRlcnMoKSB7XG4gICAgY29uc3Qgc2hhZGVycyA9IHN1cGVyLmdldFNoYWRlcnMoKTtcbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgc2hhZGVycywge1xuICAgICAgbW9kdWxlczogc2hhZGVycy5tb2R1bGVzLmNvbmNhdChbb3V0bGluZV0pLFxuICAgICAgdnM6IGluamVjdFNoYWRlckNvZGUoeyBzb3VyY2U6IHNoYWRlcnMudnMsIGNvZGU6IFZTX0NPREUgfSksXG4gICAgICBmczogaW5qZWN0U2hhZGVyQ29kZSh7IHNvdXJjZTogc2hhZGVycy5mcywgY29kZTogRlNfQ09ERSB9KVxuICAgIH0pO1xuICB9XG5cbiAgaW5pdGlhbGl6ZVN0YXRlKGNvbnRleHQpIHtcbiAgICBzdXBlci5pbml0aWFsaXplU3RhdGUoY29udGV4dCk7XG5cbiAgICAvLyBDcmVhdGUgYW4gb3V0bGluZSBcInNoYWRvd1wiIG1hcFxuICAgIC8vIFRPRE8gLSB3ZSBzaG91bGQgY3JlYXRlIGEgc2luZ2xlIG91dGxpbmVNYXAgZm9yIGFsbCBsYXllcnNcbiAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgIG91dGxpbmVGcmFtZWJ1ZmZlcjogbmV3IEZyYW1lYnVmZmVyKGNvbnRleHQuZ2wpLFxuICAgICAgZHVtbXlUZXh0dXJlOiBuZXcgVGV4dHVyZTJEKGNvbnRleHQuZ2wpXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgYW4gYXR0cmlidXRlIG1hbmFnZXJcbiAgICB0aGlzLnN0YXRlLmF0dHJpYnV0ZU1hbmFnZXIuYWRkSW5zdGFuY2VkKHtcbiAgICAgIGluc3RhbmNlWkxldmVsOiB7XG4gICAgICAgIHNpemU6IDEsXG4gICAgICAgIHR5cGU6IEdMLlVOU0lHTkVEX0JZVEUsXG4gICAgICAgIHVwZGF0ZTogdGhpcy5jYWxjdWxhdGVaTGV2ZWxzLFxuICAgICAgICBhY2Nlc3NvcjogJ2dldFpMZXZlbCdcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8vIE92ZXJyaWRlIGRyYXcgdG8gYWRkIHJlbmRlciBtb2R1bGVcbiAgZHJhdyh7IG1vZHVsZVBhcmFtZXRlcnMgPSB7fSwgcGFyYW1ldGVycywgdW5pZm9ybXMsIGNvbnRleHQgfSkge1xuICAgIC8vIE5lZWQgdG8gY2FsY3VsYXRlIHNhbWUgdW5pZm9ybXMgYXMgYmFzZSBsYXllclxuICAgIGNvbnN0IHtcbiAgICAgIHJvdW5kZWQsXG4gICAgICBtaXRlckxpbWl0LFxuICAgICAgd2lkdGhTY2FsZSxcbiAgICAgIHdpZHRoTWluUGl4ZWxzLFxuICAgICAgd2lkdGhNYXhQaXhlbHMsXG4gICAgICBkYXNoSnVzdGlmaWVkXG4gICAgfSA9IHRoaXMucHJvcHM7XG5cbiAgICB1bmlmb3JtcyA9IE9iamVjdC5hc3NpZ24oe30sIHVuaWZvcm1zLCB7XG4gICAgICBqb2ludFR5cGU6IE51bWJlcihyb3VuZGVkKSxcbiAgICAgIGFsaWduTW9kZTogTnVtYmVyKGRhc2hKdXN0aWZpZWQpLFxuICAgICAgd2lkdGhTY2FsZSxcbiAgICAgIG1pdGVyTGltaXQsXG4gICAgICB3aWR0aE1pblBpeGVscyxcbiAgICAgIHdpZHRoTWF4UGl4ZWxzXG4gICAgfSk7XG5cbiAgICAvLyBSZW5kZXIgdGhlIG91dGxpbmUgc2hhZG93bWFwIChiYXNlZCBvbiBzZWdtZW50IHogb3JkZXJzKVxuICAgIGNvbnN0IHsgb3V0bGluZUZyYW1lYnVmZmVyLCBkdW1teVRleHR1cmUgfSA9IHRoaXMuc3RhdGU7XG4gICAgb3V0bGluZUZyYW1lYnVmZmVyLnJlc2l6ZSgpO1xuICAgIG91dGxpbmVGcmFtZWJ1ZmZlci5jbGVhcih7IGNvbG9yOiB0cnVlLCBkZXB0aDogdHJ1ZSB9KTtcblxuICAgIHRoaXMuc3RhdGUubW9kZWwudXBkYXRlTW9kdWxlU2V0dGluZ3Moe1xuICAgICAgb3V0bGluZUVuYWJsZWQ6IHRydWUsXG4gICAgICBvdXRsaW5lUmVuZGVyU2hhZG93bWFwOiB0cnVlLFxuICAgICAgb3V0bGluZVNoYWRvd21hcDogZHVtbXlUZXh0dXJlXG4gICAgfSk7XG5cbiAgICB0aGlzLnN0YXRlLm1vZGVsLmRyYXcoe1xuICAgICAgdW5pZm9ybXM6IE9iamVjdC5hc3NpZ24oe30sIHVuaWZvcm1zLCB7XG4gICAgICAgIGpvaW50VHlwZTogMCxcbiAgICAgICAgd2lkdGhTY2FsZTogdGhpcy5wcm9wcy53aWR0aFNjYWxlICogMS4zXG4gICAgICB9KSxcbiAgICAgIHBhcmFtZXRlcnM6IHtcbiAgICAgICAgZGVwdGhUZXN0OiBmYWxzZSxcbiAgICAgICAgLy8gQmlnZ2VzdCB2YWx1ZSBuZWVkcyB0byBnbyBpbnRvIGJ1ZmZlclxuICAgICAgICBibGVuZEVxdWF0aW9uOiBHTC5NQVhcbiAgICAgIH0sXG4gICAgICBmcmFtZWJ1ZmZlcjogb3V0bGluZUZyYW1lYnVmZmVyXG4gICAgfSk7XG5cbiAgICAvLyBOb3cgdXNlIHRoZSBvdXRsaW5lIHNoYWRvd21hcCB0byByZW5kZXIgdGhlIGxpbmVzICh3aXRoIG91dGxpbmVzKVxuICAgIHRoaXMuc3RhdGUubW9kZWwudXBkYXRlTW9kdWxlU2V0dGluZ3Moe1xuICAgICAgb3V0bGluZUVuYWJsZWQ6IHRydWUsXG4gICAgICBvdXRsaW5lUmVuZGVyU2hhZG93bWFwOiBmYWxzZSxcbiAgICAgIG91dGxpbmVTaGFkb3dtYXA6IG91dGxpbmVGcmFtZWJ1ZmZlclxuICAgIH0pO1xuICAgIHRoaXMuc3RhdGUubW9kZWwuZHJhdyh7XG4gICAgICB1bmlmb3JtczogT2JqZWN0LmFzc2lnbih7fSwgdW5pZm9ybXMsIHtcbiAgICAgICAgam9pbnRUeXBlOiBOdW1iZXIocm91bmRlZCksXG4gICAgICAgIHdpZHRoU2NhbGU6IHRoaXMucHJvcHMud2lkdGhTY2FsZVxuICAgICAgfSksXG4gICAgICBwYXJhbWV0ZXJzOiB7XG4gICAgICAgIGRlcHRoVGVzdDogZmFsc2VcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGNhbGN1bGF0ZVpMZXZlbHMoYXR0cmlidXRlKSB7XG4gICAgY29uc3QgeyBnZXRaTGV2ZWwgfSA9IHRoaXMucHJvcHM7XG4gICAgY29uc3QgeyBwYXRoVGVzc2VsYXRvciB9ID0gdGhpcy5zdGF0ZTtcblxuICAgIGF0dHJpYnV0ZS52YWx1ZSA9IHBhdGhUZXNzZWxhdG9yLl91cGRhdGVBdHRyaWJ1dGUoe1xuICAgICAgdGFyZ2V0OiBhdHRyaWJ1dGUudmFsdWUsXG4gICAgICBzaXplOiAxLFxuICAgICAgZ2V0VmFsdWU6IChvYmplY3QsIGluZGV4KSA9PiBbZ2V0WkxldmVsKG9iamVjdCwgaW5kZXgpIHx8IDBdXG4gICAgfSk7XG4gIH1cbn1cblxuUGF0aE91dGxpbmVMYXllci5sYXllck5hbWUgPSAnUGF0aE91dGxpbmVMYXllcic7XG5QYXRoT3V0bGluZUxheWVyLmRlZmF1bHRQcm9wcyA9IGRlZmF1bHRQcm9wcztcbiJdfQ==