"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ScaleHandler = void 0;

var _centroid = _interopRequireDefault(require("@turf/centroid"));

var _distance = _interopRequireDefault(require("@turf/distance"));

var _transformScale = _interopRequireDefault(require("@turf/transform-scale"));

var _modeHandler = require("./mode-handler.js");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

// TODO edit-modes: delete handlers once EditMode fully implemented
class ScaleHandler extends _modeHandler.ModeHandler {
  constructor() {
    super(...arguments);

    _defineProperty(this, "_isScalable", void 0);

    _defineProperty(this, "_geometryBeingScaled", void 0);
  }

  handlePointerMove(event) {
    var editAction = null;
    this._isScalable = Boolean(this._geometryBeingScaled) || this.isSelectionPicked(event.picks);

    if (!this._isScalable || !event.pointerDownGroundCoords) {
      // Nothing to do
      return {
        editAction: null,
        cancelMapPan: false
      };
    }

    if (event.isDragging && this._geometryBeingScaled) {
      // Scale the geometry
      editAction = this.getScaleAction(event.pointerDownGroundCoords, event.groundCoords, 'scaling');
    }

    return {
      editAction: editAction,
      cancelMapPan: true
    };
  }

  handleStartDragging(event) {
    if (!this._isScalable) {
      return null;
    }

    this._geometryBeingScaled = this.getSelectedFeaturesAsFeatureCollection();
    return null;
  }

  handleStopDragging(event) {
    var editAction = null;

    if (this._geometryBeingScaled) {
      // Scale the geometry
      editAction = this.getScaleAction(event.pointerDownGroundCoords, event.groundCoords, 'scaled');
      this._geometryBeingScaled = null;
    }

    return editAction;
  }

  getCursor(_ref) {
    var isDragging = _ref.isDragging;

    if (this._isScalable) {
      // TODO: look at doing SVG cursors to get a better "scale" cursor
      return 'move';
    }

    return isDragging ? 'grabbing' : 'grab';
  }

  getScaleAction(startDragPoint, currentPoint, editType) {
    var startPosition = startDragPoint;
    var centroid = (0, _centroid.default)(this._geometryBeingScaled);
    var factor = getScaleFactor(centroid, startPosition, currentPoint);
    var scaledFeatures = (0, _transformScale.default)(this._geometryBeingScaled, factor, {
      origin: centroid
    });
    var updatedData = this.getImmutableFeatureCollection();
    var selectedIndexes = this.getSelectedFeatureIndexes();

    for (var i = 0; i < selectedIndexes.length; i++) {
      var selectedIndex = selectedIndexes[i];
      var movedFeature = scaledFeatures.features[i];
      updatedData = updatedData.replaceGeometry(selectedIndex, movedFeature.geometry);
    }

    return {
      updatedData: updatedData.getObject(),
      editType: editType,
      featureIndexes: selectedIndexes,
      editContext: null
    };
  }

}

exports.ScaleHandler = ScaleHandler;

function getScaleFactor(centroid, startDragPoint, currentPoint) {
  var startDistance = (0, _distance.default)(centroid, startDragPoint);
  var endDistance = (0, _distance.default)(centroid, currentPoint);
  return endDistance / startDistance;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tb2RlLWhhbmRsZXJzL3NjYWxlLWhhbmRsZXIuanMiXSwibmFtZXMiOlsiU2NhbGVIYW5kbGVyIiwiTW9kZUhhbmRsZXIiLCJoYW5kbGVQb2ludGVyTW92ZSIsImV2ZW50IiwiZWRpdEFjdGlvbiIsIl9pc1NjYWxhYmxlIiwiQm9vbGVhbiIsIl9nZW9tZXRyeUJlaW5nU2NhbGVkIiwiaXNTZWxlY3Rpb25QaWNrZWQiLCJwaWNrcyIsInBvaW50ZXJEb3duR3JvdW5kQ29vcmRzIiwiY2FuY2VsTWFwUGFuIiwiaXNEcmFnZ2luZyIsImdldFNjYWxlQWN0aW9uIiwiZ3JvdW5kQ29vcmRzIiwiaGFuZGxlU3RhcnREcmFnZ2luZyIsImdldFNlbGVjdGVkRmVhdHVyZXNBc0ZlYXR1cmVDb2xsZWN0aW9uIiwiaGFuZGxlU3RvcERyYWdnaW5nIiwiZ2V0Q3Vyc29yIiwic3RhcnREcmFnUG9pbnQiLCJjdXJyZW50UG9pbnQiLCJlZGl0VHlwZSIsInN0YXJ0UG9zaXRpb24iLCJjZW50cm9pZCIsImZhY3RvciIsImdldFNjYWxlRmFjdG9yIiwic2NhbGVkRmVhdHVyZXMiLCJvcmlnaW4iLCJ1cGRhdGVkRGF0YSIsImdldEltbXV0YWJsZUZlYXR1cmVDb2xsZWN0aW9uIiwic2VsZWN0ZWRJbmRleGVzIiwiZ2V0U2VsZWN0ZWRGZWF0dXJlSW5kZXhlcyIsImkiLCJsZW5ndGgiLCJzZWxlY3RlZEluZGV4IiwibW92ZWRGZWF0dXJlIiwiZmVhdHVyZXMiLCJyZXBsYWNlR2VvbWV0cnkiLCJnZW9tZXRyeSIsImdldE9iamVjdCIsImZlYXR1cmVJbmRleGVzIiwiZWRpdENvbnRleHQiLCJzdGFydERpc3RhbmNlIiwiZW5kRGlzdGFuY2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7QUFDQTs7QUFDQTs7QUFJQTs7Ozs7O0FBRUE7QUFDTyxNQUFNQSxZQUFOLFNBQTJCQyx3QkFBM0IsQ0FBdUM7QUFBQTtBQUFBOztBQUFBOztBQUFBO0FBQUE7O0FBSTVDQyxF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QUFXLENBQUNXLFNBQVosRUFEUjtBQUVMbEIsTUFBQUEsUUFBUSxFQUFSQSxRQUZLO0FBR0xtQixNQUFBQSxjQUFjLEVBQUVWLGVBSFg7QUFJTFcsTUFBQUEsV0FBVyxFQUFFO0FBSlIsS0FBUDtBQU1EOztBQTlFMkM7Ozs7QUFpRjlDLFNBQVNoQixjQUFULENBQXdCRixRQUF4QixFQUE0Q0osY0FBNUMsRUFBc0VDLFlBQXRFLEVBQThGO0FBQzVGLE1BQU1zQixhQUFhLEdBQUcsdUJBQWFuQixRQUFiLEVBQXVCSixjQUF2QixDQUF0QjtBQUNBLE1BQU13QixXQUFXLEdBQUcsdUJBQWFwQixRQUFiLEVBQXVCSCxZQUF2QixDQUFwQjtBQUNBLFNBQU91QixXQUFXLEdBQUdELGFBQXJCO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBAZmxvd1xuXG5pbXBvcnQgdHVyZkNlbnRyb2lkIGZyb20gJ0B0dXJmL2NlbnRyb2lkJztcbmltcG9ydCB0dXJmRGlzdGFuY2UgZnJvbSAnQHR1cmYvZGlzdGFuY2UnO1xuaW1wb3J0IHR1cmZUcmFuc2Zvcm1TY2FsZSBmcm9tICdAdHVyZi90cmFuc2Zvcm0tc2NhbGUnO1xuaW1wb3J0IHR5cGUgeyBGZWF0dXJlQ29sbGVjdGlvbiwgUG9zaXRpb24gfSBmcm9tICdrZXBsZXItb3V0ZGF0ZWQtbmVidWxhLmdsLWVkaXQtbW9kZXMnO1xuaW1wb3J0IHR5cGUgeyBQb2ludGVyTW92ZUV2ZW50LCBTdGFydERyYWdnaW5nRXZlbnQsIFN0b3BEcmFnZ2luZ0V2ZW50IH0gZnJvbSAnLi4vZXZlbnQtdHlwZXMuanMnO1xuaW1wb3J0IHR5cGUgeyBFZGl0QWN0aW9uIH0gZnJvbSAnLi9tb2RlLWhhbmRsZXIuanMnO1xuaW1wb3J0IHsgTW9kZUhhbmRsZXIgfSBmcm9tICcuL21vZGUtaGFuZGxlci5qcyc7XG5cbi8vIFRPRE8gZWRpdC1tb2RlczogZGVsZXRlIGhhbmRsZXJzIG9uY2UgRWRpdE1vZGUgZnVsbHkgaW1wbGVtZW50ZWRcbmV4cG9ydCBjbGFzcyBTY2FsZUhhbmRsZXIgZXh0ZW5kcyBNb2RlSGFuZGxlciB7XG4gIF9pc1NjYWxhYmxlOiBib29sZWFuO1xuICBfZ2VvbWV0cnlCZWluZ1NjYWxlZDogP0ZlYXR1cmVDb2xsZWN0aW9uO1xuXG4gIGhhbmRsZVBvaW50ZXJNb3ZlKGV2ZW50OiBQb2ludGVyTW92ZUV2ZW50KTogeyBlZGl0QWN0aW9uOiA/RWRpdEFjdGlvbiwgY2FuY2VsTWFwUGFuOiBib29sZWFuIH0ge1xuICAgIGxldCBlZGl0QWN0aW9uOiA/RWRpdEFjdGlvbiA9IG51bGw7XG5cbiAgICB0aGlzLl9pc1NjYWxhYmxlID0gQm9vbGVhbih0aGlzLl9nZW9tZXRyeUJlaW5nU2NhbGVkKSB8fCB0aGlzLmlzU2VsZWN0aW9uUGlja2VkKGV2ZW50LnBpY2tzKTtcblxuICAgIGlmICghdGhpcy5faXNTY2FsYWJsZSB8fCAhZXZlbnQucG9pbnRlckRvd25Hcm91bmRDb29yZHMpIHtcbiAgICAgIC8vIE5vdGhpbmcgdG8gZG9cbiAgICAgIHJldHVybiB7IGVkaXRBY3Rpb246IG51bGwsIGNhbmNlbE1hcFBhbjogZmFsc2UgfTtcbiAgICB9XG5cbiAgICBpZiAoZXZlbnQuaXNEcmFnZ2luZyAmJiB0aGlzLl9nZW9tZXRyeUJlaW5nU2NhbGVkKSB7XG4gICAgICAvLyBTY2FsZSB0aGUgZ2VvbWV0cnlcbiAgICAgIGVkaXRBY3Rpb24gPSB0aGlzLmdldFNjYWxlQWN0aW9uKFxuICAgICAgICBldmVudC5wb2ludGVyRG93bkdyb3VuZENvb3JkcyxcbiAgICAgICAgZXZlbnQuZ3JvdW5kQ29vcmRzLFxuICAgICAgICAnc2NhbGluZydcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgZWRpdEFjdGlvbiwgY2FuY2VsTWFwUGFuOiB0cnVlIH07XG4gIH1cblxuICBoYW5kbGVTdGFydERyYWdnaW5nKGV2ZW50OiBTdGFydERyYWdnaW5nRXZlbnQpOiA/RWRpdEFjdGlvbiB7XG4gICAgaWYgKCF0aGlzLl9pc1NjYWxhYmxlKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICB0aGlzLl9nZW9tZXRyeUJlaW5nU2NhbGVkID0gdGhpcy5nZXRTZWxlY3RlZEZlYXR1cmVzQXNGZWF0dXJlQ29sbGVjdGlvbigpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgaGFuZGxlU3RvcERyYWdnaW5nKGV2ZW50OiBTdG9wRHJhZ2dpbmdFdmVudCk6ID9FZGl0QWN0aW9uIHtcbiAgICBsZXQgZWRpdEFjdGlvbjogP0VkaXRBY3Rpb24gPSBudWxsO1xuXG4gICAgaWYgKHRoaXMuX2dlb21ldHJ5QmVpbmdTY2FsZWQpIHtcbiAgICAgIC8vIFNjYWxlIHRoZSBnZW9tZXRyeVxuICAgICAgZWRpdEFjdGlvbiA9IHRoaXMuZ2V0U2NhbGVBY3Rpb24oZXZlbnQucG9pbnRlckRvd25Hcm91bmRDb29yZHMsIGV2ZW50Lmdyb3VuZENvb3JkcywgJ3NjYWxlZCcpO1xuICAgICAgdGhpcy5fZ2VvbWV0cnlCZWluZ1NjYWxlZCA9IG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIGVkaXRBY3Rpb247XG4gIH1cblxuICBnZXRDdXJzb3IoeyBpc0RyYWdnaW5nIH06IHsgaXNEcmFnZ2luZzogYm9vbGVhbiB9KTogc3RyaW5nIHtcbiAgICBpZiAodGhpcy5faXNTY2FsYWJsZSkge1xuICAgICAgLy8gVE9ETzogbG9vayBhdCBkb2luZyBTVkcgY3Vyc29ycyB0byBnZXQgYSBiZXR0ZXIgXCJzY2FsZVwiIGN1cnNvclxuICAgICAgcmV0dXJuICdtb3ZlJztcbiAgICB9XG4gICAgcmV0dXJuIGlzRHJhZ2dpbmcgPyAnZ3JhYmJpbmcnIDogJ2dyYWInO1xuICB9XG5cbiAgZ2V0U2NhbGVBY3Rpb24oc3RhcnREcmFnUG9pbnQ6IFBvc2l0aW9uLCBjdXJyZW50UG9pbnQ6IFBvc2l0aW9uLCBlZGl0VHlwZTogc3RyaW5nKTogRWRpdEFjdGlvbiB7XG4gICAgY29uc3Qgc3RhcnRQb3NpdGlvbiA9IHN0YXJ0RHJhZ1BvaW50O1xuICAgIGNvbnN0IGNlbnRyb2lkID0gdHVyZkNlbnRyb2lkKHRoaXMuX2dlb21ldHJ5QmVpbmdTY2FsZWQpO1xuICAgIGNvbnN0IGZhY3RvciA9IGdldFNjYWxlRmFjdG9yKGNlbnRyb2lkLCBzdGFydFBvc2l0aW9uLCBjdXJyZW50UG9pbnQpO1xuICAgIGNvbnN0IHNjYWxlZEZlYXR1cmVzID0gdHVyZlRyYW5zZm9ybVNjYWxlKHRoaXMuX2dlb21ldHJ5QmVpbmdTY2FsZWQsIGZhY3Rvciwge1xuICAgICAgb3JpZ2luOiBjZW50cm9pZFxuICAgIH0pO1xuXG4gICAgbGV0IHVwZGF0ZWREYXRhID0gdGhpcy5nZXRJbW11dGFibGVGZWF0dXJlQ29sbGVjdGlvbigpO1xuXG4gICAgY29uc3Qgc2VsZWN0ZWRJbmRleGVzID0gdGhpcy5nZXRTZWxlY3RlZEZlYXR1cmVJbmRleGVzKCk7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzZWxlY3RlZEluZGV4ZXMubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHNlbGVjdGVkSW5kZXggPSBzZWxlY3RlZEluZGV4ZXNbaV07XG4gICAgICBjb25zdCBtb3ZlZEZlYXR1cmUgPSBzY2FsZWRGZWF0dXJlcy5mZWF0dXJlc1tpXTtcbiAgICAgIHVwZGF0ZWREYXRhID0gdXBkYXRlZERhdGEucmVwbGFjZUdlb21ldHJ5KHNlbGVjdGVkSW5kZXgsIG1vdmVkRmVhdHVyZS5nZW9tZXRyeSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHVwZGF0ZWREYXRhOiB1cGRhdGVkRGF0YS5nZXRPYmplY3QoKSxcbiAgICAgIGVkaXRUeXBlLFxuICAgICAgZmVhdHVyZUluZGV4ZXM6IHNlbGVjdGVkSW5kZXhlcyxcbiAgICAgIGVkaXRDb250ZXh0OiBudWxsXG4gICAgfTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRTY2FsZUZhY3RvcihjZW50cm9pZDogUG9zaXRpb24sIHN0YXJ0RHJhZ1BvaW50OiBQb3NpdGlvbiwgY3VycmVudFBvaW50OiBQb3NpdGlvbikge1xuICBjb25zdCBzdGFydERpc3RhbmNlID0gdHVyZkRpc3RhbmNlKGNlbnRyb2lkLCBzdGFydERyYWdQb2ludCk7XG4gIGNvbnN0IGVuZERpc3RhbmNlID0gdHVyZkRpc3RhbmNlKGNlbnRyb2lkLCBjdXJyZW50UG9pbnQpO1xuICByZXR1cm4gZW5kRGlzdGFuY2UgLyBzdGFydERpc3RhbmNlO1xufVxuIl19